import{a as n,b as E,c as q,d as R,e as D,f as k,g as L,h as P,i as U}from"./chunk-QC7H4KPM.js";import{a as j}from"./chunk-BFT2MTJY.js";import{y as Q}from"./chunk-6PFJHDFS.js";import{F as V,H as G,L as W,V as T,Vc as v,Y as _,aa as I,c as x,ea as J,fa as M,g as B,m as z}from"./chunk-J2AK4FW5.js";import{a as u,b as g,g as N}from"./chunk-GAL4ENT6.js";var Y=()=>X(Date.now()/1e3)+" ".repeat(16).replace(/./g,()=>X(Math.random()*16));function X(e){return Math.floor(e).toString(16)}var ae=()=>`ORD-${Date.now()}`;var re={carts:[],selectedCart:null,quantity:1,isLoading:!1,pendingCarts:[],cartChangeType:null},Z=E({providedIn:"root"},k(re),q(({carts:e,selectedCart:i,pendingCarts:t})=>({cartCount:v(()=>e().length),activeCarts:v(()=>e().filter(r=>r.active)),pendingCartsCount:v(()=>t().length),selectedCartProducts:v(()=>i()?i().products:[]),isSelectedCart:v(()=>!!i())})),D(e=>({loadAll(){return N(this,null,function*(){n(e,{isLoading:!0})})},updateSelectedCartPaymentMethod(t){let r=e.selectedCart();if(!r){console.warn("No selected cart found.");return}n(e,{selectedCart:g(u({},r),{paymentMethod:u({},t)})})},updateCartSummary(t){let r=e.selectedCart();if(!r){console.warn("No selected cart found.");return}n(e,{selectedCart:g(u({},r),{cartSummary:u({},t)})})},createCart(){let t={_id:Y(),products:[],quantity:1,paymentMethod:null,active:!0,note:""};n(e,{carts:[...e.carts(),t],selectedCart:t})},addSelectedCartToPending(){let t=e.selectedCart();t&&n(e,r=>{let s=r.carts.filter(p=>p._id!==t._id),o=[...r.pendingCarts,t];return{carts:s,pendingCarts:o,selectedCart:null}})},deleteFromPendingCarts(t){let s=e.pendingCarts().filter(o=>o._id!==t);n(e,{pendingCarts:s})},restorePendingCart(t){n(e,r=>({carts:r.carts.some(o=>o._id===t._id)?r.carts:[...r.carts,t],selectedCart:t}))},removeSelectedCart(){n(e,{selectedCart:null})},updateCartAction(t){n(e,{cartChangeType:t})},selectCart(t){let r=e.carts().find(s=>(console.log("Comparing cart._id",s._id,"with cartId",t,s._id===t),s._id===t))||null;n(e,{selectedCart:r})},setCart(t){n(e,{selectedCart:t})},updateCarts(t){n(e,{carts:t})},addToCart(t,r,s=!1){let o=e.selectedCart();n(e,p=>{let m=p.carts.map(l=>l._id===t?o&&o._id===t?s?g(u({},o),{products:o.products.map(c=>c._id===r._id?u({},r):c)}):g(u({},o),{products:o.products.some(c=>c._id===r._id)?o.products.map(c=>c._id===r._id?g(u({},c),{quantity:c.quantity+1}):c):[...o.products,g(u({},r),{quantity:r.quantity||1})]}):l.products.find(c=>c._id===r._id)?s?g(u({},l),{products:l.products.map(c=>c._id===r._id?u({},r):c),cartSummary:l.cartSummary,discount:l.discount,user:l.user,note:l.note,delivery:l.delivery,paymentMethod:l.paymentMethod}):g(u({},l),{products:l.products.map(c=>c._id===r._id?g(u({},c),{quantity:c.quantity+1}):c),cartSummary:l.cartSummary,discount:l.discount,user:l.user,note:l.note,delivery:l.delivery,paymentMethod:l.paymentMethod}):g(u({},l),{products:[...l.products,g(u({},r),{quantity:r.quantity||1})],cartSummary:l.cartSummary,discount:l.discount,user:l.user,note:l.note,delivery:l.delivery,paymentMethod:l.paymentMethod}):l),O=m.find(l=>l._id===t)||null;return console.log("Updated selected cart:",O),{carts:m,selectedCart:O}})},removeFromCart(t,r){n(e,s=>{let o=s.carts.map(m=>m._id===t?g(u({},m),{products:m.products.filter(O=>O._id!==r)}):m),p=s.selectedCart&&s.selectedCart._id===t?o.find(m=>m._id===t)||null:s.selectedCart;return{carts:o,selectedCart:p}})},clearCart(t){n(e,r=>{let s=r.carts.map(p=>p._id===t?g(u({},p),{products:[]}):p),o=r.selectedCart&&r.selectedCart._id===t?s.find(p=>p._id===t)||null:r.selectedCart;return{carts:s,selectedCart:o}})},updateCartDiscount(t,r){let s=e.selectedCart();if(!s||s._id!==t)return;let o=g(u({},s),{discount:r,cartSummary:g(u({},s.cartSummary),{discount:r.value})});n(e,{selectedCart:o})},updateCartUser(t,r){let s=e.selectedCart();if(!s||s._id!==t)return;let o=g(u({},s),{user:r});n(e,{selectedCart:o})},updateCartDelivery(t,r){let s=e.selectedCart();if(!s||s._id!==t)return;let o=g(u({},s),{delivery:r,cartSummary:g(u({},s.cartSummary),{deliveryFee:r})});n(e,{selectedCart:o})},updateCartNote(t,r){let s=e.selectedCart();if(!s||s._id!==t)return;let o=g(u({},s),{note:r});n(e,{selectedCart:o})},incrementProductQuantity(t){let r=e.selectedCart();if(r){let s=r.products.map(o=>o._id===t?g(u({},o),{quantity:o.quantity+1}):o);n(e,{selectedCart:g(u({},r),{products:s})})}},decrementProductQuantity(t){let r=e.selectedCart();if(r){let s=r.products.find(o=>o._id===t);if(s&&s.quantity>1){this.updateCartAction("edit");let o=r.products.map(p=>p._id===t?g(u({},p),{quantity:p.quantity-1}):p);n(e,{selectedCart:g(u({},r),{products:o})})}else s&&(this.updateCartAction("delete"),this.removeFromCart(r._id,s._id))}}})),R({onInit(e){e.carts().length===0&&!e.selectedCart()&&e.createCart()}}));var ee=class e{_httpClient=M(Q);cartStore=M(Z);hostServer=j.apiUrl;getStoreCartsRestructured(i){return this._httpClient.get(`${this.hostServer}/carts/store/${i}/restructured`)}getCartByIdRestructured(i){return this._httpClient.get(`${this.hostServer}/carts/${i}/restructured`)}generateCartSummary(i,t){if(i){let r=t?.tax||0,s=0,o=0,p=0;i.products.forEach(c=>{if(s+=c.price*c.quantity,c?.options){let $=c.options.reduce((y,b)=>{let a=b.options.reduce((d,f)=>f.selected?d+f.price*f.quantity:d,0);return y+a},0);o+=$*c.quantity}});let m=s+o,O=0;i.discount&&(i.discount.discountType==="Percentage"?O=m*i.discount.value/100:i.discount.discountType==="Amount"&&(O=i.discount.value)),O=Math.min(O,m);let l=(m-O)*r;i.delivery&&(p=+i.delivery);let w=m-O+l+p;return{totalBaseCost:s,totalVariantCost:o,subtotal:m,discount:O,tax:l,deliveryFee:p,totalCost:w}}else return{totalBaseCost:0,totalVariantCost:0,subtotal:0,discount:0,tax:0,totalCost:0,deliveryFee:0}}getTotalForSelectedOptions(i){return i&&i.length>0?i.reduce((t,r)=>{let s=r?.options?.length?r.options.reduce((o,p)=>p.selected?o+p.price*p.quantity:o,0):0;return t+s},0):0}loadCart(i){if(this.cartStore.carts().length>0){this.cartStore.selectCart(i);let r=this.cartStore.selectedCart();if(r)return console.log("Using cart from store:",r),z(r)}return this.getCartByIdRestructured(i).pipe(_(r=>{let s=[...this.cartStore.carts(),r];this.cartStore.updateCarts(s),this.cartStore.setCart(r)}),V(r=>{throw console.error("Error fetching cart:",r),r}))}static \u0275fac=function(t){return new(t||e)};static \u0275prov=I({token:e,factory:e.\u0275fac,providedIn:"root"})};var se={salesTypes:[{id:"table",name:"Table Sales",description:"For sales made at assigned tables within the premises.",icon:"table_icon.svg",features:{requiresTableAssignment:!0,allowsMultipleOrders:!0,supportsOnlinePayment:!0,supportsOfflinePayment:!0,requiresDeliveryAddress:!1},defaultSettings:{paymentMethod:"Cash",orderPrefix:"TBL"}},{id:"quick",name:"Quick Sales",description:"Fast checkout for walk-in customers without table assignment.",icon:"quick_icon.svg",features:{requiresTableAssignment:!1,allowsMultipleOrders:!1,supportsOnlinePayment:!0,supportsOfflinePayment:!0,requiresDeliveryAddress:!1},defaultSettings:{paymentMethod:"Card",orderPrefix:"QUK"}},{id:"online",name:"Online Sales",description:"Sales made through the online ordering system for delivery or pickup.",icon:"online_icon.svg",features:{requiresTableAssignment:!1,allowsMultipleOrders:!0,supportsOnlinePayment:!0,supportsOfflinePayment:!1,requiresDeliveryAddress:!0},defaultSettings:{paymentMethod:"Online",orderPrefix:"ONL"}}],isEditing:!1,selectedSale:null},Xe=E({providedIn:"root"},k(se),q(({salesTypes:e})=>({menuCount:v(()=>e().length)})),D(e=>({setSelectedSaleType(i,t=!1){let r=e.salesTypes().find(s=>s.id===i||s.name===i);r?n(e,{selectedSale:r,isEditing:t}):(console.warn(`Sales type with ID or name "${i}" not found.`),n(e,{selectedSale:null,isEditing:!1}))},setDefaultSaleType(){let i=e.salesTypes().find(t=>t.id==="quick");i?n(e,{selectedSale:i,isEditing:!1}):console.warn("Default sale type 'Quick Sales' not found.")},startEditing(){console.log(e.selectedSale(),"Entering editing mode"),e.selectedSale()?n(e,{isEditing:!0}):console.warn("No sales type selected to edit.")},stopEditing(){console.log("Exiting editing mode"),n(e,{isEditing:!1})},clearSelection(){n(e,{selectedSale:null,isEditing:!1})}})));var H=class e{constructor(i){this._httpClient=i}orders;hostServer=j.apiUrl;orders$=new B(null);selectedOrders=this.orders$.asObservable();getOrders(i){let r=JSON.stringify(i);return this._httpClient.get(`${this.hostServer}/orders?query=${r}`)}getUserOrders(i){return this._httpClient.get(`${this.hostServer}/orders/user/${i}`)}getUserStoreOrders(i,t){return this._httpClient.get(`${this.hostServer}/orders/user/${i}/store/${t}`)}getOrder(i){return this._httpClient.get(`${this.hostServer}/orders/${i}`)}updateOrderStatus(i){return this._httpClient.put(`${this.hostServer}/orders/status/update`,i)}updateOrder(i,t){return this._httpClient.put(`${this.hostServer}/orders/${i}`,t)}updateOrderComprehensive(i,t){return this._httpClient.put(`${this.hostServer}/orders/${i}/comprehensive`,t)}deleteOrder(i){return this._httpClient.delete(`${this.hostServer}/orders/${i}`)}getStoreOrder(i,t,r){return this._httpClient.get(`${this.hostServer}/orders/store/${i}/merchants/orders?status=${t.status}&type=${r}&limit=${t.limit}&offset=${t.offset}`)}getStoreOrderCount(i){return this._httpClient.get(`${this.hostServer}/orders/store/${i}/merchants/orders/count`)}getStoreOrders(i,t={}){let r=new URLSearchParams;return t.limit&&r.append("limit",t.limit.toString()),t.skip&&r.append("skip",t.skip.toString()),t.status&&r.append("status",t.status),t.payment&&r.append("payment",t.payment),t.staff&&r.append("staff",t.staff),t.startDate&&r.append("startDate",t.startDate),t.endDate&&r.append("endDate",t.endDate),t.salesChannel&&r.append("salesChannel",t.salesChannel),this._httpClient.get(`${this.hostServer}/orders/store/${i}/orders?${r.toString()}`)}syncOrders(i){return this._httpClient.post(`${this.hostServer}/orders/sync`,{orders:i})}createOrder(i){return console.log(i,"order"),this._httpClient.post(`${this.hostServer}/orders`,i)}broadcast(i){this.orders$.next(i)}static \u0275fac=function(t){return new(t||e)(J(Q))};static \u0275prov=I({token:e,factory:e.\u0275fac,providedIn:"root"})};var oe={orders:[],isAccepting:!1,isLoading:!1,selectedOrder:null,searchQuery:"",searchFilters:null,onlineOrders:{new:[],processing:[],ready:[],complete:[],cancel:[]},selectedOnlineOrder:null,orderHistory:[],hasMore:!1,isLoadingMore:!1,error:null},ft=E({providedIn:"root"},k(oe),q(({orders:e,searchQuery:i,searchFilters:t,onlineOrders:r})=>({orderCount:v(()=>e().length),newOnlineOrders:v(()=>r().new),processingOnlineOrders:v(()=>r().processing),readyOnlineOrders:v(()=>r().ready),completeOnlineOrders:v(()=>r().complete),filteredOrders:v(()=>{let s=i()?.toLowerCase(),o=t();return e().filter(m=>{let O=s?m.reference?.toLowerCase().includes(s):!0,l=o?.status?m.category?.toLowerCase()===o.status?.toLowerCase():!0,w=o?.types?m.salesType?.name.toLowerCase()===o.types.toLowerCase():!0,c=o?.paymentType?m.payment?.toLowerCase()===o.paymentType.toLowerCase():!0,$=o?.startedAt?new Date(m.createdAt).toDateString()===new Date(o.startedAt).toDateString():!0;return O&&l&&w&&c&&$})})})),D(e=>{function i(y){n(e,{searchQuery:y})}function t(y){n(e,{searchFilters:y})}function r(){n(e,{searchFilters:null})}function s(){n(e,{searchQuery:""})}function o(y){return e.orders().find(b=>b._id===y)}function p(y){n(e,{selectedOrder:y})}function m(y){let a=e.orders().filter(d=>d._id!==y);n(e,{orders:a})}function O(){n(e,{selectedOrder:null})}function l(y){n(e,{orders:[...e.orders(),y]}),p(y)}function w(y,b){n(e,{orders:e.orders().map(a=>a._id===y?u(u({},a),b):a)})}function c(y){let b=e.selectedOrder();b&&n(e,{selectedOrder:u(u({},b),y)})}function $(y){let b=e.selectedOnlineOrder();b&&n(e,{selectedOnlineOrder:u(u({},b),y)})}return{updateSelectedOrder:c,updateOrder:w,addOrderToState:l,deleteSelectedOrder:O,deleteOrder:m,selectOrder:p,findOrderById:o,clearSearchQuery:s,clearSearchFilter:r,updateSearchFilter:t,updateSearchQuery:i,updateOnlineSelectedOrder:$}}),D((e,i=M(H),t=M(U))=>{function r(a){return a.toLowerCase()}function s(a,d){return N(this,null,function*(){let f=e.orders(),h=f.find(S=>S._id===a);if(!h)return console.error(`Order with ID ${a} not found.`),Promise.reject(new Error(`Order with ID ${a} not found.`));let C={category:"Complete"};!h.payment&&d&&(C.payment=d,C.paymentStatus="Paid");try{let S=yield i.updateOrderComprehensive(a,C).toPromise();return console.log(`Order ${a} marked as complete on the server.`),S?(n(e,{orders:f.map(A=>A._id===a?S:A)}),Promise.resolve(S)):Promise.reject(new Error("No order returned from server"))}catch(S){return console.error(`Failed to update order ${a} on the server:`,S),Promise.reject(S)}})}let o=P(x(T(a=>{n(e,{isLoadingMore:!0,isLoading:a?.reload??!1});let d=a.limit??25,f=a.offset??0,h=t.selectedStore();return h?._id?i.getStoreOrder(h._id,{status:a.orderType,limit:d,offset:f},"online").pipe(L({next:C=>{if(n(e,{isLoading:!1,hasMore:C.length>0,isLoadingMore:!1,error:null}),e.hasMore()){let S=r(a.orderType),A=e.onlineOrders()[S]||[];n(e,{onlineOrders:g(u({},e.onlineOrders()),{[S]:[...A,...C]})})}},error:C=>{console.error(C),n(e,{error:String(C)})},finalize:()=>n(e,{isLoading:!1,isLoadingMore:!1})})):(n(e,{isLoading:!1,isLoadingMore:!1}),[])})));function p(a){let d=r(a);return e.onlineOrders()[d]||[]}function m(a){let d=r(a);n(e,{onlineOrders:g(u({},e.onlineOrders()),{[d]:[]})})}let O=P(x(_(()=>n(e,{isLoading:!0})),T(a=>i.getOrder(a).pipe(L({next:d=>n(e,{isLoading:!1,selectedOnlineOrder:d}),error:d=>{console.error(d),n(e,{error:String(d)})},finalize:()=>n(e,{isLoading:!1})}))))),l=P(x(_(()=>n(e,{isAccepting:!0})),T(({order:a,statusNumber:d,currentStatus:f,targetStatus:h})=>{let C=a.user?._id||"";return i.updateOrderStatus({orderId:a._id,userId:C,statusNumber:d}).pipe(L({next:S=>{e.updateOnlineSelectedOrder({category:h});let A=r(f),K=r(h),F=u({},e.onlineOrders());F[A]=F[A].filter(te=>te._id!==a._id),F[K]=[...F[K],S],n(e,{isLoading:!1,isAccepting:!1,onlineOrders:F,selectedOrder:S})},error:S=>{console.error(S),n(e,{error:String(S)})},finalize:()=>n(e,{isLoading:!1,isAccepting:!1})}))}))),w=P(x(G(300),W(),_(()=>n(e,{isLoading:!0})),T(a=>{let d=a.limit??10,f=a.skip??0,h=t.selectedStore();return h?._id?i.getStoreOrders(h._id,{limit:d,skip:f}).pipe(L({next:C=>n(e,{orderHistory:C,isLoading:!1}),error:C=>{console.error(C),n(e,{error:String(C)})},finalize:()=>n(e,{isLoading:!1})})):(n(e,{isLoading:!1}),[])}))),c=P(x(_(()=>n(e,{isLoading:!0})),T(a=>i.getStoreOrders(a,{limit:100,skip:0}).pipe(L({next:d=>n(e,{orders:d,isLoading:!1}),error:d=>{console.error(d),n(e,{error:String(d)})},finalize:()=>n(e,{isLoading:!1})}))))),$=P(x(_(()=>n(e,{isLoading:!0})),T(a=>i.deleteOrder(a).pipe(L({next:()=>{n(e,{orders:e.orders().filter(d=>d._id!==a),isLoading:!1})},error:d=>{console.error(d),n(e,{error:String(d)})},finalize:()=>n(e,{isLoading:!1})}))))),y=P(x(_(()=>n(e,{isLoading:!0})),T(({orderId:a,updates:d})=>i.updateOrderComprehensive(a,d).pipe(L({next:f=>{n(e,{orders:e.orders().map(h=>h._id===a?f:h),isLoading:!1})},error:f=>{console.error("Failed to update order:",f),n(e,{error:String(f),isLoading:!1})},finalize:()=>n(e,{isLoading:!1})}))))),b=P(x(_(()=>n(e,{isLoading:!0})),T(a=>i.syncOrders([a]).pipe(L({next:d=>{let f=d[0];if(f){let h=e.orders().findIndex(C=>C._id===f._id);if(h>=0){let C=[...e.orders()];C[h]=f,n(e,{orders:C,selectedOrder:f,isLoading:!1})}else n(e,{orders:[...e.orders(),f],selectedOrder:f,isLoading:!1})}},error:d=>{console.error(d),n(e,{error:String(d),isLoading:!1})},finalize:()=>n(e,{isLoading:!1})})))));return{getOrders$:c,getOnlineOrders:o,_selectOrder:p,getOnlineOrder:O,getOrderHistory:w,clearOnlineOrders:m,updateOrderStatus$:l,deleteOrder$:$,updateOrder$:y,syncOrder$:b,getOnlineOrderKey:r,completeOrder:s}}),R({onInit(e){let t=M(U).selectedStore();t?._id&&e.getOrders$(t._id)}}));export{Y as a,ae as b,Z as c,ee as d,Xe as e,H as f,ft as g};
