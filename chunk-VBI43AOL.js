import{a as Et}from"./chunk-YCJLZT54.js";import{a as It}from"./chunk-LQU32KS7.js";import{a as bt,b as Ce}from"./chunk-ZAOMQAJO.js";import{a as Rt}from"./chunk-YZQZHEMG.js";import{a as Tt,b as Mt}from"./chunk-NYCP7ATN.js";import{d as xe,e as De,f as Ct,h as xt,i as Dt,j as St,k as Se}from"./chunk-XSZYAESL.js";import"./chunk-LCNY3JPX.js";import{a as pt,b as ut,c as gt,d as _t,e as yt,f as vt,g as ft,h as be}from"./chunk-MSN3EE44.js";import{a as ht}from"./chunk-HOFFRLAS.js";import{a as mt}from"./chunk-OFQMF3WN.js";import{g as ct}from"./chunk-GE7CTSB3.js";import{a as _e}from"./chunk-YHIOFNIN.js";import"./chunk-PYUUH7RE.js";import"./chunk-OKEXGVJ3.js";import"./chunk-O7SXWP4H.js";import{f as et}from"./chunk-F5YHHFYE.js";import{a as tt,b as at,c as it,d as nt}from"./chunk-4P4GBQE7.js";import{i as Je}from"./chunk-ZKQYDJ5W.js";import{a as ce,b as me}from"./chunk-LCF3SYDV.js";import{d as J,g as qe}from"./chunk-ZLVLWRZH.js";import{d as Ee}from"./chunk-HJGFVW6K.js";import"./chunk-TVH27JLT.js";import"./chunk-G4CZ6LK2.js";import"./chunk-I564X6SI.js";import"./chunk-VTDH2LYT.js";import{b as le,c as se,d as de}from"./chunk-63HT37SK.js";import{a as oe,b as rt,c as lt,e as st,h as re}from"./chunk-YJCGHVXK.js";import"./chunk-UHBDKNKX.js";import{a as dt,b as he}from"./chunk-3ZLH5HUN.js";import{B as ne,b as Z,d as M,g as Q,h as X,m as ee,n as ve,s as te,t as ae,v as fe,w as ot,z as ie}from"./chunk-O5GCTPYR.js";import"./chunk-EGLRIU4H.js";import{a as He,b as ze}from"./chunk-5TL46KBL.js";import"./chunk-53AK2UWQ.js";import{a as ye}from"./chunk-BFT2MTJY.js";import{a as Ze,c as Qe,h as Xe}from"./chunk-JONI64R4.js";import"./chunk-H7INH462.js";import"./chunk-OOL2KACG.js";import"./chunk-KZJMNFJ3.js";import{b as Ke,c as Ye}from"./chunk-G6I3OKXX.js";import{Z as We,_ as K,ba as Y}from"./chunk-4Z2XUZY2.js";import{h as je}from"./chunk-F436VINI.js";import{A as ge,h as Be,n as Le,o as Ge,q as Ue,u as z}from"./chunk-H22US2IH.js";import{F as we,Ib as u,Jb as g,Kb as Ie,Lb as Ae,Mb as F,Mc as B,Nb as w,Nc as Oe,Ob as h,Oc as G,Pb as r,Qb as n,Rb as C,Vb as ke,Wb as Ve,Wc as S,Yb as E,ac as b,bb as d,cc as c,fa as T,hd as $e,ka as x,la as D,m as ue,mc as H,qb as W,r as Pe,rc as l,sc as P,tc as O,uc as Ne,wa as y,wb as Me,x as Fe,za as L}from"./chunk-P5WOETP4.js";import{a as q,b as Te}from"./chunk-GAL4ENT6.js";function Bt(o,e){o&1&&(r(0,"mat-error"),l(1," Title is required "),n())}function Lt(o,e){o&1&&(r(0,"mat-error"),l(1," Title must not exceed 255 characters "),n())}function Gt(o,e){o&1&&(r(0,"mat-error"),l(1," Occupancy is required "),n())}function Ut(o,e){o&1&&(r(0,"mat-error"),l(1," Occupancy must be at least 1 "),n())}var Re=class o{fb=T(ie);http=T(ge);snackBar=T(He);baseUrl=ye.apiUrl;dialogRef=T(xe);data=T(De);isCreating=y(!1);errorMessage=y(null);ratePlanForm=this.fb.group({title:["",[M.required,M.maxLength(255)]],sellMode:["per_room"],rateMode:["manual"],currency:[this.data.currency||"NGN"],occupancy:[this.data.roomTypeOccupancy||2,[M.required,M.min(1)]],baseRate:[0,M.min(0)],minStayArrival:[1,M.min(0)],mealType:["room_only"],closedToArrival:[!1],closedToDeparture:[!1],stopSell:[!1]});createRatePlan(){if(!this.ratePlanForm.valid)return;this.isCreating.set(!0),this.errorMessage.set(null);let e=this.ratePlanForm.value,t={rate_plan:{title:e.title,property_id:this.data.propertyId,room_type_id:this.data.channexRoomTypeId||this.data.roomTypeId,parent_rate_plan_id:null,sell_mode:e.sellMode||"per_room",rate_mode:e.rateMode||"manual",currency:e.currency,inherit_rate:!1,inherit_closed_to_arrival:!1,inherit_closed_to_departure:!1,inherit_stop_sell:!1,inherit_min_stay_arrival:!1,inherit_max_stay:!1,inherit_max_sell:!1,inherit_max_availability:!1,inherit_availability_offset:!1,auto_rate_settings:null,options:[{occupancy:e.occupancy||1,is_primary:!0,children_fee:"0.00",infant_fee:"0.00"}]}};this.http.post(`${this.baseUrl}/admin/channex/stores/${this.data.storeId}/rate-plans`,t).subscribe({next:a=>{this.isCreating.set(!1),this.snackBar.open(`Rate plan "${e.title}" created successfully`,"Close",{duration:5e3,horizontalPosition:"end",verticalPosition:"bottom"}),this.dialogRef.close({success:!0,ratePlan:a.data||a,message:`Rate plan "${e.title}" created successfully`})},error:a=>{this.isCreating.set(!1);let i=a.error?.message||a.message||"Failed to create rate plan";this.errorMessage.set(i),this.snackBar.open(`Error: ${i}`,"Close",{duration:7e3,horizontalPosition:"end",verticalPosition:"bottom",panelClass:["error-snackbar"]}),console.error("Error creating rate plan:",a)}})}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=W({type:o,selectors:[["app-create-rate-plan-dialog"]],decls:91,vars:8,consts:[["mat-dialog-title",""],[1,"space-y-4"],[1,"space-y-4",3,"formGroup"],["appearance","outline",1,"w-full"],["matInput","","formControlName","title","placeholder","e.g., Standard Rate, Promotional Rate","required",""],[4,"ngIf"],["formControlName","sellMode"],["value","per_room"],["value","per_person"],["formControlName","rateMode"],["value","manual"],["value","derived"],["value","cascade"],["value","auto"],["formControlName","currency"],["value","NGN"],["value","USD"],["value","EUR"],["value","GBP"],["value","ZAR"],["value","KES"],["matInput","","type","number","formControlName","occupancy","min","1","required",""],["matInput","","type","number","formControlName","baseRate","min","0","step","0.01"],["matInput","","type","number","formControlName","minStayArrival","min","0"],["formControlName","mealType"],["value","room_only"],["value","breakfast"],["value","half_board"],["value","full_board"],["value","all_inclusive"],["formControlName","closedToArrival"],["formControlName","closedToDeparture"],["formControlName","stopSell"],["align","end",1,"pt-4"],["matButton","",3,"click","disabled"],["matButton","filled","color","primary",3,"click","disabled"]],template:function(t,a){if(t&1&&(r(0,"h2",0),l(1,"Create Rate Plan"),n(),r(2,"mat-dialog-content",1)(3,"form",2)(4,"mat-form-field",3)(5,"mat-label"),l(6,"Rate Plan Title"),n(),C(7,"input",4),Me(8,Bt,2,0,"mat-error",5)(9,Lt,2,0,"mat-error",5),n(),r(10,"mat-form-field",3)(11,"mat-label"),l(12,"Sell Mode"),n(),r(13,"mat-select",6)(14,"mat-option",7),l(15,"Per Room (same price for all guests)"),n(),r(16,"mat-option",8),l(17,"Per Person (price per guest)"),n()()(),r(18,"mat-form-field",3)(19,"mat-label"),l(20,"Rate Mode"),n(),r(21,"mat-select",9)(22,"mat-option",10),l(23,"Manual (set rates manually)"),n(),r(24,"mat-option",11),l(25,"Derived (from parent rate plan)"),n(),r(26,"mat-option",12),l(27,"Cascade (for each occupancy option)"),n(),r(28,"mat-option",13),l(29,"Auto (calculated automatically)"),n()()(),r(30,"mat-form-field",3)(31,"mat-label"),l(32,"Currency"),n(),r(33,"mat-select",14)(34,"mat-option",15),l(35,"NGN (\u20A6)"),n(),r(36,"mat-option",16),l(37,"USD ($)"),n(),r(38,"mat-option",17),l(39,"EUR (\u20AC)"),n(),r(40,"mat-option",18),l(41,"GBP (\xA3)"),n(),r(42,"mat-option",19),l(43,"ZAR (R)"),n(),r(44,"mat-option",20),l(45,"KES (Ks)"),n()()(),r(46,"mat-form-field",3)(47,"mat-label"),l(48,"Occupancy"),n(),C(49,"input",21),r(50,"mat-hint"),l(51,"Maximum number of guests for this rate plan"),n(),Me(52,Gt,2,0,"mat-error",5)(53,Ut,2,0,"mat-error",5),n(),r(54,"mat-form-field",3)(55,"mat-label"),l(56,"Base Rate"),n(),C(57,"input",22),r(58,"mat-hint"),l(59,"Default rate for this rate plan"),n()(),r(60,"mat-form-field",3)(61,"mat-label"),l(62,"Min Stay (Arrival)"),n(),C(63,"input",23),r(64,"mat-hint"),l(65,"Minimum stay nights for arrival"),n()(),r(66,"mat-form-field",3)(67,"mat-label"),l(68,"Meal Type"),n(),r(69,"mat-select",24)(70,"mat-option",25),l(71,"Room Only"),n(),r(72,"mat-option",26),l(73,"Breakfast"),n(),r(74,"mat-option",27),l(75,"Half Board"),n(),r(76,"mat-option",28),l(77,"Full Board"),n(),r(78,"mat-option",29),l(79,"All Inclusive"),n()()(),r(80,"mat-checkbox",30),l(81," Closed to Arrival (guests cannot check-in on this rate plan) "),n(),r(82,"mat-checkbox",31),l(83," Closed to Departure (guests cannot check-out on this rate plan) "),n(),r(84,"mat-checkbox",32),l(85," Stop Sell (rate plan is not available for booking) "),n()()(),r(86,"mat-dialog-actions",33)(87,"button",34),b("click",function(){return a.dialogRef.close()}),l(88," Cancel "),n(),r(89,"button",35),b("click",function(){return a.createRatePlan()}),l(90),n()()),t&2){let i,s,m,p;d(3),h("formGroup",a.ratePlanForm),d(5),h("ngIf",(i=a.ratePlanForm.get("title"))==null?null:i.hasError("required")),d(),h("ngIf",(s=a.ratePlanForm.get("title"))==null?null:s.hasError("maxlength")),d(43),h("ngIf",(m=a.ratePlanForm.get("occupancy"))==null?null:m.hasError("required")),d(),h("ngIf",(p=a.ratePlanForm.get("occupancy"))==null?null:p.hasError("min")),d(34),h("disabled",a.isCreating()),d(2),h("disabled",a.isCreating()||a.ratePlanForm.invalid),d(),O(" ",a.isCreating()?"Creating...":"Create Rate Plan"," ")}},dependencies:[z,Be,ne,ee,Z,ve,Q,X,ot,fe,ae,te,Se,xt,St,Dt,Y,K,le,re,oe,lt,rt,de,se,me,ce,J,Ce,bt,he,ze],encapsulation:2})};function qt(o,e){if(o&1&&(r(0,"div",4)(1,"label",5),l(2,"Rate Plan:"),n(),r(3,"div",6),l(4),n()()),o&2){let t=c();d(4),P(t.data.ratePlanName)}}function Wt(o,e){if(o&1){let t=E();r(0,"mat-form-field",7)(1,"mat-label"),l(2,"Restriction"),n(),r(3,"mat-select",16),b("selectionChange",function(){x(t);let i=c();return D(i.onRestrictionTypeChange())}),r(4,"mat-option",17),l(5,"Rate"),n(),r(6,"mat-option",18),l(7,"Min Stay"),n(),r(8,"mat-option",19),l(9,"Max Stay"),n(),r(10,"mat-option",20),l(11,"Closed to Arrival"),n(),r(12,"mat-option",21),l(13,"Closed to Departure"),n(),r(14,"mat-option",22),l(15,"Stop Sell"),n()()()}}function Ht(o,e){if(o&1&&(r(0,"mat-form-field",7)(1,"mat-label"),l(2),n(),C(3,"input",23),n()),o&2){let t=c();d(2),P(t.getValueLabel())}}function zt(o,e){if(o&1&&(r(0,"div",12)(1,"label",24),l(2),n(),C(3,"mat-slide-toggle",25),n()),o&2){let t=c();d(2),P(t.getToggleLabel())}}var pe=class o{fb=T(ie);dialogRef=T(xe);data=T(De);restrictionType=this.data.isAvailabilityOnly?"availability":this.data.restrictionType||"rate";form=this.fb.group({startDate:[this.data.startDate,M.required],endDate:[this.data.endDate||this.data.startDate,M.required],restrictionType:[this.restrictionType,M.required],value:[this.getInitialValue(),""],toggleValue:[this.getInitialToggleValue(),!1]});getInitialValue(){switch(this.restrictionType){case"rate":return this.data.ariRate??null;case"min-stay":return this.data.ariMinStay??null;case"max-stay":return this.data.ariMaxStay??null;case"availability":return this.data.ariAvailability??null;default:return null}}getInitialToggleValue(){switch(this.restrictionType){case"cta":return this.data.ariClosedToArrival??!1;case"ctd":return this.data.ariClosedToDeparture??!1;case"stop-sell":return this.data.ariStopSell??!1;default:return!1}}isNumericRestriction(){let e=this.form.get("restrictionType")?.value;return["rate","min-stay","max-stay","availability"].includes(e)}isToggleRestriction(){let e=this.form.get("restrictionType")?.value;return["cta","ctd","stop-sell"].includes(e)}getValueLabel(){switch(this.form.get("restrictionType")?.value){case"rate":return"Rate";case"min-stay":return"Minimum Stay (nights)";case"max-stay":return"Maximum Stay (nights)";case"availability":return"Availability";default:return"Value"}}getToggleLabel(){switch(this.form.get("restrictionType")?.value){case"cta":return"Closed to Arrival";case"ctd":return"Closed to Departure";case"stop-sell":return"Stop Sell";default:return""}}onRestrictionTypeChange(){let e=this.form.get("restrictionType")?.value;if(["rate","min-stay","max-stay","availability"].includes(e)){let i=this.getValueForRestrictionType(e);this.form.get("value")?.setValue(i)}else if(["cta","ctd","stop-sell"].includes(e)){let i=this.getToggleForRestrictionType(e);this.form.get("toggleValue")?.setValue(i)}let t=this.form.get("value"),a=this.form.get("toggleValue");["rate","min-stay","max-stay","availability"].includes(e)?(t?.setValidators([M.required,M.min(0)]),a?.clearValidators()):(t?.clearValidators(),a?.setValidators([])),t?.updateValueAndValidity(),a?.updateValueAndValidity()}getValueForRestrictionType(e){switch(e){case"rate":return this.data.ariRate??null;case"min-stay":return this.data.ariMinStay??null;case"max-stay":return this.data.ariMaxStay??null;case"availability":return this.data.ariAvailability??null;default:return null}}getToggleForRestrictionType(e){switch(e){case"cta":return this.data.ariClosedToArrival??!1;case"ctd":return this.data.ariClosedToDeparture??!1;case"stop-sell":return this.data.ariStopSell??!1;default:return!1}}save(){if(this.form.valid){let e=this.form.get("restrictionType")?.value,t=["cta","ctd","stop-sell"].includes(e);this.dialogRef.close({startDate:this.form.value.startDate,endDate:this.form.value.endDate,restrictionType:this.form.value.restrictionType,value:t?this.form.value.toggleValue:this.form.value.value})}}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=W({type:o,selectors:[["app-value-override-dialog"]],decls:30,vars:10,consts:[["picker",""],[1,"p-6","min-w-96"],[1,"text-xl","font-bold","mb-6"],[1,"space-y-6",3,"formGroup"],[1,"space-y-2"],[1,"block","text-sm","font-medium","text-gray-700"],[1,"text-base","font-semibold","text-gray-900"],["appearance","outline",1,"w-full"],[3,"formGroup","rangePicker"],["matStartDate","","formControlName","startDate","readonly",""],["matEndDate","","formControlName","endDate","readonly",""],["matIconSuffix","",3,"for"],[1,"flex","items-center","justify-between","p-4","bg-gray-50","rounded-lg"],[1,"flex","gap-3","justify-end","mt-8"],["matButton","",3,"click"],["matButton","filled","color","primary",3,"click","disabled"],["formControlName","restrictionType",3,"selectionChange"],["value","rate"],["value","min-stay"],["value","max-stay"],["value","cta"],["value","ctd"],["value","stop-sell"],["matInput","","type","number","formControlName","value","placeholder","Enter value","min","0"],[1,"text-sm","font-medium","text-gray-700"],["formControlName","toggleValue"]],template:function(t,a){if(t&1){let i=E();r(0,"div",1)(1,"h2",2),l(2,"Value Override"),n(),r(3,"form",3)(4,"div",4)(5,"label",5),l(6,"Room Type:"),n(),r(7,"div",6),l(8),n()(),u(9,qt,5,1,"div",4),r(10,"div",4)(11,"label",5),l(12,"Date Range:"),n(),r(13,"mat-form-field",7)(14,"mat-label"),l(15,"Select date range"),n(),r(16,"mat-date-range-input",8),C(17,"input",9)(18,"input",10),n(),C(19,"mat-datepicker-toggle",11)(20,"mat-date-range-picker",null,0),n()(),u(22,Wt,16,0,"mat-form-field",7),u(23,Ht,4,1,"mat-form-field",7),u(24,zt,4,1,"div",12),n(),r(25,"div",13)(26,"button",14),b("click",function(){return x(i),D(a.dialogRef.close())}),l(27," Cancel "),n(),r(28,"button",15),b("click",function(){return x(i),D(a.save())}),l(29," OK "),n()()()}if(t&2){let i=H(21);d(3),h("formGroup",a.form),d(5),P(a.data.roomTypeName),d(),g(a.data.ratePlanName?9:-1),d(7),h("formGroup",a.form)("rangePicker",i),d(3),h("for",i),d(3),g(a.data.isAvailabilityOnly?-1:22),d(),g(a.isNumericRestriction()?23:-1),d(),g(a.isToggleRestriction()?24:-1),d(4),h("disabled",a.form.invalid)}},dependencies:[z,ne,ee,Z,ve,Q,X,fe,ae,te,Se,le,re,oe,st,de,se,me,ce,J,Y,K,be,gt,_t,yt,vt,ft,_e,Mt,Tt],styles:["[_nghost-%COMP%]{display:block}"]})};var Jt=(o,e)=>e.value,Kt=(o,e)=>e.roomType.id,Yt=(o,e)=>e.id;function j(o,e){return this.getDateString(e)}function Zt(o,e){o&1&&(r(0,"button",9)(1,"mat-icon",8),l(2,"hourglass_empty"),n(),l(3," Saving... "),n())}function Qt(o,e){if(o&1){let t=E();r(0,"button",35),b("click",function(){x(t);let i=c();return D(i.saveChanges())}),r(1,"mat-icon",8),l(2,"save"),n(),l(3," Save "),n()}if(o&2){let t=c();h("disabled",!t.getHasUnsavedChanges())}}function Xt(o,e){if(o&1&&(r(0,"mat-card",15)(1,"mat-card-content",36)(2,"div",37)(3,"mat-icon",38),l(4,"warning"),n(),r(5,"div",39)(6,"h3",40),l(7,"Channex Setup Required"),n(),r(8,"p",41),l(9),n(),r(10,"button",42)(11,"mat-icon"),l(12,"settings"),n(),l(13," Go to Channel Management "),n()()()()()),o&2){let t=c();d(9),O(" ",t.getChannexSyncError()," ")}}function ea(o,e){if(o&1&&(r(0,"mat-option",24),l(1),n()),o&2){let t=e.$implicit;h("value",t.value),d(),O(" ",t.label," ")}}function ta(o,e){o&1&&(r(0,"div",26),C(1,"mat-spinner",43),r(2,"span",44),l(3,"Loading room types..."),n()())}function aa(o,e){if(o&1&&(r(0,"div",27)(1,"p",45),l(2,"Failed to load room types"),n(),r(3,"p",46),l(4),B(5,"json"),n()()),o&2){let t=c();d(4),P(Oe(5,1,t.getError()))}}function ia(o,e){o&1&&(r(0,"div",28),C(1,"mat-spinner",47),r(2,"span",48),l(3,"Loading rates and availability from Channex..."),n()())}function na(o,e){if(o&1&&(r(0,"div",29)(1,"p",49),l(2),n(),r(3,"p",50),l(4,"Displaying cached data. Please refresh or contact support if the issue persists."),n()()),o&2){let t=c();d(2),O("\u26A0 ",t.getARILoadError())}}function oa(o,e){if(o&1&&(r(0,"th",54)(1,"div",56),l(2),B(3,"date"),n(),r(4,"div",57),l(5),B(6,"date"),n()()),o&2){let t=e.$implicit;d(2),P(G(3,2,t,"EEE")),d(3),P(G(6,5,t,"d MMM"))}}function ra(o,e){if(o&1){let t=E();r(0,"td",66),b("click",function(){let i=x(t).$implicit,s=c().$implicit,m=c(2);return D(m.openAvailabilityOverride(s.roomType,i))}),r(1,"span",67),l(2),n()()}if(o&2){let t=e.$implicit,a=c().$implicit,i=c(2);d(2),O(" ",a.availability.get(i.getDateString(t))||"-"," ")}}function la(o,e){if(o&1&&(r(0,"span",76),B(1,"number"),l(2),B(3,"number"),n()),o&2){let t=c(2).$implicit,a=c(2).$implicit,i=c(4);h("matTooltip","Stop Sell enabled - Rate: "+G(1,2,i.getRateForRatePlan(a.id,t),"1.0-2")),d(2),O(" ",G(3,5,i.getRateForRatePlan(a.id,t),"1.0-2")," ")}}function sa(o,e){if(o&1&&(r(0,"span",77),l(1),B(2,"number"),n()),o&2){let t=c(2).$implicit,a=c(2).$implicit,i=c(4);d(),O(" ",G(2,1,i.getRateForRatePlan(a.id,t),"1.0-2")," ")}}function da(o,e){if(o&1&&u(0,la,4,8,"span",76)(1,sa,3,4,"span",77),o&2){let t=c().$implicit,a=c(2).$implicit,i=c(4);g(i.isStopSellForRatePlan(a.id,t)?0:1)}}function ca(o,e){o&1&&(r(0,"span",75),l(1,"No rate"),n())}function ma(o,e){if(o&1){let t=E();r(0,"td",74),b("click",function(){let i=x(t).$implicit,s=c(2).$implicit,m=c(2).$implicit,p=c(2);return D(p.openRatePlanValueOverride(s,m.roomType,i))}),u(1,da,2,1)(2,ca,2,0,"span",75),n()}if(o&2){let t=e.$implicit,a=c(2).$implicit,i=c(4);d(),g(i.getRateForRatePlan(a.id,t)?1:2)}}function pa(o,e){if(o&1&&(r(0,"tr",68)(1,"td",69)(2,"div",70),l(3),n(),r(4,"div",71),l(5,"Rate"),n()(),F(6,ma,3,1,"td",72,j,!0),C(8,"td",73),n()),o&2){let t=c().$implicit,a=c(4);d(3),P(t.name),d(3),w(a.getCalendarDates())}}function ua(o,e){if(o&1){let t=E();r(0,"td",82),b("click",function(){let i=x(t).$implicit,s=c(2).$implicit,m=c(2).$implicit,p=c(2);return D(p.openRatePlanValueOverride(s,m.roomType,i,"availability"))}),r(1,"span",83),l(2),n()()}if(o&2){let t,a=e.$implicit,i=c(2).$implicit,s=c(4);d(2),P(((t=s.getARIForRatePlan(i.id,a))==null?null:t.availability)||"-")}}function ga(o,e){if(o&1&&(r(0,"tr",52)(1,"td",78)(2,"div",79),l(3,"Availability"),n()(),F(4,ua,3,1,"td",80,j,!0),C(6,"td",81),n()),o&2){let t=c(5);d(4),w(t.getCalendarDates())}}function _a(o,e){o&1&&(r(0,"span",84),l(1,"\u2713"),n())}function ya(o,e){o&1&&(r(0,"span",85),l(1,"-"),n())}function va(o,e){if(o&1){let t=E();r(0,"td",82),b("click",function(){let i=x(t).$implicit,s=c(2).$implicit,m=c(2).$implicit,p=c(2);return D(p.openRatePlanValueOverride(s,m.roomType,i,"cta"))}),u(1,_a,2,0,"span",84)(2,ya,2,0,"span",85),n()}if(o&2){let t=e.$implicit,a=c(2).$implicit,i=c(4);d(),g(i.isClosedToArrivalForRatePlan(a.id,t)?1:2)}}function fa(o,e){if(o&1&&(r(0,"tr",52)(1,"td",78)(2,"div",79),l(3,"CTA"),n()(),F(4,va,3,1,"td",80,j,!0),C(6,"td",81),n()),o&2){let t=c(5);d(4),w(t.getCalendarDates())}}function ha(o,e){o&1&&(r(0,"span",84),l(1,"\u2713"),n())}function ba(o,e){o&1&&(r(0,"span",85),l(1,"-"),n())}function Ca(o,e){if(o&1){let t=E();r(0,"td",82),b("click",function(){let i=x(t).$implicit,s=c(2).$implicit,m=c(2).$implicit,p=c(2);return D(p.openRatePlanValueOverride(s,m.roomType,i,"ctd"))}),u(1,ha,2,0,"span",84)(2,ba,2,0,"span",85),n()}if(o&2){let t=e.$implicit,a=c(2).$implicit,i=c(4);d(),g(i.isClosedToDepartureForRatePlan(a.id,t)?1:2)}}function xa(o,e){if(o&1&&(r(0,"tr",52)(1,"td",78)(2,"div",79),l(3,"CTD"),n()(),F(4,Ca,3,1,"td",80,j,!0),C(6,"td",81),n()),o&2){let t=c(5);d(4),w(t.getCalendarDates())}}function Da(o,e){if(o&1){let t=E();r(0,"td",82),b("click",function(){let i=x(t).$implicit,s=c(2).$implicit,m=c(2).$implicit,p=c(2);return D(p.openRatePlanValueOverride(s,m.roomType,i,"min-stay"))}),r(1,"span",83),l(2),n()()}if(o&2){let t,a=e.$implicit,i=c(2).$implicit,s=c(4);d(2),P(((t=s.getARIForRatePlan(i.id,a))==null?null:t.minStay)||"-")}}function Sa(o,e){if(o&1&&(r(0,"tr",52)(1,"td",78)(2,"div",79),l(3,"Min Stay"),n()(),F(4,Da,3,1,"td",80,j,!0),C(6,"td",81),n()),o&2){let t=c(5);d(4),w(t.getCalendarDates())}}function Ra(o,e){if(o&1){let t=E();r(0,"td",82),b("click",function(){let i=x(t).$implicit,s=c(2).$implicit,m=c(2).$implicit,p=c(2);return D(p.openRatePlanValueOverride(s,m.roomType,i,"max-stay"))}),r(1,"span",83),l(2),n()()}if(o&2){let t,a=e.$implicit,i=c(2).$implicit,s=c(4);d(2),P(((t=s.getARIForRatePlan(i.id,a))==null?null:t.maxStay)||"-")}}function Ta(o,e){if(o&1&&(r(0,"tr",52)(1,"td",78)(2,"div",79),l(3,"Max Stay"),n()(),F(4,Ra,3,1,"td",80,j,!0),C(6,"td",81),n()),o&2){let t=c(5);d(4),w(t.getCalendarDates())}}function Ma(o,e){o&1&&(r(0,"span",86),l(1,"\u2713"),n())}function Ia(o,e){o&1&&(r(0,"span",85),l(1,"-"),n())}function Ea(o,e){if(o&1){let t=E();r(0,"td",82),b("click",function(){let i=x(t).$implicit,s=c(2).$implicit,m=c(2).$implicit,p=c(2);return D(p.openRatePlanValueOverride(s,m.roomType,i,"stop-sell"))}),u(1,Ma,2,0,"span",86)(2,Ia,2,0,"span",85),n()}if(o&2){let t=e.$implicit,a=c(2).$implicit,i=c(4);d(),g(i.isStopSellForRatePlan(a.id,t)?1:2)}}function Pa(o,e){if(o&1&&(r(0,"tr",52)(1,"td",78)(2,"div",79),l(3,"Stop Sell"),n()(),F(4,Ea,3,1,"td",80,j,!0),C(6,"td",81),n()),o&2){let t=c(5);d(4),w(t.getCalendarDates())}}function Fa(o,e){if(o&1&&(u(0,pa,9,1,"tr",68),u(1,ga,7,0,"tr",52),u(2,fa,7,0,"tr",52),u(3,xa,7,0,"tr",52),u(4,Sa,7,0,"tr",52),u(5,Ta,7,0,"tr",52),u(6,Pa,7,0,"tr",52)),o&2){let t=c(4);g(t.isRestrictionSelected("rate")?0:-1),d(),g(t.isRestrictionSelected("availability")?1:-1),d(),g(t.isRestrictionSelected("cta")?2:-1),d(),g(t.isRestrictionSelected("ctd")?3:-1),d(),g(t.isRestrictionSelected("min-stay")?4:-1),d(),g(t.isRestrictionSelected("max-stay")?5:-1),d(),g(t.isRestrictionSelected("stop-sell")?6:-1)}}function wa(o,e){if(o&1&&F(0,Fa,7,7,null,null,Yt),o&2){let t=c().$implicit;w(t.ratePlans)}}function Aa(o,e){if(o&1){let t=E();r(0,"tr",58)(1,"td",59)(2,"div",60),l(3),n(),r(4,"div",61),l(5),n()(),F(6,ra,3,1,"td",62,Ie),r(8,"td",63)(9,"button",64)(10,"mat-icon"),l(11,"more_vert"),n()(),r(12,"mat-menu",null,4)(14,"button",65),b("click",function(){let i=x(t).$implicit,s=c(2);return D(s.createRatePlan(i.roomType.id,i.roomType.name))}),r(15,"mat-icon"),l(16,"add_circle_outline"),n(),r(17,"span"),l(18,"Create Rate Plan"),n()()()()(),u(19,wa,2,0)}if(o&2){let t=e.$implicit,a=H(13),i=c(2);d(3),P(t.roomType.name),d(2),O(" Availability ",t.roomType.totalInventory>0?"(Total: "+t.roomType.totalInventory+")":""," "),d(),w(i.getCalendarDates()),d(3),h("matMenuTriggerFor",a),d(10),g(t.ratePlans.length>0?19:-1)}}function ka(o,e){if(o&1&&(r(0,"div",30)(1,"table",51)(2,"thead")(3,"tr",52)(4,"th",53),l(5," Room Type / Rate Plan "),n(),F(6,oa,7,8,"th",54,Ie),r(8,"th",55),l(9," Actions "),n()()(),r(10,"tbody"),F(11,Aa,20,4,null,null,Kt),n()()()),o&2){let t=c();d(6),w(t.getCalendarDates()),d(5),w(t.getRoomTypeGroups())}}function Va(o,e){o&1&&(r(0,"div",31)(1,"mat-icon",87),l(2,"calendar_today"),n(),r(3,"p",88),l(4,"Select a date range to view the calendar"),n()())}function Na(o,e){o&1&&(r(0,"div",32)(1,"mat-icon",89),l(2,"check_circle"),n(),r(3,"div")(4,"p",45),l(5,"Rates & restrictions synced successfully"),n(),r(6,"p",90),l(7,"Your changes have been pushed to Channex and will be distributed to OTA partners."),n()()())}function Oa(o,e){if(o&1&&(r(0,"li",95)(1,"span",92),l(2,"\u2022"),n(),r(3,"span"),l(4),n()()),o&2){let t=e.$implicit;d(4),P(t)}}function $a(o,e){if(o&1&&(r(0,"div",33)(1,"div",91)(2,"mat-icon",92),l(3,"warning"),n(),r(4,"div",39)(5,"p",93),l(6,"Sync completed with warnings"),n(),r(7,"ul",94),F(8,Oa,5,1,"li",95,Ae),n()()()()),o&2){let t=c();d(8),w(t.getSaveWarnings())}}function Ba(o,e){o&1&&(r(0,"div",34)(1,"mat-icon",96),l(2,"error"),n(),r(3,"div")(4,"p",45),l(5,"Failed to sync rates & restrictions"),n(),r(6,"p",90),l(7,"Please check your connection and try again."),n()()())}var Nt=class o{fb=T(ie);roomsService=T(It);storeStore=T(Je);http=T(ge);channexService=T(Et);dialog=T(Ct);cdr=T($e);baseUrl=ye.apiUrl;dateRangeForm=this.fb.group({startDate:[new Date,M.required],endDate:[this.getDateAfter(14),M.required]});restrictionForm=this.fb.group({minStayArrival:[{value:null}],minStayThrough:[{value:null}],maxStay:[{value:null}],closedToArrival:[!1],closedToDeparture:[!1],stopSell:[!1]});daySelectionForm=this.fb.group({monday:[!1],tuesday:[!1],wednesday:[!1],thursday:[!1],friday:[!1],saturday:[!1],sunday:[!1]});roomTypesResource=Ee({params:()=>({storeId:this.storeStore.selectedStore()?._id||""}),stream:({params:e})=>this.roomsService.getRoomTypes(e.storeId)});ratePlansResource=Ee({params:()=>({storeId:this.storeStore.selectedStore()?._id||""}),stream:({params:e})=>this.getPropertyRatePlans(e.storeId)});dateRange=y({startDate:new Date,endDate:this.getDateAfter(14)});calendarDates=y([]);selectedCurrency=y("NGN");rateData=y(new Map);availabilityData=y(new Map);restrictionData=y(new Map);isSaving=y(!1);saveStatus=y(null);saveWarnings=y([]);isLoadingARI=y(!1);ariLoadError=y(null);editMode=y(!1);showRestrictionsPanel=y(!1);selectedDays=y(new Set);isStoreChannexSynced=y(!1);channexSyncError=y(null);hasUnsavedChanges=y(!1);selectedRestrictions=y(["rate"]);availableRestrictions=[{value:"availability",label:"Availability"},{value:"rate",label:"Rate"},{value:"cta",label:"Closed To Arrival"},{value:"ctd",label:"Closed To Departure"},{value:"min-stay",label:"Min Stay"},{value:"max-stay",label:"Max Stay"},{value:"stop-sell",label:"Stop Sell"}];roomTypes=y([]);ratePlans=y([]);ariData=y({ratePlanARI:{},roomTypeAvailability:{}});roomTypeGroups=S(()=>{let e=this.roomTypes(),t=this.ratePlans(),a=this.ariData();return e.map(i=>({roomType:i,ratePlans:t.filter(s=>s.roomTypeId===i.id),availability:this.extractRoomTypeAvailability(i.id,a)}))});getIsLoading=S(()=>this.roomTypesResource.isLoading());getError=S(()=>this.roomTypesResource.error());getCalendarDates=S(()=>this.calendarDates());getSelectedCurrency=S(()=>this.selectedCurrency());getIsSaving=S(()=>this.isSaving());getSaveStatus=S(()=>this.saveStatus());getSaveWarnings=S(()=>this.saveWarnings());getEditMode=S(()=>this.editMode());getShowRestrictionsPanel=S(()=>this.showRestrictionsPanel());getSelectedDays=S(()=>this.selectedDays());getRoomTypeGroups=this.roomTypeGroups;getIsStoreChannexSynced=S(()=>this.isStoreChannexSynced());getChannexSyncError=S(()=>this.channexSyncError());getHasUnsavedChanges=S(()=>this.hasUnsavedChanges());getIsLoadingARI=S(()=>this.isLoadingARI());getSelectedRestrictions=S(()=>this.selectedRestrictions());getAvailableRestrictions=()=>this.availableRestrictions;getARILoadError=S(()=>this.ariLoadError());getRoomTypes=S(()=>this.roomTypesResource.value()||[]);getRatePlans=S(()=>this.ratePlans());daysOfWeek={mo:"Monday",tu:"Tuesday",we:"Wednesday",th:"Thursday",fr:"Friday",sa:"Saturday",su:"Sunday"};constructor(){L(()=>{let e=this.storeStore.selectedStore();e?.channex?.propertyId?(this.isStoreChannexSynced.set(!0),this.channexSyncError.set(null)):e&&(this.isStoreChannexSynced.set(!1),this.channexSyncError.set("This store is not synced with Channex. Please complete the Channex setup in Channel Management first."))}),L(()=>{let e=this.dateRangeForm.get("startDate")?.value,t=this.dateRangeForm.get("endDate")?.value;e&&t&&this.isStoreChannexSynced()&&(this.dateRange.set({startDate:new Date(e),endDate:new Date(t)}),this.generateCalendarDates(new Date(e),new Date(t)),this.loadPricingDraft(e,t))}),L(()=>{let e=this.roomTypesResource.value();if(console.log("\u{1F3E0} Room Types Effect Triggered:",{roomTypes:e,hasRooms:!!e,roomCount:e?.length}),e&&e.length>0){let t=e.map(a=>({id:a._id||a.id||"",name:a.name,channexRoomTypeId:a.channexRoomTypeId,totalInventory:0}));console.log("\u2705 Mapped Room Types:",t),this.roomTypes.set(t)}}),L(()=>{let e=this.ratePlansResource.value();if(console.log("\u{1F4CB} Rate Plans Effect Triggered:",{plans:e,hasPlan:!!e,planCount:e?.length}),e&&e.length>0){let t=e.map(i=>({id:i.id,name:i.name,roomTypeId:i.roomTypeId||"",channexRatePlanId:i.channexRatePlanId})),a=this.roomTypes();console.log("\u{1F50D} Room Types:",a.map(i=>({id:i.id,name:i.name,channexId:i.channexRoomTypeId}))),console.log("\u{1F50D} Rate Plans:",t.map(i=>({id:i.id,name:i.name,roomTypeId:i.roomTypeId}))),console.log("\u{1F50D} Filtering:",t.map(i=>({ratePlan:i.name,lookingFor:i.roomTypeId,foundRoomTypes:a.filter(s=>s.id===i.roomTypeId).map(s=>s.name)}))),this.ratePlans.set(t),console.log("\u2705 Final Rate Plans Array Set:",this.ratePlans())}else console.warn("\u26A0\uFE0F No plans loaded from resource:",{plans:e})}),L(()=>{let{startDate:e,endDate:t}=this.dateRange(),a=this.storeStore.selectedStore()?._id,i=this.isStoreChannexSynced();a&&i&&e&&t&&this.loadARIData(a,this.getDateString(e),this.getDateString(t))}),L(()=>{this.getHasUnsavedChanges()&&this.editMode()&&this.autoSaveToLocalStorage()}),L(()=>{this.ariData(),this.cdr.markForCheck()})}getDateAfter(e){let t=new Date;return t.setDate(t.getDate()+e),t}generateCalendarDates(e,t){let a=[],i=new Date(e);for(;i<=t;)a.push(new Date(i)),i.setDate(i.getDate()+1);this.calendarDates.set(a)}getDateString(e){return e.toISOString().split("T")[0]}getRate(e,t){let a=this.getDateString(t);return this.rateData().get(e)?.get(a)||0}getAvailability(e,t){let a=this.getDateString(t);return this.availabilityData().get(e)?.get(a)||0}getRestriction(e,t,a){let i=this.getDateString(t);return this.restrictionData().get(e)?.get(i)?.[a]??null}updateRate(e,t,a){let i=this.getDateString(t),s=this.rateData();s.has(e)||s.set(e,new Map),s.get(e).set(i,a),this.rateData.set(s),this.hasUnsavedChanges.set(!0)}updateAvailability(e,t,a){let i=this.getDateString(t),s=this.availabilityData();s.has(e)||s.set(e,new Map),s.get(e).set(i,a),this.availabilityData.set(s),this.hasUnsavedChanges.set(!0)}updateRestriction(e,t,a,i){let s=this.getDateString(t),m=this.restrictionData();m.has(e)||m.set(e,new Map);let p=m.get(e);p.has(s)||p.set(s,{}),p.get(s)[a]=i,this.restrictionData.set(m),this.hasUnsavedChanges.set(!0)}toggleEditMode(){this.editMode.set(!this.editMode()),this.editMode()||this.hasUnsavedChanges.set(!1)}onRestrictionsChange(e){this.selectedRestrictions.set(e)}isRestrictionSelected(e){return this.selectedRestrictions().includes(e)}getCurrencySymbol(e){return{NGN:"\u20A6",USD:"$",EUR:"\u20AC",GBP:"\xA3"}[e]||e}toggleDay(e){let t=new Set(this.selectedDays());t.has(e)?t.delete(e):t.add(e),this.selectedDays.set(t)}isDaySelected(e){return this.selectedDays().has(e)}toggleRestrictionsPanel(){this.showRestrictionsPanel.set(!this.showRestrictionsPanel())}applyRestrictionsToDateRange(){let e=this.restrictionForm.value;this.selectedDays().size===0&&!e.closedToArrival&&!e.closedToDeparture&&!e.stopSell||(console.warn("Bulk restriction application not yet implemented. Apply restrictions via individual rate plan cells."),this.hasUnsavedChanges.set(!0))}generateDateRangeArray(e,t){let a=[],i=new Date(e);for(;i<=t;)a.push(new Date(i)),i.setDate(i.getDate()+1);return a}getDayOfWeek(e){let t=e.getDay();return["su","mo","tu","we","th","fr","sa"][t]}saveChanges(){this.isSaving.set(!0),this.saveStatus.set(null),this.saveWarnings.set([]);let{startDate:e,endDate:t}=this.dateRange(),a=this.storeStore.selectedStore(),i=a?._id||"",s=a?.channex?.propertyId||"";if(!s){console.error("Store is not synced with Channex - missing property_id"),this.isSaving.set(!1),this.saveStatus.set("error"),setTimeout(()=>this.saveStatus.set(null),3e3);return}let m=this.ariData(),p=this.ratePlans(),A=this.roomTypes(),V=[];p.forEach(v=>{this.getCalendarDates().forEach(f=>{let k=this.getDateString(f),_=m.ratePlanARI[v.id]?.[k];if(_){if(!v.channexRatePlanId){console.warn(`Rate plan ${v.name} (${v.id}) is missing Channex ID`);return}let I={propertyId:s,ratePlanId:v.channexRatePlanId,date:k};_.rate!==void 0&&_.rate!==null&&_.rate>0&&(I.rate=String(_.rate)),_.availability!==void 0&&_.availability!==null&&(I.availability=_.availability),_.minStay!==void 0&&_.minStay!==null&&(I.minStayArrival=_.minStay),_.maxStay!==void 0&&_.maxStay!==null&&(I.maxStay=_.maxStay),_.closedToArrival!==void 0&&_.closedToArrival!==null&&(I.closedToArrival=_.closedToArrival),_.closedToDeparture!==void 0&&_.closedToDeparture!==null&&(I.closedToDeparture=_.closedToDeparture),_.stopSell!==void 0&&_.stopSell!==null&&(I.stopSell=_.stopSell),V.push(I)}})});let N=[];A.forEach(v=>{let f=v.channexRoomTypeId||"";if(!f)return;let k=m.roomTypeAvailability[f]||{};this.getCalendarDates().forEach(_=>{let I=this.getDateString(_),U=k[I];if(U!=null){let Ot={propertyId:s,roomTypeId:f,date:I,availability:U};N.push(Ot)}})}),console.log("Restrictions to save:",V),console.log("Availability to save:",N);let $=V.length>0?this.http.post(`${this.baseUrl}/admin/channex/stores/${i}/restrictions`,{values:V}):ue({success:!0,warnings:[]}),R=N.length>0?this.http.post(`${this.baseUrl}/admin/channex/stores/${i}/availability`,{values:N}):ue({success:!0,warnings:[]});Fe([$,R]).subscribe({next:v=>{let f=v[0],k=v[1],_=[];f.warnings&&f.warnings.length>0&&f.warnings.forEach(I=>{let U=this.formatWarningMessage(I,"Restriction");_.push(U)}),k.warnings&&k.warnings.length>0&&k.warnings.forEach(I=>{let U=this.formatWarningMessage(I,"Availability");_.push(U)}),this.handleSaveSuccess(i,e,t,_)},error:v=>{console.error("Failed to save changes to Channex:",v),this.isSaving.set(!1),this.saveStatus.set("error"),setTimeout(()=>this.saveStatus.set(null),3e3)}})}formatWarningMessage(e,t){if(e.warning&&typeof e.warning=="object"){let a=Object.entries(e.warning).map(([i,s])=>{let m=Array.isArray(s)?s.join(", "):s;return`${i}: ${m}`}).join("; ");return`${t} (${e.date}): ${a}`}return`${t}: ${JSON.stringify(e)}`}pushRestrictionsToChannex(e,t,a,i){console.warn("Bulk restriction push not yet implemented. Update rate plans individually."),this.handleSaveSuccess(e,a,i)}handleSaveSuccess(e,t,a,i=[]){if(this.isSaving.set(!1),this.saveStatus.set("success"),this.editMode.set(!1),this.hasUnsavedChanges.set(!1),i&&i.length>0){let m=[...new Set(i)];this.saveWarnings.set(m),console.warn("Channex warnings:",m)}this.loadARIData(e,this.getDateString(t),this.getDateString(a));let s=i&&i.length>0?5e3:3e3;setTimeout(()=>this.saveStatus.set(null),s)}resetChanges(){this.rateData.set(new Map),this.availabilityData.set(new Map),this.restrictionData.set(new Map),this.editMode.set(!1),this.hasUnsavedChanges.set(!1);let{startDate:e,endDate:t}=this.dateRange(),a=this.storeStore.selectedStore()?._id;a&&this.loadARIData(a,this.getDateString(e),this.getDateString(t))}navigateToPreviousPeriod(){let{startDate:e,endDate:t}=this.dateRange(),a=Math.ceil((t.getTime()-e.getTime())/(1e3*60*60*24)),i=new Date(e);i.setDate(i.getDate()-a);let s=new Date(t);s.setDate(s.getDate()-a),this.dateRangeForm.patchValue({startDate:i,endDate:s})}navigateToNextPeriod(){let{startDate:e,endDate:t}=this.dateRange(),a=Math.ceil((t.getTime()-e.getTime())/(1e3*60*60*24)),i=new Date(e);i.setDate(i.getDate()+a);let s=new Date(t);s.setDate(s.getDate()+a),this.dateRangeForm.patchValue({startDate:i,endDate:s})}selectDateRange(e){let t=new Date,a=this.getDateAfter(e-1);this.dateRangeForm.patchValue({startDate:t,endDate:a})}openDatePicker(){let e=document.querySelector('input[formControlName="startDate"]');e&&e.click()}updateCurrency(e){this.selectedCurrency.set(e)}loadARIData(e,t,a){this.isLoadingARI.set(!0),this.ariLoadError.set(null);let i=`${this.baseUrl}/admin/channex/stores/${e}/ari?startDate=${t}&endDate=${a}`;this.http.get(i).subscribe({next:s=>{s.data&&this.ariData.set({ratePlanARI:s.data.ratePlanARI||{},roomTypeAvailability:s.data.roomTypeAvailability||{}}),this.isLoadingARI.set(!1)},error:s=>{console.error("Failed to load ARI data from Channex:",s),this.ariLoadError.set("Failed to load rates and availability from Channex"),this.isLoadingARI.set(!1)}})}autoSaveToLocalStorage(){let e={startDate:this.getDateString(this.dateRange().startDate),endDate:this.getDateString(this.dateRange().endDate),rates:this.rateData(),availability:this.availabilityData(),restrictions:this.restrictionData(),selectedDays:this.selectedDays()},a=`pricing_draft_${this.storeStore.selectedStore()?._id||""}_${e.startDate}_${e.endDate}`;try{localStorage.setItem(a,JSON.stringify(Te(q({},e),{rates:Object.fromEntries(Array.from(e.rates.entries()).map(([i,s])=>[i,Object.fromEntries(s)])),availability:Object.fromEntries(Array.from(e.availability.entries()).map(([i,s])=>[i,Object.fromEntries(s)])),restrictions:Object.fromEntries(Array.from(e.restrictions.entries()).map(([i,s])=>[i,Object.fromEntries(s)])),selectedDays:Array.from(e.selectedDays)})))}catch(i){console.warn("Failed to save draft to localStorage:",i)}}loadPricingDraft(e,t){let i=`pricing_draft_${this.storeStore.selectedStore()?._id||""}_${this.getDateString(e)}_${this.getDateString(t)}`;try{let s=localStorage.getItem(i);if(s){let m=JSON.parse(s);this.rateData.set(new Map(Object.entries(m.rates).map(([p,A])=>[p,new Map(Object.entries(A))]))),this.availabilityData.set(new Map(Object.entries(m.availability).map(([p,A])=>[p,new Map(Object.entries(A))]))),this.restrictionData.set(new Map(Object.entries(m.restrictions).map(([p,A])=>[p,new Map(Object.entries(A))]))),this.selectedDays.set(new Set(m.selectedDays))}}catch(s){console.warn("Failed to load draft from localStorage:",s)}}savePricingDraft(e,t,a){let i={startDate:t,endDate:a,rates:Array.from(this.rateData().entries()).map(([s,m])=>({roomTypeId:s,rates:Object.fromEntries(m)})),availability:Array.from(this.availabilityData().entries()).map(([s,m])=>({roomTypeId:s,availability:Object.fromEntries(m)})),restrictions:Array.from(this.restrictionData().entries()).map(([s,m])=>({roomTypeId:s,restrictions:Object.fromEntries(m)}))};this.http.post(`${this.baseUrl}/admin/channex/stores/${e}/pricing-draft`,i).subscribe({next:()=>console.log("Draft saved to server"),error:s=>console.warn("Failed to save draft to server:",s)})}getPropertyRatePlans(e){return this.http.get(`${this.baseUrl}/admin/channex/stores/${e}/rate-plans`).pipe(Pe(t=>t.data||[]),we(()=>ue([])))}createRatePlan(e,t){let a=this.storeStore.selectedStore();if(!a?.channex?.propertyId){console.error("Store not synced with Channex");return}let i=this.getRoomTypes().find(m=>(m._id||m.id)===e);i?.channexRoomTypeId||console.warn("Room type has not been synced with Channex yet"),this.dialog.open(Re,{width:"600px",disableClose:!1,data:{storeId:a._id,roomTypeId:e,roomTypeName:t,propertyId:a.channex.propertyId,channexRoomTypeId:i?.channexRoomTypeId,roomTypeOccupancy:i?.capacity?.adults||2,currency:a.currencyCode||"NGN"}}).afterClosed().subscribe(m=>{m?.success&&(console.log("Rate plan created:",m.message),this.ratePlansResource.reload())})}openAvailabilityOverride(e,t){let a=this.getDateString(t),i=e.channexRoomTypeId||"",s=this.ariData().roomTypeAvailability[i]?.[a]??null;this.dialog.open(pe,{width:"500px",disableClose:!1,data:{roomTypeName:e.name,startDate:t,endDate:t,currentValue:s,restrictionType:"availability",isAvailabilityOnly:!0,ariAvailability:s}}).afterClosed().subscribe(p=>{if(p){let A=new Date(p.startDate),V=new Date(p.endDate),N=e.channexRoomTypeId||"",$=this.generateDateRangeArray(A,V),R=this.ariData(),v=q({},R.roomTypeAvailability);v[N]||(v[N]={}),$.forEach(f=>{let k=this.getDateString(f);v[N][k]=p.value}),this.ariData.set(Te(q({},R),{roomTypeAvailability:v})),this.hasUnsavedChanges.set(!0),console.log("Availability updated:",p)}})}getAvailabilityForRoomType(e,t){let a=this.getDateString(t);return this.roomTypes().find(i=>i.id===e)?this.ariData().roomTypeAvailability[this.roomTypes().find(i=>i.id===e)?.channexRoomTypeId||""]?.[a]??null:null}openRatePlanValueOverride(e,t,a,i){let s=this.getARIForRatePlan(e.id,a);this.dialog.open(pe,{width:"500px",disableClose:!1,data:{roomTypeName:t.name,ratePlanName:e.name,startDate:a,endDate:a,currentValue:s?.rate??null,currentToggleValue:s?.stopSell??!1,restrictionType:i||"rate",isAvailabilityOnly:!1,ariRate:s?.rate??null,ariAvailability:s?.availability??null,ariMinStay:s?.minStay??null,ariMaxStay:s?.maxStay??null,ariClosedToArrival:s?.closedToArrival??!1,ariClosedToDeparture:s?.closedToDeparture??!1,ariStopSell:s?.stopSell??!1}}).afterClosed().subscribe(p=>{if(p){let A=new Date(p.startDate),V=new Date(p.endDate),N=this.generateDateRangeArray(A,V),$=this.ariData(),R={};Object.keys($.ratePlanARI).forEach(v=>{R[v]={},Object.keys($.ratePlanARI[v]).forEach(f=>{R[v][f]=q({},$.ratePlanARI[v][f])})}),R[e.id]||(R[e.id]={}),N.forEach(v=>{let f=this.getDateString(v),k=$.ratePlanARI[e.id]?.[f]||{};switch(R[e.id][f]=q({},k),p.restrictionType){case"rate":R[e.id][f].rate=p.value;break;case"availability":R[e.id][f].availability=p.value;break;case"min-stay":R[e.id][f].minStay=p.value;break;case"max-stay":R[e.id][f].maxStay=p.value;break;case"cta":R[e.id][f].closedToArrival=p.value;break;case"ctd":R[e.id][f].closedToDeparture=p.value;break;case"stop-sell":R[e.id][f].stopSell=p.value;break}}),this.ariData.set({ratePlanARI:R,roomTypeAvailability:$.roomTypeAvailability}),this.hasUnsavedChanges.set(!0)}})}extractRoomTypeAvailability(e,t){let a=new Map,i=this.roomTypes().find(m=>m.id===e);if(!i?.channexRoomTypeId){let m=this.ratePlans().filter(p=>p.roomTypeId===e).map(p=>p.id);if(m.length>0){let p=t.ratePlanARI[m[0]];p&&Object.entries(p).forEach(([A,V])=>{V.availability!==void 0&&a.set(A,V.availability)})}return a}let s=t.roomTypeAvailability[i.channexRoomTypeId];return s&&Object.entries(s).forEach(([m,p])=>{a.set(m,p)}),a}getARIForRatePlan(e,t){let a=this.getDateString(t);return this.ariData().ratePlanARI[e]?.[a]||null}getAvailabilityForRatePlan(e,t){return this.getARIForRatePlan(e,t)?.availability??null}getRateForRatePlan(e,t){return this.getARIForRatePlan(e,t)?.rate??null}isStopSellForRatePlan(e,t){return this.getARIForRatePlan(e,t)?.stopSell??!1}isClosedToArrivalForRatePlan(e,t){return this.getARIForRatePlan(e,t)?.closedToArrival??!1}isClosedToDepartureForRatePlan(e,t){return this.getARIForRatePlan(e,t)?.closedToDeparture??!1}getMinStayForRatePlan(e,t){return this.getARIForRatePlan(e,t)?.minStay??null}getMaxStayForRatePlan(e,t){return this.getARIForRatePlan(e,t)?.maxStay??null}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=W({type:o,selectors:[["app-inventory-rates"]],decls:48,vars:24,consts:[["startDateInput",""],["startPicker",""],["endDateInput",""],["endPicker",""],["roomTypeMenu","matMenu"],["title","Rates & Availability","description","Manage room rates, availability, and restrictions for Channex distribution"],["actions",""],["matButton","outlined",1,"text-gray-700",3,"click","disabled"],["matButtonIcon",""],["matButton","filled","color","primary","disabled","",1,"relative"],["matButton","filled","color","primary",3,"disabled"],[1,"space-y-6"],[1,"hidden",3,"formGroup"],["matInput","","formControlName","startDate",3,"matDatepicker"],["matInput","","formControlName","endDate",3,"matDatepicker"],["appearance","outlined",1,"border-l-4","border-orange-500","bg-orange-50"],["appearance","outlined"],[1,"border-b","border-outline-variant","mb-2","p-3","flex","items-center","justify-between","gap-4"],[1,"flex","items-center","gap-4"],["mat-icon-button","","matTooltip","Previous period",3,"click"],[1,"font-medium","text-gray-700","whitespace-nowrap","cursor-pointer","hover:bg-gray-100","px-3","py-1","rounded","transition-colors",3,"click"],["mat-icon-button","","matTooltip","Next period",3,"click"],["appearance","outline",1,"min-w-72"],["multiple","",3,"selectionChange","value"],[3,"value"],[1,"px-0!","pb-2!"],[1,"flex","items-center","justify-center","py-12"],[1,"bg-red-50","border","border-red-200","rounded-md","p-4","text-red-700"],[1,"flex","items-center","justify-center","py-4","bg-blue-50","border","border-blue-200","rounded-md","gap-3","mb-4"],[1,"bg-yellow-50","border","border-yellow-200","rounded-md","p-4","text-yellow-700","mb-4"],[1,"relative","overflow-x-auto"],[1,"text-center","py-12"],[1,"bg-green-50","border","border-green-200","rounded-md","p-4","text-green-700","flex","items-center","gap-3","animate-in","fade-in","duration-300"],[1,"bg-yellow-50","border","border-yellow-200","rounded-md","p-4","text-yellow-700","animate-in","fade-in","duration-300"],[1,"bg-red-50","border","border-red-200","rounded-md","p-4","text-red-700","flex","items-center","gap-3","animate-in","fade-in","duration-300"],["matButton","filled","color","primary",3,"click","disabled"],[1,"p-6"],[1,"flex","items-start","gap-4"],[1,"text-orange-600","mt-1"],[1,"flex-1"],[1,"font-semibold","text-orange-900","mb-2"],[1,"text-orange-800","text-sm","mb-4"],["mat-raised-button","","color","warn","routerLink","/admin/channel-management",1,"text-sm"],["diameter","40"],[1,"ml-4","text-gray-600"],[1,"font-medium"],[1,"text-sm","mt-1"],["diameter","20"],[1,"text-sm","text-blue-700"],[1,"font-medium","text-sm"],[1,"text-xs","mt-1"],[1,"w-full","border-collapse"],[1,"border-b","border-gray-200"],[1,"sticky","left-0","border-r","border-gray-200","w-56","text-left","font-semibold","text-gray-700","px-4","py-3","bg-[var(--mat-sys-surface)]"],[1,"text-center","font-medium","text-gray-600","text-xs","whitespace-nowrap","border-r","border-gray-200","px-3","py-2","min-w-24"],[1,"sticky","right-0","border-l","border-gray-200","w-16","text-center","font-semibold","text-gray-700","px-4","py-3","bg-[var(--mat-sys-surface)]"],[1,"font-semibold","text-gray-900"],[1,"text-gray-500"],[1,"border-b","border-gray-300","hover:bg-blue-100"],[1,"sticky","left-0","border-r","border-gray-300","px-4","py-3","bg-[var(--mat-sys-surface)]"],[1,"text-sm","font-bold","text-gray-900"],[1,"text-xs","text-gray-600","mt-1"],[1,"px-3","py-3","border-r","border-gray-200","text-center","cursor-pointer","hover:bg-blue-100","transition-colors"],[1,"sticky","right-0","border-l","border-gray-300","px-4","py-3","text-center","bg-[var(--mat-sys-surface)]"],["mat-icon-button","","matTooltip","Room type options",1,"text-gray-600","hover:text-gray-900",3,"matMenuTriggerFor"],["mat-menu-item","",3,"click"],[1,"px-3","py-3","border-r","border-gray-200","text-center","cursor-pointer","hover:bg-blue-100","transition-colors",3,"click"],[1,"text-sm","font-semibold","text-blue-900"],[1,"border-b","border-gray-200","hover:bg-amber-50"],[1,"sticky","left-0","border-r","border-gray-200","px-6","py-3","pl-8","bg-[var(--mat-sys-surface)]"],[1,"text-sm","font-medium","text-gray-700"],[1,"text-xs","text-gray-500","mt-0.5"],[1,"px-3","py-3","border-r","border-gray-200","text-center","cursor-pointer","hover:bg-orange-50","transition-colors"],[1,"sticky","right-0","border-l","border-gray-200","px-4","py-3","bg-[var(--mat-sys-surface)]"],[1,"px-3","py-3","border-r","border-gray-200","text-center","cursor-pointer","hover:bg-orange-50","transition-colors",3,"click"],[1,"text-xs","text-gray-400"],[1,"text-sm","font-semibold","text-white","bg-red-500","px-2","py-1","rounded","inline-block",3,"matTooltip"],[1,"text-sm","font-semibold","text-gray-900"],[1,"sticky","left-0","border-r","border-gray-200","px-6","py-2","pl-8","bg-[var(--mat-sys-surface)]"],[1,"text-xs","font-medium","text-gray-600"],[1,"px-3","py-2","border-r","border-gray-200","text-center","text-xs","cursor-pointer","hover:bg-gray-100"],[1,"sticky","right-0","border-l","border-gray-200","px-4","py-2","bg-[var(--mat-sys-surface)]"],[1,"px-3","py-2","border-r","border-gray-200","text-center","text-xs","cursor-pointer","hover:bg-gray-100",3,"click"],[1,"text-gray-700","font-medium"],[1,"inline-block","bg-red-200","text-red-800","px-2","py-0.5","rounded"],[1,"text-gray-400"],[1,"inline-block","bg-red-500","text-white","px-2","py-0.5","rounded"],[1,"text-gray-400","mx-auto",2,"font-size","48px","width","48px","height","48px"],[1,"text-gray-600","mt-4"],[1,"text-green-600"],[1,"text-sm"],[1,"flex","items-start","gap-3"],[1,"text-yellow-600","mt-1"],[1,"font-medium","mb-2"],[1,"text-sm","space-y-1"],[1,"flex","items-start","gap-2"],[1,"text-red-600"]],template:function(t,a){if(t&1){let i=E();r(0,"app-page-header",5),ke(1,6),r(2,"button",7),b("click",function(){return x(i),D(a.resetChanges())}),r(3,"mat-icon",8),l(4,"refresh"),n(),l(5," Reset "),n(),u(6,Zt,4,0,"button",9)(7,Qt,4,1,"button",10),Ve(),n(),r(8,"div",11)(9,"form",12),C(10,"input",13,0)(12,"mat-datepicker",null,1)(14,"input",14,2)(16,"mat-datepicker",null,3),n(),u(18,Xt,14,1,"mat-card",15),r(19,"mat-card",16)(20,"div",17)(21,"div",18)(22,"button",19),b("click",function(){return x(i),D(a.navigateToPreviousPeriod())}),r(23,"mat-icon"),l(24,"chevron_left"),n()(),r(25,"span",20),b("click",function(){return x(i),D(a.openDatePicker())}),l(26),B(27,"date"),B(28,"date"),n(),r(29,"button",21),b("click",function(){return x(i),D(a.navigateToNextPeriod())}),r(30,"mat-icon"),l(31,"chevron_right"),n()()(),r(32,"mat-form-field",22)(33,"mat-label"),l(34,"Show Restrictions"),n(),r(35,"mat-select",23),b("selectionChange",function(m){return x(i),D(a.onRestrictionsChange(m.value))}),F(36,ea,2,2,"mat-option",24,Jt),n()()(),r(38,"mat-card-content",25),u(39,ta,4,0,"div",26),u(40,aa,6,3,"div",27),u(41,ia,4,0,"div",28),u(42,na,5,1,"div",29),u(43,ka,13,0,"div",30),u(44,Va,5,0,"div",31),n()(),u(45,Na,8,0,"div",32),u(46,$a,10,0,"div",33),u(47,Ba,8,0,"div",34),n()}if(t&2){let i=H(13),s=H(17);d(2),h("disabled",!a.getHasUnsavedChanges()),d(4),g(a.getIsSaving()?6:7),d(3),h("formGroup",a.dateRangeForm),d(),h("matDatepicker",i),d(4),h("matDatepicker",s),d(4),g(a.getIsStoreChannexSynced()?-1:18),d(8),Ne(" ",G(27,18,a.getCalendarDates()[0],"MMM d")," - ",G(28,21,a.getCalendarDates()[a.getCalendarDates().length-1],"MMM d, yyyy")," "),d(9),h("value",a.getSelectedRestrictions()),d(),w(a.getAvailableRestrictions()),d(3),g(a.getIsLoading()?39:-1),d(),g(a.getError()?40:-1),d(),g(a.getIsLoadingARI()?41:-1),d(),g(a.getARILoadError()?42:-1),d(),g(!a.getIsLoading()&&!a.getError()&&a.getCalendarDates().length>0?43:-1),d(),g(!a.getIsLoading()&&!a.getError()&&a.getCalendarDates().length===0?44:-1),d(),g(a.getSaveStatus()==="success"?45:-1),d(),g(a.getSaveWarnings().length>0?46:-1),d(),g(a.getSaveStatus()==="error"?47:-1)}},dependencies:[z,ne,ee,Z,Q,X,ae,te,je,Xe,Ze,Qe,le,re,oe,de,se,Y,K,We,Ye,Ke,be,pt,ut,_e,he,dt,me,ce,J,qe,ht,mt,ct,Ce,et,nt,at,tt,it,Rt,Ge,Ue,Le],styles:["[_nghost-%COMP%]{display:block}table[_ngcontent-%COMP%]{border-collapse:collapse;width:100%}table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{position:sticky;top:0;z-index:10}table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:first-child, table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:first-child{position:sticky;left:0;z-index:9}table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]:hover{transition:background-color .2s ease}table[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus{box-shadow:0 0 0 3px #3b82f61a}table[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:disabled{background-color:#f3f4f6;color:#6b7280;cursor:not-allowed}@media(max-width:1024px){table[_ngcontent-%COMP%]{font-size:.875rem}table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{padding:.5rem}table[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:3rem}}@media(max-width:768px){table[_ngcontent-%COMP%]{font-size:.75rem}table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{padding:.25rem}table[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:2.5rem;font-size:.7rem}.overflow-x-auto[_ngcontent-%COMP%]{-webkit-overflow-scrolling:touch}}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}.animate-in[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_fadeIn .3s ease-out}button[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}  .mat-mdc-card-header{padding:0}"],changeDetection:0})};export{Nt as InventoryRatesComponent};
