import{a as be}from"./chunk-IN4JIQ3S.js";import{a as fe,b as he,e as Re,f as Ce,g as ve,h as xe}from"./chunk-DCD2EY64.js";import{a as ce,c as de,f as ue,g as pe,l as ge}from"./chunk-T3KX74D3.js";import{a as le,b as se}from"./chunk-FBHRMY6R.js";import{a as re,b as me}from"./chunk-3IQG3KHZ.js";import{d as P}from"./chunk-YK4A772F.js";import{a as V}from"./chunk-CGDRKYIW.js";import{b as te,c as ie,d as ne}from"./chunk-IS37LNAK.js";import{a as Y,b as Z,h as ee}from"./chunk-QJ2P7YZL.js";import{a as oe,b as ae}from"./chunk-ZG44B3L4.js";import{B as X,b as U,d as _,g as z,h as H,m as J,s as K,t as Q,z as W}from"./chunk-SZWYIW32.js";import{a as q}from"./chunk-V7ZBVJLR.js";import{a as G}from"./chunk-T4ACDKLD.js";import{b as $,c as j}from"./chunk-OWLRGWNJ.js";import{$ as L,Z as A}from"./chunk-OS2CYUJN.js";import{p as O,r as B}from"./chunk-U2P6GFP5.js";import{$a as r,Gb as d,Hb as u,Jc as g,Kb as E,Lb as k,Lc as f,Mb as D,Nb as a,Ob as i,Pb as x,Tc as c,_b as S,ac as v,ea as h,mc as F,ob as w,pc as n,qc as b,rc as p,sc as I,va as C}from"./chunk-IQSYHSID.js";import{f as N}from"./chunk-EQDQRRRY.js";var Te=(o,t)=>t._id;function we(o,t){o&1&&(a(0,"div",1),x(1,"mat-spinner",7),i())}function Ee(o,t){if(o&1&&(a(0,"mat-option",18)(1,"div",21)(2,"span")(3,"strong"),n(4),i(),n(5),a(6,"span",22),n(7),i()(),a(8,"span",23),n(9),g(10,"currency"),i()()()),o&2){let e=t.$implicit,m=v(2);D("value",e),r(4),b(e.roomNumber),r(),p(" - ",e.name," "),r(2),p("(",e.roomType==null?null:e.roomType.name,")"),r(2),p(" ",f(10,5,m.getRoomRate(e),m.data.currency),"/night ")}}function ke(o,t){o&1&&(a(0,"mat-option",19),n(1,"No rooms available"),i())}function Fe(o,t){o&1&&(a(0,"mat-error"),n(1,"Please select a room"),i())}function Oe(o,t){o&1&&(a(0,"mat-error"),n(1,"Reason is required"),i())}function Be(o,t){o&1&&(a(0,"mat-error"),n(1,"Minimum 10 characters"),i())}function Pe(o,t){if(o&1&&(a(0,"div",26)(1,"mat-icon",34),n(2,"info"),i(),n(3),i()),o&2){let e=v(3);r(3),I(" Mid-stay change: ",e.nightsConsumed()," night(s) consumed, ",e.nightsRemaining()," remaining ")}}function Ae(o,t){if(o&1&&(a(0,"div",32)(1,"mat-icon",34),n(2,"warning"),i(),n(3),g(4,"currency"),i()),o&2){let e=v(3);r(3),p(" Additional payment of ",f(4,1,e.priceDifference(),e.data.currency)," required ")}}function Le(o,t){if(o&1&&(a(0,"div",33)(1,"mat-icon",34),n(2,"savings"),i(),n(3),g(4,"currency"),i()),o&2){let e=v(3);r(3),p(" Refund of ",f(4,1,e.Math.abs(e.priceDifference()),e.data.currency)," will be applied ")}}function qe(o,t){if(o&1&&(x(0,"mat-divider"),a(1,"div",24)(2,"div",25),n(3,"Pricing Summary"),i(),d(4,Pe,4,2,"div",26),a(5,"mat-list",27)(6,"mat-list-item")(7,"span",28),n(8,"Current Rate"),i(),a(9,"span",29),n(10),g(11,"currency"),i()(),a(12,"mat-list-item")(13,"span",28),n(14,"New Rate"),i(),a(15,"span",29),n(16),g(17,"currency"),i()(),a(18,"mat-list-item")(19,"span",28),n(20),i(),a(21,"span",29),n(22),g(23,"currency"),i()(),x(24,"mat-divider"),a(25,"mat-list-item")(26,"span",30),n(27,"Difference"),i(),a(28,"span",31),n(29),g(30,"currency"),i()()(),d(31,Ae,5,4,"div",32),d(32,Le,5,4,"div",33),i()),o&2){let e=v(2);r(4),u(e.isMidStayChange()?4:-1),r(6),p("",f(11,13,e.currentRoomDetails().rate,e.data.currency),"/night"),r(6),p("",f(17,16,e.newRoomRate(),e.data.currency),"/night"),r(4),p("Nights (",e.data.numberOfNights,")"),r(2),b(f(23,19,e.currentRoomCost(),e.data.currency)),r(6),F("text-red-600",e.priceDifference()>0)("text-green-600",e.priceDifference()<0),r(),I(" ",e.priceDifference()>=0?"+":"","",f(30,22,e.priceDifference(),e.data.currency)," "),r(2),u(e.priceDifference()>0?31:-1),r(),u(e.priceDifference()<0?32:-1)}}function Ge(o,t){if(o&1&&(a(0,"form",2)(1,"div",8)(2,"div",9),n(3,"Current Room"),i(),a(4,"div",10)(5,"div")(6,"span",11),n(7),i(),a(8,"span",12),n(9),i()(),a(10,"div",13)(11,"div",14),n(12),i(),a(13,"div",15),n(14),g(15,"currency"),i()()()(),a(16,"mat-form-field",16)(17,"mat-label"),n(18,"Select New Room"),i(),a(19,"mat-select",17),E(20,Ee,11,8,"mat-option",18,Te,!1,ke,2,0,"mat-option",19),i(),d(23,Fe,2,0,"mat-error"),i(),a(24,"mat-form-field",16)(25,"mat-label"),n(26,"Reason for Change"),i(),x(27,"textarea",20),d(28,Oe,2,0,"mat-error"),d(29,Be,2,0,"mat-error"),i(),d(30,qe,33,25),i()),o&2){let e,m,s,l=v();D("formGroup",l.roomChangeForm),r(7),b(l.currentRoomDetails().roomNumber),r(2),b(l.currentRoomDetails().roomName),r(3),b(l.currentRoomDetails().roomTypeName),r(2),p("",f(15,10,l.currentRoomDetails().rate,l.data.currency),"/night"),r(6),k(l.availableRooms()),r(3),u((e=l.roomChangeForm.get("newRoom"))!=null&&e.hasError("required")?23:-1),r(5),u((m=l.roomChangeForm.get("reason"))!=null&&m.hasError("required")?28:-1),r(),u((s=l.roomChangeForm.get("reason"))!=null&&s.hasError("minlength")?29:-1),r(),u(l.selectedNewRoom()?30:-1)}}function Ve(o,t){o&1&&x(0,"mat-spinner",6)}var De=class o{dialogRef=h(fe);fb=h(W);roomsService=h(be);storeService=h(V);authService=h(G);snackBar=h(q);data=h(he);roomChangeForm=this.fb.group({newRoom:[null,_.required],reason:["",[_.required,_.minLength(10)]]});availableRooms=C([]);loadingRooms=C(!0);submitting=C(!1);selectedNewRoom=C(null);formValid=C(!1);effectiveDate=C(new Date);currentRoom=c(()=>{let t=this.data.currentRoomIndex??0;return this.data.currentRooms[t]||this.data.currentRooms[0]});currentRoomDetails=c(()=>{let t=this.currentRoom(),e=t?.room||t;return{roomNumber:e?.roomNumber||"\u2014",roomName:e?.name||"\u2014",roomTypeName:e?.roomType?.name||t?.roomType?.name||"Standard",rate:this.getRoomRate(t)}});nightsConsumed=c(()=>{let t=new Date(this.data.checkInDate),e=this.effectiveDate();if(this.data.reservationStatus!=="checked_in")return 0;let m=this.data.actualCheckInDate?new Date(this.data.actualCheckInDate):t,s=e.getTime()-m.getTime();return Math.max(0,Math.floor(s/(1e3*60*60*24)))});nightsRemaining=c(()=>{let t=new Date(this.data.checkOutDate),e=this.effectiveDate(),m=t.getTime()-e.getTime();return Math.max(0,Math.floor(m/(1e3*60*60*24)))});isMidStayChange=c(()=>this.nightsConsumed()>0);currentRoomCost=c(()=>this.currentRoomDetails().rate*this.data.numberOfNights);newRoomRate=c(()=>{let t=this.selectedNewRoom();return t?this.getRoomRate(t):0});priceDifference=c(()=>{if(!this.selectedNewRoom())return 0;let e=this.nightsRemaining(),m=this.currentRoomDetails().rate,s=this.newRoomRate();return e*s-e*m});newTotal=c(()=>this.currentRoomCost()+this.priceDifference());canSubmit=c(()=>this.formValid()&&this.selectedNewRoom()!==null&&!this.submitting());Math=Math;ngOnInit(){this.loadAvailableRooms(),this.roomChangeForm.get("newRoom")?.valueChanges.subscribe(t=>{this.selectedNewRoom.set(t)}),this.roomChangeForm.statusChanges.subscribe(()=>{this.formValid.set(this.roomChangeForm.valid)})}loadAvailableRooms(){return N(this,null,function*(){try{this.loadingRooms.set(!0);let t=this.storeService.getStoreLocally;if(!t)throw new Error("No store selected");let e=yield this.roomsService.getAvailableRooms({storeId:t._id,checkInDate:this.data.checkInDate,checkOutDate:this.data.checkOutDate,excludeReservationId:this.data.reservationId}).toPromise(),m=this.currentRoom()?.room?._id||this.currentRoom()?.room,s=(e||[]).filter(l=>l._id!==m);this.availableRooms.set(s)}catch(t){console.error("Error loading available rooms:",t),this.snackBar.open("Failed to load available rooms","Close",{duration:3e3})}finally{this.loadingRooms.set(!1)}})}getRoomRate(t){if(!t)return 0;if(t.pricing?.pricePerNight)return t.pricing.pricePerNight;if(t.priceOverride!==null&&t.priceOverride!==void 0&&typeof t.priceOverride=="number")return t.priceOverride;if(t.room&&typeof t.room=="object"){if(t.room.priceOverride!==null&&t.room.priceOverride!==void 0)return t.room.priceOverride;if(t.room.roomType?.basePrice)return t.room.roomType.basePrice}return t.roomType?.basePrice?t.roomType.basePrice:0}onSubmit(){return N(this,null,function*(){if(this.canSubmit())try{this.submitting.set(!0);let t=this.currentRoom(),e=this.selectedNewRoom(),m=t?.room||t,s=this.roomChangeForm.get("reason")?.value,l=this.nightsConsumed(),T=this.nightsRemaining(),y=this.currentRoomDetails().rate,M=this.newRoomRate(),_e=this.data.currentRoomIndex??0,ye=this.data.currentRooms.map((R,Ie)=>Ie===_e?{currentRoomId:R._id||m._id,room:e._id,roomType:e.roomType?._id||e.roomType,guests:R.guests||{adults:1,children:0},currentRoomDetails:{roomNumber:m.roomNumber,name:m.name,rate:y},newRoomDetails:{roomNumber:e.roomNumber,name:e.name,rate:M,priceOverride:e.priceOverride},priceDifference:this.priceDifference(),fromRate:y,toRate:M}:{room:R.room?._id||R.room,roomType:R.roomType?._id||R.roomType,guests:R.guests||{adults:1,children:0}}),Me=l>0?` (${l} night(s) consumed, ${T} night(s) remaining)`:"",Ne=`Room changed from ${m.roomNumber} to ${e.roomNumber}${Me}. Reason: ${s}`,Se={mode:"single",currentRoom:t,newRoom:e,newRooms:ye,pricingAdjustment:{oldTotal:this.currentRoomCost(),newTotal:this.newTotal(),difference:this.priceDifference(),requiresPayment:this.priceDifference()>0,refundAmount:this.priceDifference()<0?Math.abs(this.priceDifference()):void 0,nightsConsumed:l,nightsRemaining:T},reason:s,effectiveDate:this.effectiveDate().toISOString(),suggestedInternalNote:Ne,performedBy:this.authService.currentUserValue?._id||"",roomMapping:[{fromRoomId:m._id,fromReservationRoomId:t._id,fromRoomNumber:m.roomNumber,fromRoomName:m.name,fromRate:y,toRoomId:e._id,toRoomNumber:e.roomNumber,toRoomName:e.name,toRate:M,toRoomType:e.roomType?._id||e.roomType,priceDifference:this.priceDifference()}]};this.dialogRef.close(Se)}catch(t){console.error("Error submitting room change:",t),this.snackBar.open("Failed to process room change","Close",{duration:3e3})}finally{this.submitting.set(!1)}})}onCancel(){this.dialogRef.close()}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=w({type:o,selectors:[["app-room-change-dialog"]],decls:11,vars:4,consts:[["mat-dialog-title",""],[1,"flex","justify-center","py-8"],[1,"flex","flex-col","gap-4",3,"formGroup"],["align","end"],["mat-button","",3,"click","disabled"],["mat-flat-button","","color","primary",3,"click","disabled"],["diameter","20",1,"inline-block","mr-2"],["diameter","40"],[1,"bg-gray-100","rounded-lg","p-4"],[1,"text-sm","text-gray-500","mb-1"],[1,"flex","items-center","justify-between"],[1,"text-xl","font-bold"],[1,"text-gray-600","ml-2"],[1,"text-right"],[1,"text-sm","text-gray-500"],[1,"font-semibold"],["appearance","outline",1,"w-full"],["formControlName","newRoom"],[3,"value"],["disabled",""],["matInput","","formControlName","reason","rows","2","placeholder","e.g., Guest requested upgrade, maintenance issue..."],[1,"flex","justify-between","items-center","w-full"],[1,"text-gray-500","text-sm","ml-1"],[1,"text-green-600","font-medium"],[1,"space-y-2"],[1,"text-sm","font-medium","text-gray-700"],[1,"text-xs","text-blue-600","bg-blue-50","p-2","rounded"],["dense",""],["matListItemTitle",""],["matListItemMeta",""],["matListItemTitle","",1,"font-bold"],["matListItemMeta","",1,"font-bold"],[1,"text-sm","text-red-600","bg-red-50","p-2","rounded"],[1,"text-sm","text-green-600","bg-green-50","p-2","rounded"],[1,"text-sm","align-middle","mr-1"]],template:function(e,m){e&1&&(a(0,"h2",0),n(1,"Change Room"),i(),a(2,"mat-dialog-content"),d(3,we,2,0,"div",1)(4,Ge,31,13,"form",2),i(),a(5,"mat-dialog-actions",3)(6,"button",4),S("click",function(){return m.onCancel()}),n(7,"Cancel"),i(),a(8,"button",5),S("click",function(){return m.onSubmit()}),d(9,Ve,1,0,"mat-spinner",6),n(10," Change Room "),i()()),e&2&&(r(3),u(m.loadingRooms()?3:4),r(3),D("disabled",m.submitting()),r(2),D("disabled",!m.canSubmit()),r(),u(m.submitting()?9:-1))},dependencies:[B,X,J,U,z,H,Q,K,xe,Re,ve,Ce,te,ee,Y,Z,me,re,P,ne,ie,L,A,j,$,se,le,ae,oe,ge,ue,pe,ce,de,O],encapsulation:2})};export{De as a};
