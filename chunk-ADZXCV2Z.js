import{a as F}from"./chunk-WHARIOSL.js";import{i as _}from"./chunk-ZKQYDJ5W.js";import{a as $}from"./chunk-BFT2MTJY.js";import{A as R}from"./chunk-H22US2IH.js";import{aa as I,fa as O}from"./chunk-P5WOETP4.js";import{a as d,g as T}from"./chunk-GAL4ENT6.js";var x=class u{http=O(R);storeStore=O(_);bluetoothPrinterService=O(F);apiUrl=`${$.apiUrl}/print-jobs`;COMMANDS={INIT:"\x1B@",ALIGN_CENTER:"\x1Ba",ALIGN_LEFT:"\x1Ba\0",TEXT_DOUBLE_SIZE:"\x1B!0",TEXT_NORMAL:"\x1B!\0",BOLD_ON:"\x1BE",BOLD_OFF:"\x1BE\0",FEED_LINE:`
`,CUT_PAPER:"V\0"};getPrintJobs(e,r){let n=d({store:e,populate:"order,station"},r);return this.http.get(this.apiUrl,{params:n})}getPrintJobById(e){return this.http.get(`${this.apiUrl}/${e}`)}getPrintJobStats(e){return this.http.get(`${this.apiUrl}/stats`,{params:{store:e}})}retryPrintJob(e){return this.http.post(`${this.apiUrl}/${e}/retry`,{})}cancelPrintJob(e){return this.http.post(`${this.apiUrl}/${e}/cancel`,{})}createPrintJobsForOrder(e){return this.http.post(`${this.apiUrl}/create-for-order`,{orderData:e})}generateOrderReceipt(e){if(console.log("=== GENERATE RECEIPT ==="),console.log("Order ID:",e._id),console.log("Order Reference:",e.reference),console.log("Order cart products:",e.cart?.products?.length||0),!e)return console.error("\u274C No order provided"),this.COMMANDS.INIT+`ERROR: No order data
`+this.COMMANDS.CUT_PAPER;let r=this.storeStore.selectedStore()?.posSettings?.receiptSettings,n=r?.showNote??!1,N=r?.showTax??!0,g=r?.showStoreDetails??!0,l=r?.showSellerInfo??!0,h=r?.showCustomerName??!0,p=r?.footerMessage||"Thank you for your patronage",C=r?.disclaimer||"",t="";if(t+=this.COMMANDS.INIT,g){t+=this.COMMANDS.ALIGN_CENTER,t+=this.COMMANDS.TEXT_DOUBLE_SIZE,t+=this.COMMANDS.BOLD_ON;let o=e.store;o&&o.name&&(t+=`${o.name}
`),t+=`KITCHEN ORDER
`,t+=this.COMMANDS.BOLD_OFF,t+=this.COMMANDS.TEXT_NORMAL}if(t+=this.COMMANDS.ALIGN_LEFT,t+=`================================
`,t+=this.COMMANDS.BOLD_ON,t+=`Order: #${e.reference||e._id}
`,t+=this.COMMANDS.BOLD_OFF,t+=`Time: ${this.formatDate(e.createdAt||new Date)}
`,e.type&&(t+=`Type: ${e.type}
`),e.salesChannel&&(t+=`Channel: ${e.salesChannel}
`),e.table){let o=e.table;t+=`Table: ${o.number||o.name||o}
`}if(h&&e.guest){let o=e.guest;o.name&&(t+=`Guest: ${o.name}
`),o.room&&(t+=`Room: ${o.room}
`)}if(l&&e.staff){let o=e.staff,D=o.name||o.firstName||o;t+=`Server: ${D}
`}t+=`================================
`;let y=e.cart?.products||[],i=this.storeStore.selectedStore()?.currencyCode||"NGN";y.length>0?(t+=this.COMMANDS.BOLD_ON,t+=`ITEMS:
`,t+=this.COMMANDS.BOLD_OFF,y.forEach(o=>{let D=o.name,L=o.quantity||1,E=o.price||0;t+=`${L}x ${D}`,E>0&&(t+=` - ${this.formatCurrency(E,i)}`),t+=`
`,o.options&&Array.isArray(o.options)&&o.options.length>0&&o.options.forEach(s=>{if(s.options&&Array.isArray(s.options))s.options.forEach(a=>{if(a.selected){let f=a.quantity||1,c=a.price||0;t+=`   + ${f}x ${a.name}`,c>0&&(t+=` (${this.formatCurrency(c,i)})`),t+=`
`}});else{let a=s.optionItemName||s.name||s,f=s.quantity||1,c=s.price||0;f>1?t+=`   + ${f}x ${a}`:t+=`   + ${a}`,c>0&&(t+=` (${this.formatCurrency(c,i)})`),t+=`
`}}),o.notes&&(t+=`   Note: ${o.notes}
`),t+=`
`})):t+=`No items in order
`,t+=`================================
`;let A=e.subTotal||e.subtotal,m=e.tax,S=e.discount,b=e.shippingFee,P=e.serviceFee,M=e.total;return t+=this.COMMANDS.BOLD_ON,t+=`ORDER SUMMARY:
`,t+=this.COMMANDS.BOLD_OFF,A!==void 0&&(t+=`Subtotal:            ${this.formatCurrency(A,i)}
`),N&&m&&m>0&&(t+=`Tax:                 ${this.formatCurrency(m,i)}
`),S&&S>0&&(t+=`Discount:           -${this.formatCurrency(S,i)}
`),b&&b>0&&(t+=`Shipping:            ${this.formatCurrency(b,i)}
`),P&&P>0&&(t+=`Service Fee:         ${this.formatCurrency(P,i)}
`),M!==void 0&&(t+=`--------------------------------
`,t+=this.COMMANDS.BOLD_ON,t+=`TOTAL:               ${this.formatCurrency(M,i)}
`,t+=this.COMMANDS.BOLD_OFF),e.payment&&(t+=`Payment: ${e.payment}
`),e.paymentStatus&&(t+=`Status: ${e.paymentStatus}
`),t+=`================================
`,n&&(e.note||e.orderInstruction)&&(t+=this.COMMANDS.BOLD_ON,t+=`NOTES:
`,t+=this.COMMANDS.BOLD_OFF,t+=`${e.note||e.orderInstruction}
`,t+=`================================
`),t+=this.COMMANDS.ALIGN_CENTER,p&&(t+=`${p}
`),C&&(t+=this.COMMANDS.TEXT_NORMAL,t+=`${C}
`),t+=this.COMMANDS.TEXT_NORMAL,t+=`Order: ${e.reference||e._id.substring(e._id.length-6)}
`,t+=this.COMMANDS.FEED_LINE,t+=this.COMMANDS.FEED_LINE,t+=this.COMMANDS.CUT_PAPER,console.log("=== RECEIPT GENERATED ==="),t}printOrderReceipt(e){return T(this,null,function*(){if(this.bluetoothPrinterService.isConnected()){console.log("\u{1F4F1} [PRINT] Printer connected - Printing directly via Bluetooth");try{let n=this.generateOrderReceipt(e);return yield this.bluetoothPrinterService.sendToPrinter(n),console.log("\u2705 [PRINT] Direct print completed"),{isPrinterConnected:!0}}catch(n){throw console.error("\u274C [PRINT] Direct print failed:",n),n}}else{console.log("\u{1F4E1} [PRINT] No printer connected - Creating backend print job");try{let n=yield this.createPrintJobsForOrder(e).toPromise();return console.log("\u2705 [PRINT] Print job created - Master system will print:",n),{isPrinterConnected:!1}}catch(n){throw console.error("\u274C [PRINT] Failed to create print job:",n),new Error("Failed to create print job. Please try again.")}}})}formatCurrency(e,r){let n=e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});return`${r} ${n}`}formatDate(e){return e?new Date(e).toLocaleString():"-"}handleAutoPrint(e){return T(this,null,function*(){try{console.log("\u{1F50D} [AUTO-PRINT] Checking auto-print conditions");let r=e.printJob||e;if(!r){console.warn("\u26A0\uFE0F [AUTO-PRINT] No print job data");return}console.log("\u2713 Print Job ID:",r._id),console.log("\u2713 Job Status:",r.status);let n=r.order;if(!n||typeof n!="object"){console.warn("\u26A0\uFE0F [AUTO-PRINT] No order object in print job");return}console.log("\u2713 Order ID:",n._id),console.log("\u2713 Order Category:",n.category),console.log("\u2713 Payment Status:",n.paymentStatus);let N=n.category==="Complete",g=n.paymentStatus==="Paid";console.log("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501"),console.log("\u{1F50D} [ORDER VALIDATION]"),console.log("  Complete:",N?"\u2705":"\u274C"),console.log("  Paid:",g?"\u2705":"\u274C"),console.log("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501");let l=this.storeStore.selectedStore()?.posSettings?.receiptSettings?.printAfterFinish??!0;if(console.log("\u{1F50D} [STORE SETTING] printAfterFinish:",l),!l){console.log("\u23ED\uFE0F [AUTO-PRINT] Skipped - Store setting printAfterFinish is disabled");return}let h=this.bluetoothPrinterService.isConnected();if(console.log("\u{1F5A8}\uFE0F [PRINTER CHECK] Bluetooth connected:",h?"\u2705":"\u274C"),!h){console.log("\u23ED\uFE0F [AUTO-PRINT] Skipped - Bluetooth printer not connected");return}console.log("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501"),console.log("\u{1F5A8}\uFE0F [AUTO-PRINTING] Receipt via Bluetooth..."),console.log("  Order:",n.reference||n._id),console.log("  Store:",n.store?.name||"N/A"),console.log("  Total:",n.total),console.log("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501");let p=this.generateOrderReceipt(n);yield this.bluetoothPrinterService.sendToPrinter(p),console.log("\u2705 [AUTO-PRINT] Printed directly via Bluetooth"),console.log(`\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501
`)}catch(r){console.error("\u274C [AUTO-PRINT] Failed:",r)}})}static \u0275fac=function(r){return new(r||u)};static \u0275prov=I({token:u,factory:u.\u0275fac,providedIn:"root"})};export{x as a};
