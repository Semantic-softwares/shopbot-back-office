<app-page-header title="Rooms Management" subtitle="Manage hotel rooms, room types, and availability">
  <ng-container actions>
    <mat-button-toggle-group [value]="viewMode()" (change)="viewMode.set($event.value)">
      <mat-button-toggle value="table" matTooltip="Table View">
        <mat-icon>table_view</mat-icon>
      </mat-button-toggle>
      <mat-button-toggle value="grid" matTooltip="Grid View">
        <mat-icon>grid_view</mat-icon>
      </mat-button-toggle>
    </mat-button-toggle-group>

    <button matButton="outlined" (click)="clearFilters()">
      <mat-icon>clear</mat-icon>
      Clear Filters
    </button>

    <button matButton="outlined" (click)="roomsResource.reload()">
      <mat-icon>refresh</mat-icon>
      Reload
    </button>

    <button matButton="filled" routerLink="./create">
      <mat-icon>add</mat-icon>
      Add Room
    </button>
  </ng-container>
</app-page-header>

<!-- Stats Cards -->
<div class="max-w-12xl py-6">
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
    <mat-card appearance="outlined">
      <mat-card-content class="p-4!">
        <div class="text-sm text-gray-600">Total Rooms</div>
        <div class="text-2xl font-bold">{{ roomStats().total }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined">
      <mat-card-content class="p-4!">
        <div class="text-sm text-gray-600">Available</div>
        <div class="text-2xl font-bold text-green-600">{{ roomStats().available }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined">
      <mat-card-content class="p-4!">
        <div class="text-sm text-gray-600">Occupied</div>
        <div class="text-2xl font-bold text-purple-600">{{ roomStats().occupied }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined">
      <mat-card-content class="p-4!">
        <div class="text-sm text-gray-600">Maintenance</div>
        <div class="text-2xl font-bold text-orange-600">{{ roomStats().maintenance }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined">
      <mat-card-content class="p-4!">
        <div class="text-sm text-gray-600">Cleaning</div>
        <div class="text-2xl font-bold text-cyan-600">{{ roomStats().cleaning }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined">
      <mat-card-content class="p-4!">
        <div class="text-sm text-gray-600">Out of Order</div>
        <div class="text-2xl font-bold text-red-600">{{ roomStats().outOfOrder }}</div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<!-- Table Container -->
<mat-card appearance="outlined" class="py-2">
  <div class="p-3">
    <form [formGroup]="filterForm">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4 mb-4">
        <!-- Search Input -->
        <div class="lg:col-span-2">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Search rooms...</mat-label>
            <mat-icon matPrefix class="text-gray-400">search</mat-icon>
            <input matInput formControlName="search" placeholder="Room number, type...">
          </mat-form-field>
        </div>

        <!-- Status Filter -->
        <div>
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Status</mat-label>
            <mat-select formControlName="status" multiple>
              @for (status of statusOptions; track status) {
                <mat-option [value]="status">{{ status | titlecase }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Housekeeping Filter -->
        <div>
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Housekeeping</mat-label>
            <mat-select formControlName="housekeepingStatus" multiple>
              @for (status of housekeepingOptions; track status) {
                <mat-option [value]="status">{{ status | titlecase }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Room Type Filter -->
        <div>
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Room Type</mat-label>
            <mat-select formControlName="roomType" multiple>
              @for (roomType of roomTypes(); track roomType.id || roomType._id) {
                <mat-option [value]="roomType.id || roomType._id">{{ roomType.name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Floor Filter -->
        <div>
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Floor</mat-label>
            <mat-select formControlName="floor" multiple>
              @for (floor of getFloorOptions(); track floor) {
                <mat-option [value]="floor">Floor {{ floor }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- Quick Filters -->
      <div class="flex items-center gap-2 flex-wrap">
        <span class="text-sm font-medium text-gray-600 mr-2">Quick filters:</span>
        <mat-chip (click)="applyQuickFilter({status: ['available']})">Available</mat-chip>
        <mat-chip (click)="applyQuickFilter({status: ['occupied']})">Occupied</mat-chip>
        <mat-chip (click)="applyQuickFilter({status: ['maintenance']})">Maintenance</mat-chip>
        <mat-chip (click)="applyQuickFilter({housekeepingStatus: ['dirty']})">Needs Cleaning</mat-chip>
      </div>
    </form>
  </div>

  <!-- Bulk Actions -->
  @if (selectedRooms().length > 0) {
    <div class="bg-blue-50 border-t border-b border-blue-200 p-4">
      <div class="flex justify-between items-center flex-wrap gap-4">
        <span class="text-blue-800 font-semibold">{{ selectedRooms().length }} room(s) selected</span>
        <div class="flex gap-2 flex-wrap">
          <button matButton="tonal" (click)="bulkUpdateStatus('available')">
            <mat-icon>check_circle</mat-icon>
            Mark Available
          </button>
          <button matButton="tonal" (click)="bulkUpdateStatus('maintenance')">
            <mat-icon>build</mat-icon>
            Mark Maintenance
          </button>
          <button matButton="tonal" (click)="bulkUpdateStatus('cleaning')">
            <mat-icon>cleaning_services</mat-icon>
            Mark Cleaning
          </button>
          <button matButton="outlined" (click)="clearSelection()">
            <mat-icon>clear</mat-icon>
            Clear Selection
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Loading Spinner -->
  @if (roomsResource.isLoading()) {
    <div class="flex items-center justify-center py-20">
      <mat-spinner diameter="48"></mat-spinner>
    </div>
  }

  <!-- Table View -->
  @if (viewMode() === 'table' && !roomsResource.isLoading()) {
    <table mat-table [dataSource]="rooms()" class="w-full">

      <!-- Selection Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox 
            [checked]="selectedRooms().length === rooms().length && rooms().length > 0"
            [indeterminate]="selectedRooms().length > 0 && selectedRooms().length < rooms().length"
            (change)="selectedRooms().length === rooms().length ? clearSelection() : selectAllRooms()">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let room">
          <mat-checkbox 
            [checked]="isRoomSelected(room)"
            (change)="toggleRoomSelection(room)">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Room Column -->
      <ng-container matColumnDef="roomNumber">
        <th mat-header-cell *matHeaderCellDef>Room</th>
        <td mat-cell *matCellDef="let room">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
              <mat-icon class="text-white">hotel</mat-icon>
            </div>
            <div>
              <div class="font-semibold">
                @if (room.name) {
                  {{ room.name }}
                  <span class="text-xs text-gray-500 ml-1">({{ room.roomNumber }})</span>
                } @else {
                  {{ room.roomNumber }}
                }
              </div>
              @if (room.floor !== undefined && room.floor !== null) {
                <div class="text-sm text-gray-500">Floor {{ room.floor }}</div>
              }
            </div>
          </div>
        </td>
      </ng-container>

      <!-- Room Type Column -->
      <ng-container matColumnDef="roomType">
        <th mat-header-cell *matHeaderCellDef>Type & Capacity</th>
        <td mat-cell *matCellDef="let room">
          <div class="font-medium">{{ getRoomTypeName(room) }}</div>
          <div class="text-sm text-gray-500">
            @if (room.capacity) {
              {{ room.capacity.adults }}A/{{ room.capacity.children }}C
            } @else if (room.roomType && typeof room.roomType === 'object') {
              {{ room.roomType.capacity.adults }}A/{{ room.roomType.capacity.children }}C
            }
          </div>
        </td>
      </ng-container>

      <!-- Floor Column -->
      <ng-container matColumnDef="floor">
        <th mat-header-cell *matHeaderCellDef>Floor</th>
        <td mat-cell *matCellDef="let room">
          @if (room.floor !== undefined && room.floor !== null) {
            Floor {{ room.floor }}
          } @else {
            -
          }
        </td>
      </ng-container>

      <!-- Price Column -->
      <ng-container matColumnDef="priceOverride">
        <th mat-header-cell *matHeaderCellDef>Price</th>
        <td mat-cell *matCellDef="let room">
          @if (room.priceOverride !== undefined && room.priceOverride !== null) {
            {{ room.priceOverride | currency:storeCurrency():'symbol':'1.2-2' }}
          } @else if (room.roomType?.basePrice) {
            {{ room.roomType.basePrice | currency:storeCurrency():'symbol':'1.2-2' }}
          } @else {
            -
          }
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let room">
          <mat-chip [ngClass]="{
            'bg-green-100! text-green-800!': room.status === 'available',
            'bg-purple-100! text-purple-800!': room.status === 'occupied',
            'bg-orange-100! text-orange-800!': room.status === 'maintenance',
            'bg-cyan-100! text-cyan-800!': room.status === 'cleaning',
            'bg-red-100! text-red-800!': room.status === 'out_of_order'
          }">
            {{ room.status | titlecase }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Housekeeping Status Column -->
      <ng-container matColumnDef="housekeepingStatus">
        <th mat-header-cell *matHeaderCellDef>Housekeeping</th>
        <td mat-cell *matCellDef="let room">
          <mat-chip [ngClass]="{
            'bg-green-100! text-green-800!': room.housekeepingStatus === 'clean',
            'bg-orange-100! text-orange-800!': room.housekeepingStatus === 'dirty',
            'bg-cyan-100! text-cyan-800!': room.housekeepingStatus === 'inspected',
            'bg-red-100! text-red-800!': room.housekeepingStatus === 'out_of_order'
          }">
            {{ room.housekeepingStatus | titlecase }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Features Column -->
      <ng-container matColumnDef="features">
        <th mat-header-cell *matHeaderCellDef>Features</th>
        <td mat-cell *matCellDef="let room">
          <div class="flex flex-wrap gap-1">
            @for (feature of getFeaturesList(room).slice(0, 3); track feature) {
              <mat-chip class="text-xs!">{{ feature }}</mat-chip>
            }
            @if (getFeaturesList(room).length > 3) {
              <mat-chip class="text-xs!">+{{ getFeaturesList(room).length - 3 }}</mat-chip>
            }
          </div>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let room">
          <button mat-icon-button [matMenuTriggerFor]="actionMenu" (click)="$event.stopPropagation()">
            <mat-icon>more_vert</mat-icon>
          </button>

          <mat-menu #actionMenu="matMenu">
            <button mat-menu-item [routerLink]="['./', room._id || room.id]">
              <mat-icon>visibility</mat-icon>
              <span>View Details</span>
            </button>
            <button mat-menu-item [routerLink]="['./', room._id || room.id, 'edit']">
              <mat-icon>edit</mat-icon>
              <span>Edit Room</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="updateRoomStatus(room, 'available')">
              <mat-icon>check_circle</mat-icon>
              <span>Mark Available</span>
            </button>
            <button mat-menu-item (click)="updateRoomStatus(room, 'maintenance')">
              <mat-icon>build</mat-icon>
              <span>Mark Maintenance</span>
            </button>
            <button mat-menu-item (click)="updateHousekeepingStatus(room, 'clean')">
              <mat-icon>cleaning_services</mat-icon>
              <span>Mark Clean</span>
            </button>
            <button mat-menu-item (click)="updateHousekeepingStatus(room, 'dirty')">
              <mat-icon>warning</mat-icon>
              <span>Mark Dirty</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <!-- Header and Row Definitions -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let room; columns: displayedColumns;" class="cursor-pointer hover:bg-gray-50"
        [routerLink]="['./', room._id || room.id]"></tr>
    </table>

    @if (rooms().length === 0) {
      <div class="py-20 text-center">
        <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
          <mat-icon class="text-4xl text-gray-400">hotel</mat-icon>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">No rooms found</h3>
        <p class="text-gray-500 mb-6">Try adjusting your filters or create a new room.</p>
        <button matButton="filled" routerLink="./create">
          <mat-icon>add</mat-icon>
          Add Room
        </button>
      </div>
    }

    <!-- Paginator -->
    @if (rooms().length > 0) {
      <mat-paginator
        [length]="roomsTotal()"
        [pageSize]="pageSize()"
        [pageIndex]="pageIndex()"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    }
  }

  <!-- Grid View -->
  @if (viewMode() === 'grid' && !roomsResource.isLoading()) {
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-4">
      @for (room of rooms(); track room._id || room.id) {
        <mat-card appearance="outlined" class="hover:shadow-lg transition-all duration-300"
             [class.ring-2]="isRoomSelected(room)" 
             [class.ring-blue-500]="isRoomSelected(room)">
          <mat-card-content class="p-4!">
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-start gap-3">
                <mat-checkbox 
                  [checked]="isRoomSelected(room)"
                  (change)="toggleRoomSelection(room)">
                </mat-checkbox>
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <mat-icon class="text-white">hotel</mat-icon>
                  </div>
                  <div>
                    <h3 class="font-bold text-gray-900">
                      @if (room.name) {
                        {{ room.name }}
                        <span class="text-sm text-gray-500 font-normal ml-1">({{ room.roomNumber }})</span>
                      } @else {
                        Room {{ room.roomNumber }}
                      }
                    </h3>
                    <p class="text-sm text-gray-600">{{ getRoomTypeName(room) }}</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="space-y-3 mb-4">
              <!-- Floor & Basic Info -->
              <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                @if (room.floor !== undefined && room.floor !== null) {
                  <div class="flex items-center gap-2">
                    <mat-icon class="text-base text-gray-400">layers</mat-icon>
                    <span>Floor {{ room.floor }}</span>
                  </div>
                }
                
                @if (room.capacity) {
                  <div class="flex items-center gap-2">
                    <mat-icon class="text-base text-gray-400">people</mat-icon>
                    <span>{{ room.capacity.adults }}A/{{ room.capacity.children }}C</span>
                  </div>
                }
              </div>

              <!-- Status -->
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-600">Status</span>
                <mat-chip [ngClass]="{
                  'bg-green-100! text-green-800!': room.status === 'available',
                  'bg-purple-100! text-purple-800!': room.status === 'occupied',
                  'bg-orange-100! text-orange-800!': room.status === 'maintenance',
                  'bg-cyan-100! text-cyan-800!': room.status === 'cleaning',
                  'bg-red-100! text-red-800!': room.status === 'out_of_order'
                }">
                  {{ room.status | titlecase }}
                </mat-chip>
              </div>

              <!-- Housekeeping -->
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-600">Housekeeping</span>
                <mat-chip [ngClass]="{
                  'bg-green-100! text-green-800!': room.housekeepingStatus === 'clean',
                  'bg-orange-100! text-orange-800!': room.housekeepingStatus === 'dirty',
                  'bg-cyan-100! text-cyan-800!': room.housekeepingStatus === 'inspected',
                  'bg-red-100! text-red-800!': room.housekeepingStatus === 'out_of_order'
                }">
                  {{ room.housekeepingStatus | titlecase }}
                </mat-chip>
              </div>

              @if (getFeaturesList(room).length > 0) {
                <div class="pt-3 border-t border-gray-100">
                  <div class="text-sm font-medium text-gray-600 mb-2">Features:</div>
                  <div class="flex flex-wrap gap-1">
                    @for (feature of getFeaturesList(room).slice(0, 4); track feature) {
                      <mat-chip class="text-xs!">{{ feature }}</mat-chip>
                    }
                    @if (getFeaturesList(room).length > 4) {
                      <mat-chip class="text-xs!">+{{ getFeaturesList(room).length - 4 }}</mat-chip>
                    }
                  </div>
                </div>
              }
            </div>

            <div class="flex gap-2 pt-4 border-t border-gray-100">
              <button matButton="filled" class="flex-1!" [routerLink]="['./', room._id || room.id]">
                <mat-icon>visibility</mat-icon>
                View
              </button>
              <button matButton="outlined" class="flex-1!" [routerLink]="['./', room._id || room.id, 'edit']">
                <mat-icon>edit</mat-icon>
                Edit
              </button>
            </div>
          </mat-card-content>
        </mat-card>
      }

      @if (rooms().length === 0) {
        <div class="col-span-full py-20 text-center">
          <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
            <mat-icon class="text-4xl text-gray-400">hotel</mat-icon>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">No rooms found</h3>
          <p class="text-gray-500 mb-6">Try adjusting your filters or create a new room.</p>
          <button matButton="filled" routerLink="./create">
            <mat-icon>add</mat-icon>
            Add Room
          </button>
        </div>
      }
    </div>

    <!-- Paginator for Grid View -->
    @if (rooms().length > 0) {
      <mat-paginator
        [length]="roomsTotal()"
        [pageSize]="pageSize()"
        [pageIndex]="pageIndex()"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    }
  }

  <!-- Error State -->
  @if (roomsResource.error()) {
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 m-4">
      <div class="flex">
        <mat-icon class="text-red-500 mr-2">error</mat-icon>
        <div>
          <h3 class="text-red-800 font-medium">Error loading rooms</h3>
          <p class="text-red-700 text-sm mt-1">{{ roomsResource.error() }}</p>
          <div class="mt-3 flex space-x-3">
            <button mat-button color="warn" (click)="roomsResource.reload()" class="!text-red-600">
              <mat-icon class="mr-1">refresh</mat-icon>
              Retry
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</mat-card>