<app-page-header [title]="formTitle()" [subtitle]="isEditMode() ? 'Update room type information and settings' : 'Configure a new room type for your hotel'">
  <ng-container actions>
    <button mat-stroked-button (click)="onCancel()" [disabled]="saving()">
      <mat-icon>close</mat-icon>
      Cancel
    </button>

    <button mat-flat-button color="primary" type="submit" form="roomTypeForm" [disabled]="saving() || loading()">
      @if (saving()) {
        <mat-spinner diameter="20"></mat-spinner>
      } @else {
        <mat-icon>save</mat-icon>
      }
      {{ submitButtonText() }}
    </button>
  </ng-container>
</app-page-header>

<!-- Loading State -->
@if (loading()) {
  <div class="flex justify-center items-center py-16">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
}

<!-- Error State -->
@if (error() && !loading()) {
  <mat-card appearance="outlined" class="m-6 bg-red-50!">
    <mat-card-content class="p-6! text-center">
      <div class="w-16 h-16 bg-red-200 rounded-full flex items-center justify-center mx-auto mb-4">
        <mat-icon class="text-4xl text-red-500">error</mat-icon>
      </div>
      <h3 class="text-lg font-semibold text-red-900 mb-2">Error Loading Room Type</h3>
      <p class="text-red-700 mb-4">{{ error() }}</p>
      <button mat-flat-button color="warn" (click)="onCancel()">
        <mat-icon>arrow_back</mat-icon>
        Go Back
      </button>
    </mat-card-content>
  </mat-card>
}

<!-- Form Content -->
@if (!loading() && !error()) {
  <div class="max-w-4xl mx-auto py-8">
    <form id="roomTypeForm" [formGroup]="roomTypeForm()" (ngSubmit)="onSubmit()" class="space-y-6">

      <!-- Basic Information Section -->
      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-icon mat-card-avatar class="text-blue-600">info</mat-icon>
          <mat-card-title>Basic Information</mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-6! space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Room Type Name -->
            <div class="md:col-span-2">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Room Type Name *</mat-label>
                <input matInput formControlName="name" placeholder="e.g., Deluxe Ocean View">
                <mat-icon matSuffix class="text-gray-400">hotel_class</mat-icon>
                @if (hasError('name', 'required')) {
                  <mat-error>Room type name is required</mat-error>
                }
                @if (hasError('name', 'minlength')) {
                  <mat-error>Name must be at least 2 characters</mat-error>
                }
                @if (hasError('name', 'maxlength')) {
                  <mat-error>Name must not exceed 100 characters</mat-error>
                }
              </mat-form-field>
            </div>

            <!-- Description -->
            <div class="md:col-span-2">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Description</mat-label>
                <textarea matInput formControlName="description" rows="3" placeholder="Describe the room type features and highlights..."></textarea>
                @if (hasError('description', 'maxlength')) {
                  <mat-error>Description must not exceed 500 characters</mat-error>
                }
              </mat-form-field>
            </div>

            <!-- Base Price -->
            <div>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Base Price per Night *</mat-label>
                <span matPrefix>$&nbsp;</span>
                <input matInput type="number" formControlName="basePrice" min="0" step="0.01">
                @if (hasError('basePrice', 'required')) {
                  <mat-error>Base price is required</mat-error>
                }
                @if (hasError('basePrice', 'min')) {
                  <mat-error>Price must be greater than 0</mat-error>
                }
              </mat-form-field>
            </div>

            <!-- Room Size -->
            <div>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Room Size (sq ft)</mat-label>
                <input matInput type="number" formControlName="size" min="0">
                <mat-icon matSuffix class="text-gray-400">fullscreen</mat-icon>
              </mat-form-field>
            </div>

            <!-- Bed Configuration -->
            <div>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Bed Configuration</mat-label>
                <mat-select formControlName="bedConfiguration">
                  <mat-option value="">Select bed configuration</mat-option>
                  @for (config of bedConfigurations; track config) {
                    <mat-option [value]="config">{{ config }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

            <!-- Sort Order -->
            <div>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Sort Order</mat-label>
                <input matInput type="number" formControlName="sortOrder" min="0">
                <mat-icon matSuffix class="text-gray-400">sort</mat-icon>
                <mat-hint>Lower numbers appear first</mat-hint>
              </mat-form-field>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Capacity & Occupancy Section -->
      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-icon mat-card-avatar class="text-green-600">people</mat-icon>
          <mat-card-title>Capacity & Occupancy</mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-6! space-y-6">
          <div formGroupName="capacity" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Adults -->
            <div>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Adults *</mat-label>
                <input matInput type="number" formControlName="adults" min="1" max="10" (change)="onCapacityChange()">
                <mat-icon matSuffix class="text-gray-400">person</mat-icon>
                @if (hasError('capacity.adults', 'required')) {
                  <mat-error>Number of adults is required</mat-error>
                }
                @if (hasError('capacity.adults', 'min')) {
                  <mat-error>At least 1 adult required</mat-error>
                }
                @if (hasError('capacity.adults', 'max')) {
                  <mat-error>Maximum 10 adults allowed</mat-error>
                }
              </mat-form-field>
            </div>

            <!-- Children -->
            <div>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Children</mat-label>
                <input matInput type="number" formControlName="children" min="0" max="10" (change)="onCapacityChange()">
                <mat-icon matSuffix class="text-gray-400">child_care</mat-icon>
                @if (hasError('capacity.children', 'min')) {
                  <mat-error>Cannot be negative</mat-error>
                }
                @if (hasError('capacity.children', 'max')) {
                  <mat-error>Maximum 10 children allowed</mat-error>
                }
              </mat-form-field>
            </div>

            <!-- Infants -->
            <div>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Infants</mat-label>
                <input matInput type="number" formControlName="infants" min="0" max="5" (change)="onCapacityChange()">
                <mat-icon matSuffix class="text-gray-400">baby_changing_station</mat-icon>
                @if (hasError('capacity.infants', 'min')) {
                  <mat-error>Cannot be negative</mat-error>
                }
                @if (hasError('capacity.infants', 'max')) {
                  <mat-error>Maximum 5 infants allowed</mat-error>
                }
              </mat-form-field>
            </div>
          </div>

          <!-- Total Capacity Display -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center gap-2 text-blue-800">
              <mat-icon>info</mat-icon>
              <span class="font-medium">Total Base Capacity: {{ totalCapacity() }} guests</span>
            </div>
          </div>

          <!-- Maximum Occupancy -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Maximum Occupancy *</mat-label>
                <input matInput type="number" formControlName="maxOccupancy" min="1" max="20">
                <mat-icon matSuffix class="text-gray-400">groups</mat-icon>
                <mat-hint>Total guests including extra beds</mat-hint>
                @if (hasError('maxOccupancy', 'required')) {
                  <mat-error>Maximum occupancy is required</mat-error>
                }
                @if (hasError('maxOccupancy', 'min')) {
                  <mat-error>At least 1 guest required</mat-error>
                }
                @if (hasError('maxOccupancy', 'max')) {
                  <mat-error>Maximum 20 guests allowed</mat-error>
                }
              </mat-form-field>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Room Status Section -->
      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-icon mat-card-avatar class="text-purple-600">toggle_on</mat-icon>
          <mat-card-title>Room Type Status</mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-6! space-y-6">
          <div class="flex items-center">
            <mat-checkbox formControlName="active" class="text-green-600">
              <span class="flex items-center gap-2">
                <mat-icon class="text-lg text-gray-600">check_circle</mat-icon>
                <span>
                  <span class="font-medium">Active Room Type</span>
                  <span class="text-sm text-gray-500 ml-2">Available for booking</span>
                </span>
              </span>
            </mat-checkbox>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Room Features Section -->
      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-icon mat-card-avatar class="text-amber-600">star</mat-icon>
          <mat-card-title>Room Features</mat-card-title>
          <mat-card-subtitle>Select the features available in this room type</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content class="p-6! space-y-6">
          <div formGroupName="features" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="flex items-center">
              <mat-checkbox formControlName="hasPrivateBathroom" class="text-blue-600">
                <span class="flex items-center gap-2">
                  <mat-icon class="text-lg text-gray-600">bathroom</mat-icon>
                  Private Bathroom
                </span>
              </mat-checkbox>
            </div>
            
            <div class="flex items-center">
              <mat-checkbox formControlName="hasAirConditioning" class="text-blue-600">
                <span class="flex items-center gap-2">
                  <mat-icon class="text-lg text-gray-600">ac_unit</mat-icon>
                  Air Conditioning
                </span>
              </mat-checkbox>
            </div>
            
            <div class="flex items-center">
              <mat-checkbox formControlName="hasWifi" class="text-blue-600">
                <span class="flex items-center gap-2">
                  <mat-icon class="text-lg text-gray-600">wifi</mat-icon>
                  WiFi
                </span>
              </mat-checkbox>
            </div>
            
            <div class="flex items-center">
              <mat-checkbox formControlName="hasTv" class="text-blue-600">
                <span class="flex items-center gap-2">
                  <mat-icon class="text-lg text-gray-600">tv</mat-icon>
                  Television
                </span>
              </mat-checkbox>
            </div>
            
            <div class="flex items-center">
              <mat-checkbox formControlName="hasRefrigerator" class="text-blue-600">
                <span class="flex items-center gap-2">
                  <mat-icon class="text-lg text-gray-600">kitchen</mat-icon>
                  Refrigerator
                </span>
              </mat-checkbox>
            </div>
            
            <div class="flex items-center">
              <mat-checkbox formControlName="hasBalcony" class="text-blue-600">
                <span class="flex items-center gap-2">
                  <mat-icon class="text-lg text-gray-600">balcony</mat-icon>
                  Balcony
                </span>
              </mat-checkbox>
            </div>
            
            <div class="flex items-center">
              <mat-checkbox formControlName="hasKitchenette" class="text-blue-600">
                <span class="flex items-center gap-2">
                  <mat-icon class="text-lg text-gray-600">countertops</mat-icon>
                  Kitchenette
                </span>
              </mat-checkbox>
            </div>
            
            <div class="flex items-center">
              <mat-checkbox formControlName="hasWorkDesk" class="text-blue-600">
                <span class="flex items-center gap-2">
                  <mat-icon class="text-lg text-gray-600">desk</mat-icon>
                  Work Desk
                </span>
              </mat-checkbox>
            </div>
            
            <div class="flex items-center">
              <mat-checkbox formControlName="hasSafe" class="text-blue-600">
                <span class="flex items-center gap-2">
                  <mat-icon class="text-lg text-gray-600">lock</mat-icon>
                  Safe
                </span>
              </mat-checkbox>
            </div>
            
            <div class="flex items-center">
              <mat-checkbox formControlName="hasHairdryer" class="text-blue-600">
                <span class="flex items-center gap-2">
                  <mat-icon class="text-lg text-gray-600">dry</mat-icon>
                  Hair Dryer
                </span>
              </mat-checkbox>
            </div>
            
            <div class="flex items-center">
              <mat-checkbox formControlName="hasIroning" class="text-blue-600">
                <span class="flex items-center gap-2">
                  <mat-icon class="text-lg text-gray-600">iron</mat-icon>
                  Iron & Board
                </span>
              </mat-checkbox>
            </div>
            
            <div class="flex items-center">
              <mat-checkbox formControlName="hasSeatingArea" class="text-blue-600">
                <span class="flex items-center gap-2">
                  <mat-icon class="text-lg text-gray-600">weekend</mat-icon>
                  Seating Area
                </span>
              </mat-checkbox>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Amenities Section -->
      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-icon mat-card-avatar class="text-indigo-600">room_service</mat-icon>
          <mat-card-title>Amenities</mat-card-title>
          <mat-card-subtitle>Select the amenities included with this room type</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content class="p-6! space-y-6">
          <!-- Selected Amenities Display -->
          @if (amenitiesFormArray.controls.length > 0 || customAmenitiesFormArray.controls.length > 0) {
            <div>
              <h4 class="text-sm font-medium text-gray-700 mb-3">Selected Amenities ({{ amenitiesFormArray.controls.length + customAmenitiesFormArray.controls.length }})</h4>
              <div class="flex flex-wrap gap-2">
                @for (control of amenitiesFormArray.controls; track $index) {
                  <div class="flex items-center gap-2 bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                    <span>{{ control.value }}</span>
                    <button type="button" (click)="onAmenityChange(control.value, false)" class="hover:text-blue-600">
                      <mat-icon class="text-sm">close</mat-icon>
                    </button>
                  </div>
                }
                @for (control of customAmenitiesFormArray.controls; track $index) {
                  <div class="flex items-center gap-2 bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">
                    <span>{{ control.value }}</span>
                    <button type="button" (click)="removeCustomAmenity($index)" class="hover:text-purple-600">
                      <mat-icon class="text-sm">close</mat-icon>
                    </button>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Common Amenities -->
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-3">Common Amenities</h4>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
              @for (amenity of commonAmenities; track amenity) {
                <button 
                  type="button"
                  (click)="onAmenityChange(amenity, !isAmenitySelected(amenity))"
                  [class]="isAmenitySelected(amenity) ? 
                    'bg-blue-100 text-blue-800 border-blue-300' : 
                    'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'"
                  class="flex items-center justify-center p-3 border rounded-lg text-sm font-medium transition-all duration-200">
                  {{ amenity }}
                </button>
              }
            </div>
          </div>

          <mat-divider class="!my-6"></mat-divider>

          <!-- Custom Amenities -->
          <div>
            <h4 class="text-sm font-medium text-gray-700 mb-3">Add Custom Amenity</h4>
            <div class="flex gap-2">
              <mat-form-field appearance="outline" class="flex-1">
                <mat-label>Custom Amenity Name</mat-label>
                <input matInput #customAmenityInput placeholder="Enter custom amenity">
              </mat-form-field>
              <button 
                type="button" 
                mat-flat-button 
                color="primary"
                (click)="addCustomAmenity(customAmenityInput.value); customAmenityInput.value = ''"
                class="h-14">
                <mat-icon>add</mat-icon>
                Add
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

    </form>
  </div>
}