<app-page-header title="Occupancy Report" subtitle="Monitor room occupancy rates, availability, and revenue trends">
  <ng-container actions>
    <button mat-stroked-button (click)="refreshData()" [disabled]="loading()">
      @if (loading()) {
        <mat-spinner diameter="18"></mat-spinner>
      } @else {
        <mat-icon>refresh</mat-icon>
      }
      {{ loading() ? 'Loading...' : 'Refresh' }}
    </button>
    
    <button mat-flat-button color="primary" [matMenuTriggerFor]="exportMenu">
      <mat-icon>download</mat-icon>
      Export
      <mat-icon iconPositionEnd>arrow_drop_down</mat-icon>
    </button>
    <mat-menu #exportMenu="matMenu">
      <button mat-menu-item (click)="exportToCSV()">
        <mat-icon>table_chart</mat-icon>
        <span>Export to CSV</span>
      </button>
      <button mat-menu-item (click)="exportToPDF()">
        <mat-icon>picture_as_pdf</mat-icon>
        <span>Export to PDF</span>
      </button>
    </mat-menu>
  </ng-container>
</app-page-header>

<!-- Loading State -->
@if (loading()) {
  <div class="flex justify-center items-center py-16">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
}

<!-- Error State -->
@if (error() && !loading()) {
  <mat-card appearance="outlined" class="m-6 bg-red-50!">
    <mat-card-content class="p-6! text-center">
      <div class="w-16 h-16 bg-red-200 rounded-full flex items-center justify-center mx-auto mb-4">
        <mat-icon class="text-4xl text-red-500">error</mat-icon>
      </div>
      <h3 class="text-lg font-semibold text-red-900 mb-2">Error Loading Data</h3>
      <p class="text-red-700 mb-4">{{ error() }}</p>
      <button mat-flat-button color="warn" (click)="clearError()">
        <mat-icon>close</mat-icon>
        Dismiss
      </button>
    </mat-card-content>
  </mat-card>
}

<!-- Main Content -->
@if (!loading() && !error()) {
  <div class="p-6 space-y-6">
    
    <!-- Filters Section -->
    <mat-card appearance="outlined">
      <mat-card-header>
        <mat-icon mat-card-avatar class="text-purple-600">filter_list</mat-icon>
        <mat-card-title>Report Filters</mat-card-title>
      </mat-card-header>
      <mat-card-content class="p-6!">
        <form [formGroup]="filterForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
          
          <!-- Start Date -->
          <mat-form-field appearance="outline">
            <mat-label>Start Date</mat-label>
            <input matInput [matDatepicker]="startPicker" formControlName="startDate" (dateChange)="onDateRangeChange()">
            <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>

          <!-- End Date -->
          <mat-form-field appearance="outline">
            <mat-label>End Date</mat-label>
            <input matInput [matDatepicker]="endPicker" formControlName="endDate" (dateChange)="onDateRangeChange()">
            <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>

          <!-- Report Type -->
          <mat-form-field appearance="outline">
            <mat-label>Report Type</mat-label>
            <mat-select formControlName="reportType" (selectionChange)="onFilterChange()">
              <mat-option value="daily">Daily</mat-option>
              <mat-option value="weekly">Weekly</mat-option>
              <mat-option value="monthly">Monthly</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Room Type -->
          <mat-form-field appearance="outline">
            <mat-label>Room Type</mat-label>
            <mat-select formControlName="roomType" (selectionChange)="onFilterChange()">
              <mat-option value="all">All Room Types</mat-option>
              <mat-option value="standard">Standard</mat-option>
              <mat-option value="deluxe">Deluxe</mat-option>
              <mat-option value="suite">Suite</mat-option>
              <mat-option value="presidential">Presidential</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Floor Number -->
          <mat-form-field appearance="outline">
            <mat-label>Floor</mat-label>
            <mat-select formControlName="floorNumber" (selectionChange)="onFilterChange()">
              <mat-option value="all">All Floors</mat-option>
              <mat-option value="1">Floor 1</mat-option>
              <mat-option value="2">Floor 2</mat-option>
              <mat-option value="3">Floor 3</mat-option>
              <mat-option value="4">Floor 4</mat-option>
              <mat-option value="5">Floor 5</mat-option>
            </mat-select>
          </mat-form-field>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Statistics Cards -->
    @if (occupancyStats()) {
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        
        <!-- Current Occupancy -->
        <mat-card appearance="outlined" >
          <mat-card-content class="p-4!">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-medium text-blue-600 uppercase tracking-wide">Current Occupancy</p>
                <p class="text-2xl font-bold text-blue-900">{{ formatPercent(occupancyStats()!.currentOccupancyRate) }}</p>
              </div>
              <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                <mat-icon class="text-white">hotel</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Total Rooms -->
        <mat-card appearance="outlined">
          <mat-card-content class="p-4!">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-medium text-purple-600 uppercase tracking-wide">Total Rooms</p>
                <p class="text-2xl font-bold text-purple-900">{{ occupancyStats()!.totalRooms }}</p>
              </div>
              <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center">
                <mat-icon class="text-white">meeting_room</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Occupied Rooms -->
        <mat-card appearance="outlined">
          <mat-card-content class="p-4!">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-medium text-red-600 uppercase tracking-wide">Occupied</p>
                <p class="text-2xl font-bold text-red-900">{{ occupancyStats()!.currentOccupied }}</p>
              </div>
              <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center">
                <mat-icon class="text-white">people</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Available Rooms -->
        <mat-card appearance="outlined">
          <mat-card-content class="p-4!">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-medium text-green-600 uppercase tracking-wide">Available</p>
                <p class="text-2xl font-bold text-green-900">{{ occupancyStats()!.currentAvailable }}</p>
              </div>
              <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                <mat-icon class="text-white">check_circle</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Average Occupancy -->
        <mat-card appearance="outlined">
          <mat-card-content class="p-4!">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-medium text-orange-600 uppercase tracking-wide">Avg Occupancy</p>
                <p class="text-2xl font-bold text-orange-900">{{ formatPercent(occupancyStats()!.averageOccupancyRate) }}</p>
              </div>
              <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center">
                <mat-icon class="text-white">trending_up</mat-icon>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Total Revenue -->
        <mat-card appearance="outlined">
          <mat-card-content class="p-4!">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-medium text-teal-600 uppercase tracking-wide">Total Revenue</p>
                <p class="text-2xl font-bold text-teal-900">{{ occupancyStats()!.totalRevenue | currency:currency():'symbol':'1.0-0' }}</p>
              </div>
              
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    }

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      
      <!-- Occupancy Trend Chart -->
      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-icon mat-card-avatar class="text-blue-600">show_chart</mat-icon>
          <mat-card-title>Occupancy Trend</mat-card-title>
          <mat-card-subtitle>Room occupancy and availability over time</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content class="p-6!">
          <div class="h-80">
            <canvas
              baseChart
              [data]="occupancyChartData()"
              [options]="occupancyChartOptions"
              type="line">
            </canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Revenue Chart -->
      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-icon mat-card-avatar class="text-purple-600">bar_chart</mat-icon>
          <mat-card-title>Daily Revenue</mat-card-title>
          <mat-card-subtitle>Revenue generated from room bookings</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content class="p-6!">
          <div class="h-80">
            <canvas
              baseChart
              [data]="revenueChartData()"
              [options]="revenueChartOptions"
              type="bar">
            </canvas>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Detailed Data Table -->
    <mat-card appearance="outlined">
      <mat-card-header>
        <mat-icon mat-card-avatar class="text-indigo-600">table_chart</mat-icon>
        <mat-card-title>Detailed Occupancy Data</mat-card-title>
        <mat-card-subtitle>Day-by-day breakdown of occupancy metrics</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content class="p-0!">
        <div class="overflow-x-auto">
          <table mat-table [dataSource]="occupancyData()" class="w-full">
            
            <!-- Date Column -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef>Date</th>
              <td mat-cell *matCellDef="let row" class="font-medium">{{ formatDate(row.date) }}</td>
            </ng-container>

            <!-- Total Rooms Column -->
            <ng-container matColumnDef="totalRooms">
              <th mat-header-cell *matHeaderCellDef>Total Rooms</th>
              <td mat-cell *matCellDef="let row">{{ row.totalRooms }}</td>
            </ng-container>

            <!-- Occupied Rooms Column -->
            <ng-container matColumnDef="occupiedRooms">
              <th mat-header-cell *matHeaderCellDef>Occupied</th>
              <td mat-cell *matCellDef="let row">
                <span class="text-red-600 font-medium">{{ row.occupiedRooms }}</span>
              </td>
            </ng-container>

            <!-- Available Rooms Column -->
            <ng-container matColumnDef="availableRooms">
              <th mat-header-cell *matHeaderCellDef>Available</th>
              <td mat-cell *matCellDef="let row">
                <span class="text-green-600 font-medium">{{ row.availableRooms }}</span>
              </td>
            </ng-container>

            <!-- Occupancy Rate Column -->
            <ng-container matColumnDef="occupancyRate">
              <th mat-header-cell *matHeaderCellDef>Occupancy Rate</th>
              <td mat-cell *matCellDef="let row">
                <mat-chip [class]="getOccupancyRateClass(row.occupancyRate)">
                  {{ formatPercent(row.occupancyRate) }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Revenue Column -->
            <ng-container matColumnDef="revenue">
              <th mat-header-cell *matHeaderCellDef>Revenue</th>
              <td mat-cell *matCellDef="let row">
                <span class="text-purple-600 font-medium">{{ row.revenue | currency:currency():'symbol':'1.2-2' }}</span>
              </td>
            </ng-container>

            <!-- Average Rate Column -->
            <ng-container matColumnDef="averageRate">
              <th mat-header-cell *matHeaderCellDef>Avg Rate</th>
              <td mat-cell *matCellDef="let row">{{ row.averageRate | currency:currency():'symbol':'1.2-2' }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover:bg-gray-50"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Room Status Grid -->
    <mat-card appearance="outlined">
      <mat-card-header>
        <mat-icon mat-card-avatar class="text-amber-600">grid_view</mat-icon>
        <mat-card-title>Current Room Status</mat-card-title>
        <mat-card-subtitle>Real-time status of all rooms</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content class="p-6!">
        <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 xl:grid-cols-12 gap-3 mb-6">
          @for (room of roomStatuses(); track room.roomNumber) {
            <div 
              class="relative p-3 rounded-lg border-2 text-center text-sm font-medium transition-all duration-200 hover:scale-105 cursor-pointer"
              [class]="getRoomStatusClass(room.status)"
              [matTooltip]="room.status === 'occupied' ? 
                'Guest: ' + (room.guestName || 'N/A') + ' | Check-in: ' + formatDateTime(room.checkIn) + ' | Rate: ' + formatCurrency(room.rate || 0) :
                'Room Type: ' + room.roomType + ' | Status: ' + (room.status | titlecase)">
              
              <div class="text-lg font-bold">{{ room.roomNumber }}</div>
              <div class="text-xs opacity-75">{{ room.roomType }}</div>
              
              <!-- Status Icon -->
              <div class="absolute top-1 right-1">
                <mat-icon class="text-sm">{{ getRoomStatusIcon(room.status) }}</mat-icon>
              </div>
            </div>
          }
        </div>

        <mat-divider class="!mb-4"></mat-divider>

        <!-- Room Status Legend -->
        <div class="flex flex-wrap gap-4 text-sm">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded bg-red-100 border border-red-300"></div>
            <span class="text-gray-700">Occupied</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded bg-green-100 border border-green-300"></div>
            <span class="text-gray-700">Available</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded bg-gray-100 border border-gray-300"></div>
            <span class="text-gray-700">Out of Order</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded bg-yellow-100 border border-yellow-300"></div>
            <span class="text-gray-700">Maintenance</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Last Updated Info -->
    <div class="text-center text-sm text-gray-500">
      <mat-icon class="text-base align-text-bottom mr-1">schedule</mat-icon>
      Last updated: {{ lastUpdated() | date:'medium' }}
    </div>

  </div>
}