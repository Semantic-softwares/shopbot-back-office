<div class="p-6 min-h-screen">
  <!-- Header Section -->
  <app-page-header
    title="Guest Report"
    subtitle="Track and analyze guest occupancy patterns and trends">
     <ng-container actions>
    <button matButton="outlined" (click)="loadData()" [disabled]="loading()">
      <mat-icon>refresh</mat-icon>
      Refresh
    </button>
    <button matButton="filled" color="primary"  [matMenuTriggerFor]="exportMenu">
      <mat-icon>file_download</mat-icon>
      Export
    </button>
    <mat-menu #exportMenu="matMenu">
      <button mat-menu-item (click)="exportData('pdf')">
        <mat-icon>picture_as_pdf</mat-icon>
        <span>Export as PDF</span>
      </button>
      <button mat-menu-item (click)="exportData('csv')">
        <mat-icon>description</mat-icon>
        <span>Export as CSV</span>
      </button>
      <button mat-menu-item (click)="exportData('excel')">
        <mat-icon>table_chart</mat-icon>
        <span>Export as Excel</span>
      </button>
    </mat-menu>
    </ng-container>
  </app-page-header>

  <!-- Error Alert -->
  @if (error()) {
    <mat-card appearance="outlined" class="mb-6 border-yellow-200 bg-yellow-50">
      <mat-card-content class="flex items-center gap-3 py-3">
        <mat-icon class="text-yellow-600">warning</mat-icon>
        <span class="flex-1 text-yellow-700">{{ error() }}</span>
        <button mat-icon-button (click)="clearError()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-card-content>
    </mat-card>
  }

  <!-- Filters Section -->
  <mat-card appearance="outlined" class="mb-6">
    <mat-card-header>
      <mat-card-title>Report Filters</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="filterForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mt-4">
        <!-- Start Date -->
        <mat-form-field appearance="outline">
          <mat-label>Start Date</mat-label>
          <input matInput [matDatepicker]="startPicker" formControlName="startDate">
          <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <!-- End Date -->
        <mat-form-field appearance="outline">
          <mat-label>End Date</mat-label>
          <input matInput [matDatepicker]="endPicker" formControlName="endDate">
          <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>

        <!-- Report Type -->
        <mat-form-field appearance="outline">
          <mat-label>Report Type</mat-label>
          <mat-select formControlName="reportType">
            <mat-option value="daily">Daily</mat-option>
            <mat-option value="weekly">Weekly</mat-option>
            <mat-option value="monthly">Monthly</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Guest Type Filter -->
        <mat-form-field appearance="outline">
          <mat-label>Guest Type</mat-label>
          <mat-select formControlName="guestType">
            <mat-option value="all">All Types</mat-option>
            <mat-option value="business">Business</mat-option>
            <mat-option value="leisure">Leisure</mat-option>
            <mat-option value="group">Group</mat-option>
            <mat-option value="extended">Extended Stay</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Room Type Filter -->
        <mat-form-field appearance="outline">
          <mat-label>Room Type</mat-label>
          <mat-select formControlName="roomType">
            <mat-option value="all">All Rooms</mat-option>
            <mat-option value="standard">Standard</mat-option>
            <mat-option value="deluxe">Deluxe</mat-option>
            <mat-option value="suite">Suite</mat-option>
            <mat-option value="executive">Executive</mat-option>
          </mat-select>
        </mat-form-field>
      </form>
    </mat-card-content>
  </mat-card>

  @if (guestStats()) {
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
      <!-- Total Guests Card -->
      <mat-card appearance="outlined">
        <mat-card-content class="p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Total Guests</p>
              <p class="text-2xl font-bold text-gray-900">{{ formatNumber(guestStats()!.totalGuests) }}</p>
              @if (guestStats()!.guestGrowth !== 0) {
                <p class="text-sm mt-1 flex items-center gap-1" [ngClass]="getGrowthClass(guestStats()!.guestGrowth)">
                  <mat-icon class="text-sm !w-4 !h-4">{{ getGrowthIcon(guestStats()!.guestGrowth) }}</mat-icon>
                  @if (guestStats()!.guestGrowth > 0) {
                    <span>+{{ formatPercent(guestStats()!.guestGrowth) }}</span>
                  } @else {
                    <span>{{ formatPercent(guestStats()!.guestGrowth) }}</span>
                  }
                </p>
              }
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
              <mat-icon class="text-blue-600">groups</mat-icon>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Check-ins Card -->
      <mat-card appearance="outlined">
        <mat-card-content class="p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Total Check-ins</p>
              <p class="text-2xl font-bold text-gray-900">{{ formatNumber(guestStats()!.totalCheckIns) }}</p>
              <p class="text-sm text-gray-600 mt-1">
                Check-outs: {{ formatNumber(guestStats()!.totalCheckOuts) }}
              </p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
              <mat-icon class="text-green-600">login</mat-icon>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Average Stay Duration Card -->
      <mat-card appearance="outlined">
        <mat-card-content class="p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Avg Stay Duration</p>
              <p class="text-2xl font-bold text-gray-900">{{ formatDuration(guestStats()!.averageStayDuration) }}</p>
              <p class="text-sm text-gray-600 mt-1">
                Occupancy: {{ formatPercent(guestStats()!.occupancyRate) }}
              </p>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
              <mat-icon class="text-purple-600">schedule</mat-icon>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Monthly Projection Card -->
      <mat-card appearance="outlined">
        <mat-card-content class="p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Monthly Projection</p>
              <p class="text-2xl font-bold text-gray-900">{{ formatNumber(guestStats()!.monthlyProjection) }}</p>
              <p class="text-sm text-gray-600 mt-1">Based on current trends</p>
            </div>
            <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
              <mat-icon class="text-orange-600">trending_up</mat-icon>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Guest Trend Chart -->
      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-card-title>Guest Trends</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (guestData().length > 0) {
            <div class="h-80">
              <canvas 
                baseChart
                [data]="guestTrendChartData()"
                [options]="chartOptions()"
                type="line">
              </canvas>
            </div>
          } @else {
            <div class="h-80 flex items-center justify-center text-gray-500">
              <div class="text-center">
                <mat-icon class="!w-12 !h-12 !text-5xl text-gray-400">bar_chart</mat-icon>
                <p class="mt-2">No guest data available</p>
              </div>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Guest Type Breakdown Chart -->
      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-card-title>Guest Type Breakdown</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (guestBreakdown().length > 0) {
            <div class="h-80">
              <canvas 
                baseChart
                [data]="guestBreakdownChartData()"
                [options]="doughnutChartOptions()"
                type="doughnut">
              </canvas>
            </div>
          } @else {
            <div class="h-80 flex items-center justify-center text-gray-500">
              <div class="text-center">
                <mat-icon class="!w-12 !h-12 !text-5xl text-gray-400">pie_chart</mat-icon>
                <p class="mt-2">No breakdown data available</p>
              </div>
            </div>
          }
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Guest Type Breakdown Table -->
    @if (guestBreakdown().length > 0) {
      <mat-card appearance="outlined" class="mb-6">
        <mat-card-header>
          <mat-card-title>Guest Type Details</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="guestBreakdown()" class="w-full">
            <!-- Category Column -->
            <ng-container matColumnDef="category">
              <th mat-header-cell *matHeaderCellDef>Guest Type</th>
              <td mat-cell *matCellDef="let item">{{ item.category }}</td>
            </ng-container>

            <!-- Count Column -->
            <ng-container matColumnDef="count">
              <th mat-header-cell *matHeaderCellDef>Count</th>
              <td mat-cell *matCellDef="let item">{{ formatNumber(item.value) }}</td>
            </ng-container>

            <!-- Percentage Column -->
            <ng-container matColumnDef="percentage">
              <th mat-header-cell *matHeaderCellDef>Percentage</th>
              <td mat-cell *matCellDef="let item">
                <div class="flex items-center gap-2">
                  <mat-progress-bar 
                    mode="determinate" 
                    [value]="item.percentage"
                    class="w-20">
                  </mat-progress-bar>
                  <span>{{ formatPercent(item.percentage) }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Avg Stay Column -->
            <ng-container matColumnDef="avgStay">
              <th mat-header-cell *matHeaderCellDef>Avg Stay Duration</th>
              <td mat-cell *matCellDef="let item">{{ formatDuration(item.averageStay) }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="breakdownColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: breakdownColumns;" class="hover:bg-gray-50"></tr>
          </table>
        </mat-card-content>
      </mat-card>
    }

    <!-- Daily Guest Data Table -->
    @if (guestData().length > 0) {
      <mat-card appearance="outlined">
        <mat-card-header>
          <mat-card-title>Daily Guest Data</mat-card-title>
          <mat-card-subtitle>{{ guestData().length }} records found</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="overflow-x-auto">
            <table mat-table [dataSource]="guestData()" class="w-full">
              <!-- Date Column -->
              <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef>Date</th>
                <td mat-cell *matCellDef="let item">{{ formatDate(item.date) }}</td>
              </ng-container>

              <!-- Total Guests Column -->
              <ng-container matColumnDef="totalGuests">
                <th mat-header-cell *matHeaderCellDef>Total Guests</th>
                <td mat-cell *matCellDef="let item" class="font-medium">{{ formatNumber(item.totalGuests) }}</td>
              </ng-container>

              <!-- New Guests Column -->
              <ng-container matColumnDef="newGuests">
                <th mat-header-cell *matHeaderCellDef>New Guests</th>
                <td mat-cell *matCellDef="let item">{{ formatNumber(item.newGuests) }}</td>
              </ng-container>

              <!-- Returning Guests Column -->
              <ng-container matColumnDef="returningGuests">
                <th mat-header-cell *matHeaderCellDef>Returning Guests</th>
                <td mat-cell *matCellDef="let item">{{ formatNumber(item.returningGuests) }}</td>
              </ng-container>

              <!-- Check-ins Column -->
              <ng-container matColumnDef="checkIns">
                <th mat-header-cell *matHeaderCellDef>Check-ins</th>
                <td mat-cell *matCellDef="let item">{{ formatNumber(item.checkIns) }}</td>
              </ng-container>

              <!-- Check-outs Column -->
              <ng-container matColumnDef="checkOuts">
                <th mat-header-cell *matHeaderCellDef>Check-outs</th>
                <td mat-cell *matCellDef="let item">{{ formatNumber(item.checkOuts) }}</td>
              </ng-container>

              <!-- Average Stay Duration Column -->
              <ng-container matColumnDef="averageStayDuration">
                <th mat-header-cell *matHeaderCellDef>Avg Stay</th>
                <td mat-cell *matCellDef="let item">{{ formatDuration(item.averageStayDuration) }}</td>
              </ng-container>

              <!-- Occupancy Rate Column -->
              <ng-container matColumnDef="occupancyRate">
                <th mat-header-cell *matHeaderCellDef>Occupancy</th>
                <td mat-cell *matCellDef="let item">
                  <div class="flex items-center gap-2">
                    <mat-progress-bar 
                      mode="determinate" 
                      [value]="item.occupancyRate"
                      color="accent"
                      class="w-16">
                    </mat-progress-bar>
                    <span>{{ formatPercent(item.occupancyRate) }}</span>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover:bg-gray-50"></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>
    }
  }

  <!-- Loading State -->
  @if (loading() && !guestStats()) {
    <mat-card appearance="outlined" class="p-12">
      <div class="flex flex-col items-center justify-center">
        <mat-spinner diameter="48" class="mb-4"></mat-spinner>
        <p class="text-lg text-gray-600">Loading guest data...</p>
        <p class="text-sm text-gray-500 mt-1">This may take a few moments</p>
      </div>
    </mat-card>
  }
</div>