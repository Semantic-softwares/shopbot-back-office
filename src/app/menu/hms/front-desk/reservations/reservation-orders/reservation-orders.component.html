<mat-card appearance="outlined" class="mb-20 py-4">
  <!-- Header -->
  <mat-card-header>
    <mat-card-title class="flex items-center gap-2">
      Orders
    </mat-card-title>
  </mat-card-header>

  <mat-card-content class="p-0!">
    @if (orders().length === 0) {
      <!-- Empty State -->
      <app-no-record 
        icon="receipt_long" 
        title="No Orders" 
        message="No orders have been placed for this reservation yet."
      />
    } @else {
      <!-- Orders Table -->
      <table mat-table [dataSource]="orders()" multiTemplateDataRows class="w-full">
        <!-- Date Column -->
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Date & Time</th>
          <td mat-cell *matCellDef="let order">
            <div class="flex flex-col">
              <span class="font-medium">{{ order.createdAt | date:'short' }}</span>
              <span class="text-xs text-gray-500 font-mono">{{ order.orderNumber || 'N/A' }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Guest Column -->
        <ng-container matColumnDef="guest">
          <th mat-header-cell *matHeaderCellDef>Guest</th>
          <td mat-cell *matCellDef="let order">
            <div class="flex flex-col">
              <span class="font-medium">{{ getCustomerName(order) }}</span>
              <span class="text-xs text-gray-500">{{ getCustomerType(order) }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Amount Column -->
        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef class="text-right">Amount</th>
          <td mat-cell *matCellDef="let order" class="text-right font-semibold">
            {{ getTotalAmount(order) | currency: getCurrencyFormat() }}
          </td>
        </ng-container>

        <!-- Payment Status Column -->
        <ng-container matColumnDef="paymentStatus">
          <th mat-header-cell *matHeaderCellDef>Payment Status</th>
          <td mat-cell *matCellDef="let order">
            <span class="px-2 py-1 rounded text-xs font-semibold" [ngClass]="getPaymentStatusClass(getPaymentStatus(order))">
              {{ getPaymentStatus(order) | titlecase }}
            </span>
          </td>
        </ng-container>

        <!-- Payment Type Column -->
        <ng-container matColumnDef="paymentType">
          <th mat-header-cell *matHeaderCellDef>Payment Method</th>
          <td mat-cell *matCellDef="let order">
            <span class="text-sm">{{ getPaymentType(order) | titlecase }}</span>
          </td>
        </ng-container>

        <!-- Order Type Column -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Type</th>
          <td mat-cell *matCellDef="let order">
            <span class="text-sm">{{ getOrderType(order) | titlecase }}</span>
          </td>
        </ng-container>

        <!-- Expand Column -->
        <ng-container matColumnDef="expand">
          <th mat-header-cell *matHeaderCellDef aria-label="row actions">&nbsp;</th>
          <td mat-cell *matCellDef="let order">
            <button mat-icon-button (click)="toggleExpand(order); $event.stopPropagation()">
              <mat-icon>{{ expandedElement() === order ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Expanded Content Column -->
        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let order" [attr.colspan]="columnsToDisplayWithExpand.length">
            <div class="order-detail" [@detailExpand]="order === expandedElement() ? 'expanded' : 'collapsed'">
              <div class="p-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="font-semibold text-gray-900 flex items-center gap-2">
                    <mat-icon class="text-indigo-600">shopping_cart</mat-icon>
                    Order Items
                  </h4>
                  <a 
                    mat-stroked-button
                    [routerLink]="['/menu/dashboard/reports/receipts', order._id]"
                    class="text-sm"
                  >
                    <mat-icon>visibility</mat-icon>
                    View Full Receipt
                  </a>
                </div>

                @if (getOrderItems(order).length === 0) {
                  <p class="text-sm text-gray-500 py-2">No items found in this order.</p>
                } @else {
                  <mat-list>
                    @for (item of getOrderItems(order); track item.productId || item._id || $index) {
                      <mat-list-item class="!h-auto !py-3">
                        <div class="flex items-start justify-between w-full gap-4">
                          <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                              <span class="font-medium text-gray-900">{{ item.name || 'Item' }}</span>
                              <span class="text-xs text-gray-500  px-2 py-0.5 rounded">
                                Qty: {{ item.quantity || 1 }}
                              </span>
                            </div>
                            <div class="text-xs text-gray-600 space-y-1">
                              <div class="flex items-center gap-1">
                                <mat-icon class="!text-sm !h-4 !w-4">settings</mat-icon>
                                <span>{{ getItemOptions(item) }}</span>
                              </div>
                              <div class="flex items-center gap-1">
                                <mat-icon class="!text-sm !h-4 !w-4">payments</mat-icon>
                                <span>Unit Price: {{ item.price || 0 | currency: getCurrencyFormat() }}</span>
                              </div>
                            </div>
                          </div>
                          <div class="text-right">
                            <div class="font-semibold text-gray-900">
                              {{ getItemTotal(item) | currency: getCurrencyFormat() }}
                            </div>
                          </div>
                        </div>
                      </mat-list-item>
                      @if (!$last) {
                        <mat-divider></mat-divider>
                      }
                    }
                  </mat-list>

                  <!-- Order Total Summary -->
                  <div class="mt-3 rounded-lg  p-3 flex justify-between items-center">
                    <span class="font-semibold text-gray-900">Order Total:</span>
                    <span class="text-lg font-bold text-indigo-600">
                      {{ getTotalAmount(order) | currency: getCurrencyFormat() }}
                    </span>
                  </div>
                }
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Table Rows -->
        <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
        <tr mat-row *matRowDef="let row; columns: columnsToDisplayWithExpand;" 
            class="cursor-pointer"
            (click)="toggleExpand(row)"></tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
      </table>

      <!-- Orders Summary -->
      <div class="p-4 ">
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-600">
            Total Orders: <strong>{{ orders().length }}</strong>
          </span>
          <span class="text-sm font-semibold text-gray-900">
            Total Amount: {{ totalOrdersAmount() | currency: getCurrencyFormat() }}
          </span>
        </div>
      </div>
    }
  </mat-card-content>
</mat-card>
