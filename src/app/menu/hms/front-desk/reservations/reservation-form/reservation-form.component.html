<!-- Header Section -->
<div class="bg-white shadow-sm border-b border-gray-200">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center py-4">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">
          {{ isEditing() ? 'Edit Reservation' : 'New Reservation' }}
        </h1>
        <p class="text-sm text-gray-600 mt-1">
          {{ isEditing() ? 'Update reservation details' : 'Create a new guest reservation' }}
        </p>
      </div>
      <div class="flex space-x-3">
        <button 
          mat-stroked-button 
          (click)="onCancel()"
          class="border-gray-300 text-gray-700 hover:bg-gray-50">
          Cancel
        </button>
        <button 
          mat-raised-button 
          color="primary"
          (click)="onSubmit()"
          [disabled]="loading() || reservationForm.invalid"
          class="bg-blue-600 hover:bg-blue-700 text-white">
          @if (loading()) {
            <mat-icon class="animate-spin mr-2">refresh</mat-icon>
          } @else {
            <mat-icon class="mr-2">save</mat-icon>
          }
          {{ isEditing() ? 'Update Reservation' : 'Create Reservation' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
@if (loading()) {
  <div class="flex justify-center items-center py-12">
    <mat-spinner diameter="40"></mat-spinner>
    <span class="ml-3 text-gray-600">
      {{ isEditing() ? 'Loading reservation...' : 'Creating reservation...' }}
    </span>
  </div>
}

<!-- Error State -->
@if (error() && !loading()) {
  <div class="bg-red-50 border border-red-200 rounded-lg p-4 m-4">
    <div class="flex">
      <mat-icon class="text-red-500 mr-2">error</mat-icon>
      <div>
        <h3 class="text-red-800 font-medium">Error</h3>
        <p class="text-red-700 text-sm mt-1">{{ error() }}</p>
        <button mat-button (click)="clearError()" class="mt-2">Dismiss</button>
      </div>
    </div>
  </div>
}

<!-- Main Form Content -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <form [formGroup]="reservationForm" (ngSubmit)="onSubmit()">
    
    <mat-stepper #stepper orientation="horizontal" linear="true">
      
      <!-- Step 1: Reservation Details -->
      <mat-step [stepControl]="reservationDetailsGroup" label="Reservation Details" [completed]="isStepOneComplete()">
        <div class="space-y-6">
          
          <!-- Dates and Times -->
          <mat-card class="shadow-sm">
            <mat-card-header>
              <mat-card-title>Stay Dates & Times</mat-card-title>
              <mat-card-subtitle>Check-in and check-out information</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                
                <mat-form-field appearance="outline">
                  <mat-label>Check-in Date</mat-label>
                  <input matInput [matDatepicker]="checkInPicker" formControlName="checkInDate" required>
                  <mat-datepicker-toggle matSuffix [for]="checkInPicker"></mat-datepicker-toggle>
                  <mat-datepicker #checkInPicker></mat-datepicker>
                  @if (reservationForm.get('checkInDate')?.hasError('required')) {
                    <mat-error>
                      Check-in date is required
                    </mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Check-out Date</mat-label>
                  <input matInput [matDatepicker]="checkOutPicker" formControlName="checkOutDate" required>
                  <mat-datepicker-toggle matSuffix [for]="checkOutPicker"></mat-datepicker-toggle>
                  <mat-datepicker #checkOutPicker></mat-datepicker>
                  @if (reservationForm.get('checkOutDate')?.hasError('required')) {
                    <mat-error>
                      Check-out date is required
                    </mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Check-in Time</mat-label>
                  <input matInput type="time" formControlName="expectedCheckInTime">
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Check-out Time</mat-label>
                  <input matInput type="time" formControlName="expectedCheckOutTime">
                </mat-form-field>
              </div>

              @if (numberOfNights() > 0) {
                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                  <div class="flex items-center text-blue-700">
                    <mat-icon class="mr-2">info</mat-icon>
                    <span class="font-medium">{{ numberOfNights() }} night(s) stay</span>
                  </div>
                </div>
              }
            </mat-card-content>
          </mat-card>

          <!-- Room Selection -->
          <mat-card class="shadow-sm">
            <mat-card-header>
              <div class="flex justify-between items-center w-full">
                <div>
                  <mat-card-title>Room Selection</mat-card-title>
                  <mat-card-subtitle>Choose rooms for the stay @if (getSelectedRoomsCount() > 0) {({{ getSelectedRoomsCount() }} selected)}</mat-card-subtitle>
                </div>
              </div>
            </mat-card-header>
            <mat-card-content>
              
              <!-- Room Search Loading -->
              @if (roomSearchLoading()) {
                <div class="flex items-center justify-center py-8">
                  <mat-spinner diameter="30"></mat-spinner>
                  <span class="ml-3 text-gray-600">Searching available rooms...</span>
                </div>
              }

              <!-- Room Grid -->
              @if (!roomSearchLoading() && availableRooms().length > 0) {
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div *ngFor="let room of availableRooms()" 
                       class="border rounded-lg p-4 cursor-pointer transition-all duration-200 hover:shadow-md"
                       [class.border-blue-500]="isRoomSelected(room) && isRoomAvailable(room)"
                       [class.bg-blue-50]="isRoomSelected(room) && isRoomAvailable(room)"
                       [class.border-gray-300]="!isRoomSelected(room) && isRoomAvailable(room)"
                       [class.border-red-300]="!isRoomAvailable(room)"
                       [class.bg-red-50]="!isRoomAvailable(room)"
                       [class.opacity-50]="!isRoomAvailable(room)"
                       [class.cursor-not-allowed]="!isRoomAvailable(room)"
                       (click)="isRoomAvailable(room) && toggleRoomSelection(room)">
                    
                    <!-- Room Header -->
                    <div class="flex justify-between items-start mb-3">
                      <div>
                        <h3 class="font-semibold text-lg text-gray-900">{{ room.roomNumber }} ({{room.name}})</h3>
                        <p class="text-sm text-gray-600 capitalize">{{ getRoomTypeName(room) }}</p>
                      </div>
                      <div class="flex items-center">
                        @if (isRoomAvailable(room)) {
                          <mat-checkbox 
                            [checked]="isRoomSelected(room)"
                            [disabled]="true"
                            color="primary">
                          </mat-checkbox>
                        } @else {
                          <span class="text-red-500 text-xs font-medium px-2 py-1 bg-red-100 rounded">
                            Not Available
                          </span>
                        }
                      </div>
                    </div>

                    <!-- Room Details -->
                    <div class="space-y-2">
                      <!-- Rate -->
                      <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Rate per night:</span>
                        <span class="font-semibold text-blue-600">{{ currency }}{{ getRoomRate(room) }}</span>
                      </div>

                      <!-- Capacity -->
                      <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Capacity:</span>
                        <span class="text-sm font-medium">{{ getRoomAdultCapacity(room) }}A + {{ getRoomChildrenCapacity(room) }}C</span>
                      </div>

                      <!-- Amenities -->
                      @if (getRoomAmenities(room).length > 0) {
                        <div class="mt-3">
                          <p class="text-xs text-gray-500 mb-1">Amenities:</p>
                          <div class="flex flex-wrap gap-1">
                            <span *ngFor="let amenity of getRoomAmenities(room)" 
                                  class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">
                              {{ amenity }}
                            </span>
                          </div>
                        </div>
                      }

                      <!-- Total for stay -->
                      @if (numberOfNights() > 0 && isRoomAvailable(room)) {
                        <div class="mt-3 pt-2 border-t border-gray-200">
                          <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">{{ numberOfNights() }} nights total:</span>
                            <span class="font-bold text-green-600">{{ currency }}{{ getRoomRate(room) * numberOfNights() }}</span>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              }

              <!-- No rooms available -->
              @if (!roomSearchLoading() && availableRooms().length === 0) {
                <div class="text-center py-8 text-gray-500">
                  <mat-icon class="text-4xl mb-2">hotel</mat-icon>
                  <p>No rooms available for the selected dates</p>
                  <p class="text-sm">Please try different dates</p>
                </div>
              }
              
              <!-- No rooms selected warning -->
              @if (!roomSearchLoading() && availableRooms().length > 0 && getSelectedRoomsCount() === 0) {
                <div class="mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                  <div class="flex items-center text-orange-700">
                    <mat-icon class="mr-2">warning</mat-icon>
                    <span class="font-medium">
                      Please select at least one room to continue
                    </span>
                  </div>
                </div>
              }
              
              <!-- Selected Rooms Summary -->
              @if (getSelectedRoomsCount() > 0) {
                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                  <h4 class="font-medium text-blue-900 mb-2">Selected Rooms ({{ getSelectedRoomsCount() }})</h4>
                  <div class="space-y-1 text-sm">
                    <div *ngFor="let room of getSelectedRoomsDetails()" class="flex justify-between">
                      <span>{{ room.roomNumber }} - {{ room.type | titlecase }}</span>
                      <span class="font-medium">{{ currency }}{{ getRoomRate(room) * numberOfNights() }}</span>
                    </div>
                  </div>
                </div>
              }
              
              <!-- Capacity Information -->
              @if (maxAdultsAllowed() > 0) {
                <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                  <div class="flex items-center text-green-700">
                    <mat-icon class="mr-2">info</mat-icon>
                    <span class="font-medium">
                      Selected rooms can accommodate up to {{ maxAdultsAllowed() }} adults and {{ maxChildrenAllowed() }} children
                    </span>
                  </div>
                </div>
              }
            </mat-card-content>
          </mat-card>

          <!-- Special Requests -->
          <mat-card class="shadow-sm">
            <mat-card-header>
              <mat-card-title>Additional Information</mat-card-title>
            </mat-card-header>
            <mat-card-content class="space-y-4">
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Special Requests</mat-label>
                <textarea matInput formControlName="specialRequests" rows="3" 
                          placeholder="Any special requests or preferences..."></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Internal Notes</mat-label>
                <textarea matInput formControlName="internalNotes" rows="2" 
                          placeholder="Internal notes (not visible to guest)..."></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Booking Source</mat-label>
                <mat-select formControlName="bookingSource">
                  <mat-option value="direct">Direct</mat-option>
                  <mat-option value="phone">Phone</mat-option>
                  <mat-option value="online">Online</mat-option>
                  <mat-option value="walk_in">Walk-in</mat-option>
                  <mat-option value="booking_com">Booking.com</mat-option>
                  <mat-option value="expedia">Expedia</mat-option>
                  <mat-option value="airbnb">Airbnb</mat-option>
                </mat-select>
              </mat-form-field>
            </mat-card-content>
          </mat-card>

          <div class="flex justify-end">
            <button mat-button matStepperNext type="button" class="bg-blue-600 text-white hover:bg-blue-700">
              Next: Guest Information
            </button>
          </div>
        </div>
      </mat-step>

      <!-- Step 2: Guest Information -->
      <mat-step [stepControl]="reservationForm.get('guestDetails')!" label="Guest Information" [completed]="isStepTwoComplete()">
        <div class="space-y-6">
          
          <!-- Primary Guest Information -->
          <mat-card class="shadow-sm">
            <mat-card-header>
              <mat-card-title>Primary Guest</mat-card-title>
              <mat-card-subtitle>Main contact and billing information</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              
              <!-- Guest Search Section -->
              <div class="guest-search-section mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Search Existing Guest</h3>
                <p class="text-sm text-gray-600 mb-4">Search by name to find existing guest records</p>
                
                <!-- Autocomplete Search -->
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Search by guest name</mat-label>
                  <input 
                    matInput 
                    [formControl]="guestSearchControl"
                    [matAutocomplete]="guestAuto"
                    placeholder="Type guest name..."
                    [disabled]="guestSearchLoading()">
                  <mat-icon matSuffix>search</mat-icon>
                  @if (guestSearchLoading()) {
                    <mat-spinner diameter="20" matSuffix></mat-spinner>
                  }
                </mat-form-field>

                <mat-autocomplete 
                  #guestAuto="matAutocomplete" 
                  [displayWith]="displayGuestFn"
                  (optionSelected)="onGuestSelected($event.option.value)">
                  @for (guest of filteredGuests(); track guest._id) {
                    <mat-option [value]="guest">
                      <div class="flex flex-col">
                        <span class="font-medium">{{ guest.firstName }} {{ guest.lastName }}</span>
                        <span class="text-sm text-gray-500">{{ guest.phone }} • {{ guest.email }}</span>
                      </div>
                    </mat-option>
                  } @empty {
                    @if (guestSearchControl.value && guestSearchControl.value.length >= 2 && !guestSearchLoading()) {
                      <mat-option disabled>
                        <span class="text-gray-500">No guests found</span>
                      </mat-option>
                    }
                  }
                </mat-autocomplete>

                <!-- Search Results -->
                @if (selectedGuest()) {
                  <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center">
                        <mat-icon class="text-green-600 mr-2">person</mat-icon>
                        <div>
                          <p class="font-medium text-green-800">
                            {{ selectedGuest()!.firstName }} {{ selectedGuest()!.lastName }}
                          </p>
                          <p class="text-sm text-green-600">
                            {{ selectedGuest()!.email }} • {{ selectedGuest()!.phone }}
                          </p>
                        </div>
                      </div>
                      <button 
                        mat-icon-button 
                        (click)="onGuestSearchClear()"
                        matTooltip="Clear selection and create new guest">
                        <mat-icon>clear</mat-icon>
                      </button>
                    </div>
                  </div>
                }

                @if (!selectedGuest() && guestSearchControl.value && guestSearchControl.value.length >= 2 && filteredGuests().length === 0 && !guestSearchLoading()) {
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center">
                      <mat-icon class="text-blue-600 mr-2">info</mat-icon>
                      <p class="text-sm text-blue-800">
                        No existing guest found. Fill in the details below to create a new guest record.
                      </p>
                    </div>
                  </div>
                }

                <mat-divider class="my-4"></mat-divider>
              </div>

              <div formGroupName="guestDetails">
                <div formGroupName="primaryGuest" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  
                  <mat-form-field appearance="outline">
                    <mat-label>First Name</mat-label>
                    <input matInput formControlName="firstName" required>
                    @if (reservationForm.get('guestDetails.primaryGuest.firstName')?.hasError('required')) {
                      <mat-error>
                        First name is required
                      </mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Last Name</mat-label>
                    <input matInput formControlName="lastName" required>
                    @if (reservationForm.get('guestDetails.primaryGuest.lastName')?.hasError('required')) {
                      <mat-error>
                        Last name is required
                      </mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Email</mat-label>
                    <input matInput type="email" formControlName="email" required>
                    @if (reservationForm.get('guestDetails.primaryGuest.email')?.hasError('required')) {
                      <mat-error>
                        Email is required
                      </mat-error>
                    }
                    @if (reservationForm.get('guestDetails.primaryGuest.email')?.hasError('email')) {
                      <mat-error>
                        Please enter a valid email
                      </mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Phone</mat-label>
                    <input matInput formControlName="phone" required>
                    @if (reservationForm.get('guestDetails.primaryGuest.phone')?.hasError('required')) {
                      <mat-error>
                        Phone number is required
                      </mat-error>
                    }
                  </mat-form-field>
                </div>

                <!-- Guest Counts - Outside primaryGuest form group -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                  <mat-form-field appearance="outline">
                    <mat-label>Total Adults</mat-label>
                    <input matInput type="number" formControlName="totalAdults" min="1" [max]="maxAdultsAllowed() || 999" required>
                    @if (reservationForm.get('guestDetails.totalAdults')?.hasError('required')) {
                      <mat-error>
                        Total adults is required
                      </mat-error>
                    }
                    @if (reservationForm.get('guestDetails.totalAdults')?.hasError('min')) {
                      <mat-error>
                        At least 1 adult is required
                      </mat-error>
                    }
                    @if (reservationForm.get('guestDetails.totalAdults')?.hasError('max')) {
                      <mat-error>
                        Cannot exceed {{ maxAdultsAllowed() }} adults (room capacity limit)
                      </mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Total Children</mat-label>
                    <input matInput type="number" formControlName="totalChildren" min="0" [max]="maxChildrenAllowed() || 999">
                    @if (reservationForm.get('guestDetails.totalChildren')?.hasError('min')) {
                      <mat-error>
                        Children count cannot be negative
                      </mat-error>
                    }
                    @if (reservationForm.get('guestDetails.totalChildren')?.hasError('max')) {
                      <mat-error>
                        Cannot exceed {{ maxChildrenAllowed() }} children (room capacity limit)
                      </mat-error>
                    }
                  </mat-form-field>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Additional Guests -->
          <mat-card class="shadow-sm">
            <mat-card-header>
              <div class="flex justify-between items-center w-full">
                <div>
                  <mat-card-title>Additional Guests</mat-card-title>
                  <mat-card-subtitle>Add accompanying guests (optional)</mat-card-subtitle>
                </div>
                <button 
                  mat-icon-button 
                  type="button"
                  (click)="addAdditionalGuest()"
                  [disabled]="!canAddMoreAdditionalGuests()"
                  [matTooltip]="!canAddMoreAdditionalGuests() ? getAdditionalGuestsWarningMessage() : 'Add additional guest'"
                  class="text-blue-600 hover:text-blue-800 disabled:text-gray-400 disabled:cursor-not-allowed">
                  <mat-icon>add</mat-icon>
                </button>
              </div>
            </mat-card-header>
            
            <!-- Capacity Warning -->
            @if (maxAdultsAllowed() > 0) {
              <div class="px-6 pb-2">
                <div class="flex items-center text-sm" 
                     [class.text-gray-600]="canAddMoreAdditionalGuests()"
                     [class.text-orange-600]="!canAddMoreAdditionalGuests() && additionalGuests.length < getMaxAdditionalGuestsAllowed()"
                     [class.text-red-600]="additionalGuests.length >= getMaxAdditionalGuestsAllowed()">
                  <mat-icon class="mr-2 text-sm">info</mat-icon>
                  <span>
                    Maximum {{ getMaxAdditionalGuestsAllowed() }} additional guest(s) allowed
                    ({{ additionalGuests.length }}/{{ getMaxAdditionalGuestsAllowed() }} added)
                    @if (additionalGuests.length >= getMaxAdditionalGuestsAllowed()) {
                      - <strong>Limit reached</strong>
                    }
                  </span>
                </div>
              </div>
            }
            
            @if (additionalGuests.length > 0) {
              <mat-card-content>
                <div formGroupName="guestDetails">
                  <div formArrayName="additionalGuests" class="space-y-4">
                    <div *ngFor="let guest of additionalGuests.controls; let i = index" 
                         [formGroupName]="i" 
                         class="border border-gray-200 rounded-lg p-4">
                      <div class="flex justify-between items-start mb-4">
                        <h4 class="font-medium text-gray-900">Guest {{ i + 2 }}</h4>
                        <button 
                          mat-icon-button 
                          type="button"
                          (click)="removeAdditionalGuest(i)"
                          class="text-red-600 hover:text-red-800">
                          <mat-icon>remove</mat-icon>
                        </button>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <mat-form-field appearance="outline">
                          <mat-label>First Name</mat-label>
                          <input matInput formControlName="firstName">
                        </mat-form-field>
                        <mat-form-field appearance="outline">
                          <mat-label>Last Name</mat-label>
                          <input matInput formControlName="lastName">
                        </mat-form-field>
                        <mat-form-field appearance="outline">
                          <mat-label>Age</mat-label>
                          <input matInput type="number" formControlName="age" min="0">
                        </mat-form-field>
                        <mat-form-field appearance="outline">
                          <mat-label>Relationship</mat-label>
                          <input matInput formControlName="relationship">
                        </mat-form-field>
                      </div>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            }
          </mat-card>

          <div class="flex justify-between">
            <button mat-button matStepperPrevious type="button" class="text-gray-600">
              Previous
            </button>
            <button mat-button matStepperNext type="button" class="bg-blue-600 text-white hover:bg-blue-700">
              Next: Pricing & Payment
            </button>
          </div>
        </div>
      </mat-step>

      <!-- Step 3: Pricing & Payment -->
      <mat-step [stepControl]="reservationForm.get('pricing')!" label="Pricing & Payment" [completed]="isStepThreeComplete()">
        <div class="space-y-6">
          
          <!-- Pricing Details -->
          <mat-card class="shadow-sm">
            <mat-card-header>
              <mat-card-title>Pricing Details</mat-card-title>
              <mat-card-subtitle>Automatically calculated based on room selection and stay duration</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div formGroupName="pricing" class="space-y-4">
                
                <!-- Auto-calculated pricing info -->
                @if (selectedRoomDetails().length > 0 && numberOfNights() > 0) {
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h4 class="font-medium text-blue-900 mb-2">Room Rate Breakdown</h4>
                    <div class="space-y-1 text-sm">
                      <div *ngFor="let room of selectedRoomDetails()" class="flex justify-between">
                        <span>{{ room.roomNumber }} ({{ getRoomTypeName(room) | titlecase }}) × {{ numberOfNights() }} nights</span>
                        <span class="font-medium">{{ getRoomRate(room) * numberOfNights() | currency: currency}}</span>
                      </div>
                    </div>
                  </div>
                }
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <mat-form-field appearance="outline">
                    <mat-label>Subtotal (Auto-calculated)</mat-label>
                    <input matInput type="number" formControlName="subtotal" min="0" step="0.01" readonly>
                    <span matPrefix>{{ currency }}&nbsp;</span>
                    <mat-hint>Based on room rates and stay duration</mat-hint>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Taxes (Auto-calculated)</mat-label>
                    <input matInput type="number" formControlName="taxes" min="0" step="0.01" readonly>
                    <span matPrefix>{{ currency }}&nbsp;</span>
                    <mat-hint>Dynamic tax rate applied</mat-hint>
                  </mat-form-field>
                </div>

                <!-- Fees Section -->
                <div formGroupName="fees">
                  <h4 class="font-medium text-gray-900 mb-3">Additional Fees</h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <mat-form-field appearance="outline">
                      <mat-label>Service Fee</mat-label>
                      <input matInput type="number" formControlName="serviceFee" min="0" step="0.01">
                      <span matPrefix>{{ currency }}&nbsp;</span>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Cleaning Fee</mat-label>
                      <input matInput type="number" formControlName="cleaningFee" min="0" step="0.01">
                      <span matPrefix>{{ currency }}&nbsp;</span>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Resort Fee</mat-label>
                      <input matInput type="number" formControlName="resortFee" min="0" step="0.01">
                      <span matPrefix>{{ currency }}&nbsp;</span>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Other Fees</mat-label>
                      <input matInput type="number" formControlName="other" min="0" step="0.01">
                      <span matPrefix>{{ currency }}&nbsp;</span>
                    </mat-form-field>
                  </div>
                </div>

                <!-- Discounts Section -->
                <div formGroupName="discounts">
                  <h4 class="font-medium text-gray-900 mb-3">Discounts</h4>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <mat-form-field appearance="outline">
                      <mat-label>Discount Amount</mat-label>
                      <input matInput type="number" formControlName="amount" min="0" step="0.01">
                      <span matPrefix>{{ currency }}&nbsp;</span>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Reason</mat-label>
                      <input matInput formControlName="reason" placeholder="e.g., Senior discount">
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Promo Code</mat-label>
                      <input matInput formControlName="code" placeholder="e.g., SAVE20">
                    </mat-form-field>
                  </div>
                </div>

                <!-- Payment Amount -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <mat-form-field appearance="outline">
                    <mat-label>Amount Paid</mat-label>
                    <input matInput type="number" formControlName="paid" min="0" step="0.01">
                    <span matPrefix>{{ currency }}&nbsp;</span>
                  </mat-form-field>
                </div>

                <!-- Totals Summary -->
                <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Total Amount:</span>
                    <span class="font-semibold">{{ currency }}{{ totalAmount() | number:'1.2-2' }}</span>
                  </div>
                  <div class="flex justify-between text-lg font-bold text-green-600">
                    <span>Balance Due:</span>
                    <span>{{ currency }}{{ (totalAmount() - (reservationForm.get('pricing.paid')?.value || 0)) | number:'1.2-2' }}</span>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Payment Information -->
          <mat-card class="shadow-sm">
            <mat-card-header>
              <mat-card-title>Payment Information</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div formGroupName="paymentInfo" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <mat-form-field appearance="outline">
                  <mat-label>Payment Method</mat-label>
                  <mat-select formControlName="method" required>
                    <mat-option *ngFor="let method of paymentMethods" [value]="method">
                      {{ method | titlecase }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Payment Status</mat-label>
                  <mat-select formControlName="status">
                    <mat-option value="pending">Pending</mat-option>
                    <mat-option value="partial">Partial</mat-option>
                    <mat-option value="paid">Paid</mat-option>
                    <mat-option value="refunded">Refunded</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </mat-card-content>
          </mat-card>

          <div class="flex justify-between">
            <button mat-button matStepperPrevious type="button" class="text-gray-600">
              Previous
            </button>
            <button 
              mat-raised-button 
              color="primary"
              type="submit"
              [disabled]="loading() || reservationForm.invalid"
              class="bg-blue-600 hover:bg-blue-700 text-white">
              @if (loading()) {
                <mat-icon class="animate-spin mr-2">refresh</mat-icon>
              } @else {
                <mat-icon class="mr-2">save</mat-icon>
              }
              {{ isEditing() ? 'Update Reservation' : 'Create Reservation' }}
            </button>
          </div>
        </div>
      </mat-step>

    </mat-stepper>
  </form>
</div>