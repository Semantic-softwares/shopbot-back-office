<!-- Dialog Title -->
<div mat-dialog-title>
   Update Pricing
</div>

<!-- Dialog Content -->
<div mat-dialog-content class="!p-6 !max-h-[70vh] overflow-y-auto">
  <form [formGroup]="pricingForm" class="space-y-6">
      <!-- Basic Pricing (Read-only) -->
      <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 mb-6 shadow-sm">
        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2 uppercase tracking-wide">
          <mat-icon class="text-gray-500 text-lg">lock</mat-icon>
          Base Pricing (Read-only)
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Subtotal</mat-label>
            <input matInput 
                   type="number" 
                   formControlName="subtotal" 
                   readonly
                   class="!bg-gray-100 !text-gray-600">
            <span matPrefix>{{ currency }}&nbsp;</span>
            <mat-hint>Based on room rates and duration</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Taxes</mat-label>
            <input matInput 
                   type="number" 
                   formControlName="taxes" 
                   readonly
                   class="!bg-gray-100 !text-gray-600">
            <span matPrefix>{{ currency }}&nbsp;</span>
            <mat-hint>Calculated from store tax rate</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- Fees Section (Read-only) -->
      @if (data.reservation.pricing.fees && 
           (data.reservation.pricing.fees.serviceFee || 
            data.reservation.pricing.fees.cleaningFee || 
            data.reservation.pricing.fees.resortFee || 
            data.reservation.pricing.fees.other)) {
        <div formGroupName="fees" class="bg-gray-50 rounded-lg p-4 border border-gray-200 mb-6 shadow-sm">
          <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2 uppercase tracking-wide">
            <mat-icon class="text-gray-500 text-lg">lock</mat-icon>
            Additional Fees (Read-only)
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            @if (data.reservation.pricing.fees.serviceFee) {
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Service Fee</mat-label>
                <input matInput 
                       type="number" 
                       formControlName="serviceFee" 
                       readonly
                       class="!bg-gray-100 !text-gray-600">
                <span matPrefix>{{ currency }}&nbsp;</span>
              </mat-form-field>
            }

            @if (data.reservation.pricing.fees.cleaningFee) {
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Cleaning Fee</mat-label>
                <input matInput 
                       type="number" 
                       formControlName="cleaningFee" 
                       readonly
                       class="!bg-gray-100 !text-gray-600">
                <span matPrefix>{{ currency }}&nbsp;</span>
              </mat-form-field>
            }

            @if (data.reservation.pricing.fees.resortFee) {
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Resort Fee</mat-label>
                <input matInput 
                       type="number" 
                       formControlName="resortFee" 
                       readonly
                       class="!bg-gray-100 !text-gray-600">
                <span matPrefix>{{ currency }}&nbsp;</span>
              </mat-form-field>
            }

            @if (data.reservation.pricing.fees.other) {
              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Other Fees</mat-label>
                <input matInput 
                       type="number" 
                       formControlName="other" 
                       readonly
                       class="!bg-gray-100 !text-gray-600">
                <span matPrefix>{{ currency }}&nbsp;</span>
              </mat-form-field>
            }
          </div>
        </div>
      }

      <!-- Extensions Section (Read-only) -->
      @if (hasApprovedExtensions()) {
        <div class="bg-orange-50 rounded-lg p-4 border border-orange-200 mb-6 shadow-sm">
          <h4 class="text-sm font-semibold text-orange-700 mb-3 flex items-center gap-2 uppercase tracking-wide">
            <mat-icon class="text-orange-500 text-lg">lock</mat-icon>
            Extension Charges (Read-only)
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Extension Cost</mat-label>
              <input matInput 
                     type="number" 
                     [value]="getApprovedExtensionCost()"
                     readonly
                     class="!bg-gray-100 !text-gray-600">
              <span matPrefix>{{ currency }}&nbsp;</span>
              <mat-hint>{{ getApprovedExtensionNights() }} additional nights</mat-hint>
            </mat-form-field>

            <div class="flex flex-col justify-center">
              <div class="text-sm text-orange-600 mb-1">Extension Status</div>
              <div class="flex items-center gap-2">
                <mat-icon class="text-green-600 text-sm">check_circle</mat-icon>
                <span class="text-sm font-medium text-green-600">Approved & Included</span>
              </div>
              <div class="text-xs text-gray-500 mt-1">
                Cannot be modified in pricing dialog
              </div>
            </div>
          </div>
          
          <!-- Extension Info Note -->
          <div class="mt-3 p-2 bg-orange-100 border border-orange-200 rounded text-xs text-orange-800">
            <div class="flex items-center gap-2">
              <mat-icon class="text-orange-600 text-sm">info</mat-icon>
              <span>
                <strong>{{ getApprovedExtensionNights() }} extension night(s)</strong> 
                totaling <strong>{{ getApprovedExtensionCost() | currency: currency:'symbol':'1.2-2' }}</strong> 
                have been approved and are automatically included in the total.
              </span>
            </div>
          </div>
        </div>
      }

      <!-- Editable Adjustments -->
      <div class="space-y-6">
        <!-- Discounts Section -->
        <div formGroupName="discounts" class="bg-green-50 rounded-lg p-4 border border-green-200 shadow-sm hover:shadow-md transition-shadow duration-200">
          <h4 class="text-lg font-semibold text-green-900 mb-3 flex items-center gap-2 uppercase tracking-wide">
            <mat-icon class="text-green-600">local_offer</mat-icon>
            Discounts (Editable)
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Discount Amount</mat-label>
              <input matInput 
                     type="number" 
                     formControlName="amount" 
                     min="0" 
                     step="0.01"
                     placeholder="0.00">
              <span matPrefix>{{ currency }}&nbsp;</span>
              <mat-hint>Reduce total amount</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Discount Reason</mat-label>
              <input matInput 
                     formControlName="reason" 
                     placeholder="e.g., Staff discount">
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Discount Code</mat-label>
              <input matInput 
                     formControlName="code" 
                     placeholder="e.g., STAFF10">
            </mat-form-field>
          </div>
        </div>

        <!-- Amount Paid Section -->
        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200 shadow-sm hover:shadow-md transition-shadow duration-200">
          <h4 class="text-lg font-semibold text-blue-900 mb-3 flex items-center gap-2 uppercase tracking-wide">
            <mat-icon class="text-blue-600">payment</mat-icon>
            Payment Amount (Editable)
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Amount Paid</mat-label>
              <input matInput 
                     type="number" 
                     formControlName="paid" 
                     min="0" 
                     step="0.01"
                     placeholder="0.00">
              <span matPrefix>{{ currency }}&nbsp;</span>
              <mat-hint>Total amount received from guest</mat-hint>
            </mat-form-field>
            
            <!-- Current payment status for reference -->
            <div class="flex flex-col justify-center">
              <div class="text-sm text-gray-600 mb-1">Current Status</div>
              <div class="text-lg font-medium" 
                   [class.text-green-600]="data.reservation.paymentInfo?.status === 'paid'"
                   [class.text-orange-600]="data.reservation.paymentInfo?.status === 'partial'"
                   [class.text-gray-600]="data.reservation.paymentInfo?.status === 'pending'">
                {{ (data.reservation.paymentInfo?.status || 'pending') | titlecase }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pricing Summary -->
      <div class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-lg p-4 border border-purple-200 shadow-sm">
        <h4 class="text-lg font-semibold text-purple-900 mb-3 flex items-center gap-2 uppercase tracking-wide">
          <mat-icon class="text-purple-600">calculate</mat-icon>
          Updated Summary
        </h4>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Subtotal:</span>
            <span class="font-medium">{{ pricingForm.get('subtotal')?.value | currency: currency:'symbol':'1.2-2' }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Taxes:</span>
            <span class="font-medium">{{ pricingForm.get('taxes')?.value | currency: currency:'symbol':'1.2-2' }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Total Fees:</span>
            <span class="font-medium">{{ 
              (pricingForm.get('fees.serviceFee')?.value || 0) + 
              (pricingForm.get('fees.cleaningFee')?.value || 0) + 
              (pricingForm.get('fees.resortFee')?.value || 0) + 
              (pricingForm.get('fees.other')?.value || 0) 
              | currency: currency:'symbol':'1.2-2' }}</span>
          </div>
          @if (hasApprovedExtensions()) {
            <div class="flex justify-between">
              <span class="text-gray-600">Extensions ({{ getApprovedExtensionNights() }} nights):</span>
              <span class="font-medium text-orange-600">+{{ getApprovedExtensionCost() | currency: currency:'symbol':'1.2-2' }}</span>
            </div>
          }
          <div class="flex justify-between">
            <span class="text-gray-600">Discount:</span>
            <span class="font-medium text-green-600">-{{ pricingForm.get('discounts.amount')?.value | currency: currency:'symbol':'1.2-2' }}</span>
          </div>
          <mat-divider class="my-2"></mat-divider>
          <div class="flex justify-between text-lg font-semibold">
            <span class="text-gray-900">New Total:</span>
            <span class="text-gray-900">{{ currentTotal | currency: currency:'symbol':'1.2-2' }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Amount Paid:</span>
            <span class="font-medium text-green-600">{{ pricingForm.get('paid')?.value | currency: currency:'symbol':'1.2-2' }}</span>
          </div>
          <div class="flex justify-between text-lg font-semibold" 
               [class.text-red-600]="currentBalance > 0"
               [class.text-green-600]="currentBalance < 0"
               [class.text-gray-900]="currentBalance === 0">
            <span>New Balance:</span>
            <span>{{ currentBalance | currency: currency:'symbol':'1.2-2' }}</span>
          </div>
        </div>
      </div>

      <!-- Original Pricing for Reference -->
      <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-lg p-4 border border-blue-200 shadow-sm">
        <h4 class="text-sm font-semibold text-blue-900 mb-2 uppercase tracking-wide">Original Pricing (for reference)</h4>
        <div class="text-xs text-blue-800 space-y-1">
          <div class="flex justify-between">
            <span>Original Total:</span>
            <span>{{ data.reservation.pricing.total | currency: currency:'symbol':'1.2-2' }}</span>
          </div>
          <div class="flex justify-between">
            <span>Original Balance:</span>
            <span>{{ data.reservation.pricing.balance | currency: currency:'symbol':'1.2-2' }}</span>
          </div>
          <div class="flex justify-between">
            <span>Original Amount Paid:</span>
            <span>{{ data.reservation.pricing.paid | currency: currency:'symbol':'1.2-2' }}</span>
          </div>
        </div>
      </div>
    </form>
</div>

<!-- Dialog Actions -->
<div mat-dialog-actions class="flex items-center justify-end gap-3 !p-6 !m-0 border-t border-gray-200 bg-gray-50">
  <button 
    mat-button 
    (click)="onCancel()" 
    [disabled]="loading()" 
    class="!text-gray-600 hover:!bg-gray-100 !px-6 !py-2 !font-medium !rounded-lg transition-colors duration-200">
    Cancel
  </button>
  <button 
    mat-raised-button 
    color="primary"
    (click)="onSave()"
    [disabled]="loading() || pricingForm.invalid"
    class="!bg-gradient-to-r !from-purple-600 !to-purple-700 hover:!from-purple-700 hover:!to-purple-800 !text-white !shadow-lg hover:!shadow-xl !px-6 !py-2 !font-semibold !rounded-lg transition-all duration-200 transform hover:!scale-105 disabled:!opacity-50 disabled:!cursor-not-allowed disabled:hover:!scale-100">
    @if (loading()) {
      <span class="flex items-center gap-2">
        <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Updating...
      </span>
    } @else {
      <span class="flex items-center gap-2">
        <mat-icon>save</mat-icon>
        Update Pricing
      </span>
    }
  </button>
</div>