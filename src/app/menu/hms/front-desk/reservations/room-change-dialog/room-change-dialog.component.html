<h2 mat-dialog-title>Change Room</h2>

<mat-dialog-content>
  @if (loadingRooms()) {
    <div class="flex justify-center py-8">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } @else {
    <form [formGroup]="roomChangeForm" class="flex flex-col gap-4">
      
      <!-- Current Room Info -->
      <div class="bg-gray-100 rounded-lg p-4">
        <div class="text-sm text-gray-500 mb-1">Current Room</div>
        <div class="flex items-center justify-between">
          <div>
            <span class="text-xl font-bold">{{ currentRoomDetails().roomNumber }}</span>
            <span class="text-gray-600 ml-2">{{ currentRoomDetails().roomName }}</span>
          </div>
          <div class="text-right">
            <div class="text-sm text-gray-500">{{ currentRoomDetails().roomTypeName }}</div>
            <div class="font-semibold">{{ currentRoomDetails().rate | currency: data.currency }}/night</div>
          </div>
        </div>
      </div>

      <!-- New Room Selection -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Select New Room</mat-label>
        <mat-select formControlName="newRoom">
          @for (room of availableRooms(); track room._id) {
            <mat-option [value]="room">
              <div class="flex justify-between items-center w-full">
                <span>
                  <strong>{{ room.roomNumber }}</strong> - {{ room.name }}
                  <span class="text-gray-500 text-sm ml-1">({{ room.roomType?.name }})</span>
                </span>
                <span class="text-green-600 font-medium">
                  {{ getRoomRate(room) | currency: data.currency }}/night
                </span>
              </div>
            </mat-option>
          }
          @empty {
            <mat-option disabled>No rooms available</mat-option>
          }
        </mat-select>
        @if (roomChangeForm.get('newRoom')?.hasError('required')) {
          <mat-error>Please select a room</mat-error>
        }
      </mat-form-field>

      <!-- Reason -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Reason for Change</mat-label>
        <textarea 
          matInput 
          formControlName="reason" 
          rows="2"
          placeholder="e.g., Guest requested upgrade, maintenance issue..."></textarea>
        @if (roomChangeForm.get('reason')?.hasError('required')) {
          <mat-error>Reason is required</mat-error>
        }
        @if (roomChangeForm.get('reason')?.hasError('minlength')) {
          <mat-error>Minimum 10 characters</mat-error>
        }
      </mat-form-field>

      <!-- Pricing Summary (only shown when room selected) -->
      @if (selectedNewRoom()) {
        <mat-divider></mat-divider>
        
        <div class="space-y-2">
          <div class="text-sm font-medium text-gray-700">Pricing Summary</div>
          
          @if (isMidStayChange()) {
            <div class="text-xs text-blue-600 bg-blue-50 p-2 rounded">
              <mat-icon class="text-sm align-middle mr-1">info</mat-icon>
              Mid-stay change: {{ nightsConsumed() }} night(s) consumed, {{ nightsRemaining() }} remaining
            </div>
          }
          
          <mat-list dense>
            <mat-list-item>
              <span matListItemTitle>Current Rate</span>
              <span matListItemMeta>{{ currentRoomDetails().rate | currency: data.currency }}/night</span>
            </mat-list-item>
            <mat-list-item>
              <span matListItemTitle>New Rate</span>
              <span matListItemMeta>{{ newRoomRate() | currency: data.currency }}/night</span>
            </mat-list-item>
            <mat-list-item>
              <span matListItemTitle>Nights ({{ data.numberOfNights }})</span>
              <span matListItemMeta>{{ currentRoomCost() | currency: data.currency }}</span>
            </mat-list-item>
            <mat-divider></mat-divider>
            <mat-list-item>
              <span matListItemTitle class="font-bold">Difference</span>
              <span matListItemMeta 
                    [class.text-red-600]="priceDifference() > 0"
                    [class.text-green-600]="priceDifference() < 0"
                    class="font-bold">
                {{ priceDifference() >= 0 ? '+' : '' }}{{ priceDifference() | currency: data.currency }}
              </span>
            </mat-list-item>
          </mat-list>

          @if (priceDifference() > 0) {
            <div class="text-sm text-red-600 bg-red-50 p-2 rounded">
              <mat-icon class="text-sm align-middle mr-1">warning</mat-icon>
              Additional payment of {{ priceDifference() | currency: data.currency }} required
            </div>
          }
          @if (priceDifference() < 0) {
            <div class="text-sm text-green-600 bg-green-50 p-2 rounded">
              <mat-icon class="text-sm align-middle mr-1">savings</mat-icon>
              Refund of {{ Math.abs(priceDifference()) | currency: data.currency }} will be applied
            </div>
          }
        </div>
      }
    </form>
  }
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()" [disabled]="submitting()">Cancel</button>
  <button mat-flat-button color="primary" (click)="onSubmit()" [disabled]="!canSubmit()">
    @if (submitting()) {
      <mat-spinner diameter="20" class="inline-block mr-2"></mat-spinner>
    }
    Change Room
  </button>
</mat-dialog-actions>
