<app-page-header 
  title="Reservations" 
  subtitle="Manage hotel reservations and guest bookings"
  [showViewToggle]="true"
  viewToggleRoute="/menu/hms/front-desk/reservations/view">
  
  <ng-container actions>
    <button matButton="outlined" (click)="clearFilters()">
      <mat-icon>clear</mat-icon>
      Clear Filters
    </button>

    <button matButton="outlined" (click)="reloadData()">
      <mat-icon class="mr-1">redo</mat-icon>
      Reload
    </button>
    
    <button matButton="filled" (click)="createReservation()">
      <mat-icon class="mr-1">add</mat-icon>
      Create Reservation
    </button>
  </ng-container>
  
</app-page-header>

<div class="min-h-screen flex flex-col ">
  <!-- Calendar Controls Header -->
  <div class=" border-b border-gray-200  py-4 ">
    <div class="flex justify-between items-center">
      <div>
        <div class="flex flex-wrap gap-4 mt-2">
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <mat-icon class="text-base">hotel</mat-icon>
            <span>Total: <strong>{{ reservations.value()?.reservations?.length || 0 }}</strong></span>
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <mat-icon class="text-base text-green-600">check_circle</mat-icon>
            <span>Confirmed: <strong>{{ confirmedCount() || 0 }}</strong></span>
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <mat-icon class="text-base text-purple-600">person</mat-icon>
            <span>Checked In: <strong>{{ checkedInCount() || 0 }}</strong></span>
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <mat-icon class="text-base text-orange-600">schedule</mat-icon>
            <span>Pending: <strong>{{ pendingCount() || 0 }}</strong></span>
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <mat-icon class="text-base text-red-600">cancel</mat-icon>
            <span>Cancelled: <strong>{{ cancelledCount() || 0 }}</strong></span>
          </div>
        </div>
      </div>
      <div class="flex gap-3 items-center">
        <!-- View Mode Menu Trigger -->
        <button mat-stroked-button [matMenuTriggerFor]="viewMenu">
           {{ viewMode() | titlecase }}
          <mat-icon class="ml-1">expand_more</mat-icon>
        </button>
        <mat-menu #viewMenu="matMenu">
          <button mat-menu-item (click)="onViewModeChange('weekly')">Weekly</button>
          <button mat-menu-item (click)="onViewModeChange('monthly')">Monthly</button>
        </mat-menu>
        <!-- Status Filter Menu Trigger -->
        <button mat-stroked-button [matMenuTriggerFor]="statusMenu">
          Status: {{ selectedStatus() | titlecase }}
          <mat-icon class="ml-1">expand_more</mat-icon>
        </button>
        <mat-menu #statusMenu="matMenu">
          <button mat-menu-item (click)="onStatusChange('all')">All</button>
          @for (s of reservationStatuses; track s) {
            <button mat-menu-item (click)="onStatusChange(s)">{{ s | titlecase }}</button>
          }
        </mat-menu>
        <button matButton="tonal" (click)="previousWeek()">
          <mat-icon class="mr-1">chevron_left</mat-icon>
          Previous
        </button>
        <button matButton color="warn">
         {{getPeriodLabel()}}
        </button>
        <button matButton="tonal" (click)="nextWeek()">
          Next
          <mat-icon class="ml-1">chevron_right</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Calendar Table Container -->
  <div class="flex-1 overflow-hidden flex flex-col min-h-96">
    <div class="overflow-auto flex-1 relative min-h-80">
      @if (reservations.isLoading()) {
        <div class="absolute inset-0 z-50 flex items-center justify-center bg-white/60">
          <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
        </div>
      }
      <table class="w-full border-collapse overflow-hidden">
        <tfoot>
          <tr>
            <td class="sticky left-0 z-10 w-48 border border-gray-200 bg-white"></td>
            <td class="border border-gray-200 bg-white px-4 py-2" [attr.colspan]="dateRange().length">
              <div class="flex flex-wrap items-center gap-4">
                @for (s of reservationStatuses; track s) {
                  <div class="flex items-center gap-2">
                    <span class="inline-block w-3 h-3 rounded-sm" [ngClass]="getStatusColorClass(s)"></span>
                    <span class="text-xs text-gray-700">{{ s | titlecase }}</span>
                  </div>
                }
              </div>
            </td>
          </tr>
        </tfoot>
        <thead>
          <tr>
            <th class="sticky left-0 top-0 z-30 w-48 bg-white border border-gray-200 text-center">
              <span class="text-xs font-semibold text-gray-700 uppercase">Rooms</span>
            </th>
            @for (date of dateRange(); track date.key) {
              <th class="sticky top-0 z-20 bg-white border border-gray-200 text-center" [style.width.px]="cellWidthPx()">
                <p class="text-xs font-semibold text-gray-600">{{ date.dayName }}</p>
                <p class="text-sm font-bold text-gray-900">{{ date.day }}</p>
              </th>
            }
          </tr>
        </thead>
        <tbody>
          @for (row of roomsWithReservations(); track $index) {
            @if (row.isGroup) {
              <tr>
                <td class="sticky left-0 z-10 w-48 border border-gray-200 px-4 py-2 text-left bg-gray-100">
                  <span class="text-xs font-semibold text-gray-800">{{ row.roomTypeName }}</span>
                </td>
                @for (date of dateRange(); track date.key) {
                  <td class="border border-gray-200 bg-gray-100" [style.width.px]="cellWidthPx()"></td>
                }
              </tr>
            } @else {
              <tr class="h-12">
                <td class="sticky left-0 z-10 w-48 border border-gray-200 px-4 bg-gray-50 text-xs">
                  {{ row.roomName }}
                </td>
                @for (date of dateRange(); track date.key) {
                  <td 
                    class="border border-gray-200 relative overflow-visible select-none"
                    [class.bg-blue-100]="isCellInSelection(date, row) && !dragSelection().hasConflict"
                    [class.bg-red-100]="isCellInSelection(date, row) && dragSelection().hasConflict"
                    [class.cursor-pointer]="!hasReservationOnDate(row.roomId, date.date)"
                    [class.cursor-not-allowed]="hasReservationOnDate(row.roomId, date.date)"
                    [style.width.px]="cellWidthPx()"
                    (mousedown)="onCellMouseDown($event, date, row)"
                    (mouseenter)="onCellMouseEnter(date, row)"
                    (mouseup)="onCellMouseUp()"
                  >
                    @for (reservation of row.reservations; track $index) {
                      @if (isReservationStartingOnDate(reservation, date)) {
                        <div
                          class="absolute left-0.5 right-0.5 border flex items-center text-white text-xs font-semibold overflow-hidden z-10 cursor-pointer"
                          [ngClass]="getReservationStyle(reservation)"
                          [style.top.%]="getReservationTopPercent(row.reservations, date, reservation)"
                          [style.height.%]="getReservationHeightPercent(row.reservations, date)"
                          [style.width.px]="getReservationWidth(reservation, date)"
                          [matTooltip]="getReservationTooltip(reservation, row.roomName)"
                          matTooltipPosition="above"
                          (click)="openReservationPreview(reservation.reservation, row); $event.stopPropagation()"
                          (mousedown)="$event.stopPropagation()"
                        >
                          <div class="truncate px-1">{{ getReservationBlockLabel(reservation) }} </div>
                        </div>
                      }
                    }
                  </td>
                }
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  </div>
</div>