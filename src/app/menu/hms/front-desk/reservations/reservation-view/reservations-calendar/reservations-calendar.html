<app-page-header 
  title="Reservations" 
  subtitle="Manage hotel reservations and guest bookings"
  [showViewToggle]="true"
  viewToggleRoute="/menu/hms/front-desk/reservations/view">
  
  <ng-container actions>
    <button matButton="outlined" (click)="clearFilters()">
      <mat-icon>clear</mat-icon>
      Clear Filters
    </button>

    <button matButton="outlined" (click)="reloadData()">
      <mat-icon class="mr-1">refresh</mat-icon>
      Reload
    </button>
    
    <button matButton="filled" (click)="createReservation()">
      <mat-icon class="mr-1">add</mat-icon>
      Create Reservation
    </button>
  </ng-container>
  
</app-page-header>

<div class="min-h-screen flex flex-col">
  <!-- Calendar Controls Header -->
  <div class="py-4 px-4">
    <div class="flex justify-between items-center gap-4">
      <div class="flex-1">
        <div class="flex flex-wrap gap-4">
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <mat-icon class="text-base">hotel</mat-icon>
            <span>Total: <strong>{{ reservations.value()?.reservations?.length || 0 }}</strong></span>
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <mat-icon class="text-base text-green-600">check_circle</mat-icon>
            <span>Confirmed: <strong>{{ confirmedCount() || 0 }}</strong></span>
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <mat-icon class="text-base text-purple-600">person</mat-icon>
            <span>Checked In: <strong>{{ checkedInCount() || 0 }}</strong></span>
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <mat-icon class="text-base text-orange-600">schedule</mat-icon>
            <span>Pending: <strong>{{ pendingCount() || 0 }}</strong></span>
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <mat-icon class="text-base text-red-600">cancel</mat-icon>
            <span>Cancelled: <strong>{{ cancelledCount() || 0 }}</strong></span>
          </div>
        </div>
      </div>
      <div class="flex gap-3 items-center">
        <!-- View Mode Menu -->
        <button mat-stroked-button [matMenuTriggerFor]="viewMenu">
          {{ viewMode() | titlecase }}
          <mat-icon class="ml-1">expand_more</mat-icon>
        </button>
        <mat-menu #viewMenu="matMenu">
          <button mat-menu-item (click)="onViewModeChange('weekly')">Weekly</button>
          <button mat-menu-item (click)="onViewModeChange('monthly')">Monthly</button>
        </mat-menu>

        <!-- Status Filter -->
        <button mat-stroked-button [matMenuTriggerFor]="statusMenu">
          Status: {{ selectedStatus() | titlecase }}
          <mat-icon class="ml-1">expand_more</mat-icon>
        </button>
        <mat-menu #statusMenu="matMenu">
          <button mat-menu-item (click)="onStatusChange('all')">All</button>
          @for (s of reservationStatuses; track s) {
            <button mat-menu-item (click)="onStatusChange(s)">{{ s | titlecase }}</button>
          }
        </mat-menu>

        <!-- Navigation -->
        <button matButton="tonal" (click)="previousWeek()">
          <mat-icon class="mr-1">chevron_left</mat-icon>
          Previous
        </button>
        <button matButton color="warn" class="min-w-48">
          {{getPeriodLabel()}}
        </button>
        <button matButton="tonal" (click)="nextWeek()">
          Next
          <mat-icon class="ml-1">chevron_right</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  @if (reservations.isLoading()) {
    <div class="absolute inset-0 z-50 flex items-center justify-center bg-white/60">
      <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
    </div>
  }

  <!-- Calendar Grid Container (single scroll surface) -->
  <div class="flex-1 min-h-96 relative">
    <div class="calendar-scroll">
      <!-- Header Row (sticky top) -->
      <div class="calendar-row calendar-header">
        <div class="calendar-left calendar-cell-left calendar-header-cell">
          <span class="text-xs font-semibold text-gray-700 uppercase">Rooms</span>
        </div>
        <div class="calendar-row-cells" [style.width.px]="dateRange().length * cellWidthPx()">
          @for (date of dateRange(); track date.key) {
            <div
              class="calendar-cell calendar-cell-header"
              [style.width.px]="cellWidthPx()"
              [class.bg-blue-50]="hoveredDateKey() === date.key"
              (mouseenter)="hoveredDateKey.set(date.key)"
              (mouseleave)="hoveredDateKey.set(null)">
              <p class="text-xs font-semibold text-gray-600">{{ date.dayName }}</p>
              <p class="text-sm font-bold text-gray-900">{{ date.day }}</p>
            </div>
          }
        </div>
      </div>

      <!-- Body Rows -->
      @for (row of roomsWithReservations(); track $index) {
        @if (row.isGroup) {
          <div class="calendar-row calendar-group">
            <div class="calendar-left calendar-cell-left calendar-group-cell">
              <span class="text-xs font-semibold text-gray-800">{{ row.roomTypeName }}</span>
            </div>
            <div class="calendar-row-cells" [style.width.px]="dateRange().length * cellWidthPx()">
              @for (date of dateRange(); track date.key) {
                <div
                  class="calendar-cell calendar-cell-group"
                  [style.width.px]="cellWidthPx()"
                  [class.bg-blue-100]="hoveredDateKey() === date.key"
                  (mouseenter)="hoveredDateKey.set(date.key)"
                  (mouseleave)="hoveredDateKey.set(null)">
                </div>
              }
            </div>
          </div>
        } @else {
          <div class="calendar-row calendar-room">
            <div
              class="calendar-left calendar-cell-left calendar-room-cell"
              [ngClass]="getHousekeepingStatusClass(row.housekeepingStatus)"
              [matTooltip]="'Housekeeping: ' + (row.housekeepingStatus | titlecase) + ' (Right-click to change)'"
              matTooltipPosition="right"
              [cdkContextMenuTriggerFor]="housekeepingMenu"
              [cdkContextMenuTriggerData]="{ roomId: row.roomId, currentStatus: row.housekeepingStatus }">
              <span>{{ row.roomName }}</span>
            </div>
            <div class="calendar-row-cells" [style.width.px]="dateRange().length * cellWidthPx()">
              @for (date of dateRange(); track date.key) {
                <div
                  class="calendar-cell calendar-cell-room"
                  [style.width.px]="cellWidthPx()"
                  [class.bg-blue-50]="hoveredDateKey() === date.key && !isCellInSelection(date, row)"
                  [class.bg-blue-100]="isCellInSelection(date, row) && !dragSelection().hasConflict"
                  [class.bg-red-100]="isCellInSelection(date, row) && dragSelection().hasConflict"
                  [class.cursor-pointer]="!hasReservationOnDate(row.roomId, date.date)"
                  [class.cursor-not-allowed]="hasReservationOnDate(row.roomId, date.date)"
                  (mousedown)="onCellMouseDown($event, date, row)"
                  (mouseenter)="onCellMouseEnter(date, row); hoveredDateKey.set(date.key)"
                  (mouseleave)="hoveredDateKey.set(null)"
                  (mouseup)="onCellMouseUp()">
                  @for (reservation of row.reservations; track $index) {
                    @if (shouldRenderReservationFromDate(reservation, date)) {
                      <div
                        class="reservation-block"
                        [style.backgroundColor]="getBookingSourceColor(reservation)"
                        [style.top.%]="getReservationTopPercent(row.reservations, date, reservation)"
                        [style.height.%]="getReservationHeightPercent(row.reservations, date)"
                        [style.width.px]="getReservationWidth(reservation, date)"
                        [matTooltip]="getReservationTooltip(reservation, row.roomName)"
                        matTooltipPosition="above"
                        (click)="openReservationPreview(reservation.reservation, row); $event.stopPropagation()"
                        (mousedown)="$event.stopPropagation()">
                        <div class="reservation-content">
                          <div class="reservation-text">
                            <span class="reservation-nights">{{ getReservationNightsLabel(reservation) }}</span>
                            <span class="reservation-name">{{ getReservationBlockLabel(reservation) }}</span>
                          </div>
                          <div class="reservation-source">
                            @if (getBookingSourceLogoUrl(reservation)) {
                              <img
                                [src]="getBookingSourceLogoUrl(reservation)"
                                [alt]="getBookingSourceLabel(reservation)"
                                class="reservation-source-icon"
                                loading="lazy"
                              />
                            } @else {
                              <mat-icon class="reservation-source-icon">directions_walk</mat-icon>
                            }
                          </div>
                        </div>
                      </div>
                    }
                  }
                </div>
              }
            </div>
          </div>
        }
      }
    </div>
  </div>

  <!-- Legend Footer -->
  <div class="border-t border-gray-200 px-4 py-3 bg-gray-50">
    <div class="flex gap-8">
      <div>
        <p class="text-xs font-semibold text-gray-600 mb-2">Room Status</p>
        <div class="flex gap-4">
          @for (status of housekeepingStatuses; track status.key) {
            <div class="flex items-center gap-2">
              <span class="inline-block w-3 h-3 rounded-sm border-l-2" 
                    [ngClass]="{
                      'bg-green-100 border-l-green-500': status.key === 'clean',
                      'bg-amber-100 border-l-amber-500': status.key === 'dirty',
                      'bg-blue-100 border-l-blue-500': status.key === 'inspected',
                      'bg-red-100 border-l-red-500': status.key === 'out_of_order'
                    }"></span>
              <span class="text-xs text-gray-700">{{ status.label }}</span>
            </div>
          }
        </div>
      </div>
      <div>
        <p class="text-xs font-semibold text-gray-600 mb-2">Reservation Status</p>
        <div class="flex gap-4">
          @for (s of reservationStatuses; track s) {
            <div class="flex items-center gap-2">
              <span class="inline-block w-3 h-3 rounded-sm" [ngClass]="getStatusColorClass(s)"></span>
              <span class="text-xs text-gray-700">{{ s | titlecase }}</span>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Housekeeping Status Context Menu -->
<ng-template #housekeepingMenu let-roomId="roomId" let-currentStatus="currentStatus">
  <div class="bg-white rounded-lg shadow-lg border border-gray-200 py-2 min-w-[200px]" cdkMenu>
    <div class="px-4 py-2 border-b border-gray-100">
      <span class="text-xs font-semibold text-gray-500 uppercase">Update Housekeeping Status</span>
    </div>
    @for (status of housekeepingStatuses; track status.key) {
      <button 
        class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 flex items-center gap-3 transition-colors"
        [class.bg-gray-50]="currentStatus === status.key"
        [class.font-semibold]="currentStatus === status.key"
        cdkMenuItem
        (cdkMenuItemTriggered)="updateHousekeepingStatus(roomId, status.key)">
        <mat-icon class="text-base" [ngClass]="{
          'text-green-600': status.key === 'clean',
          'text-amber-600': status.key === 'dirty',
          'text-blue-600': status.key === 'inspected',
          'text-red-600': status.key === 'out_of_order'
        }">{{ getHousekeepingStatusIcon(status.key) }}</mat-icon>
        <span>{{ status.label }}</span>
        @if (currentStatus === status.key) {
          <mat-icon class="ml-auto text-base text-green-600">check</mat-icon>
        }
      </button>
    }
  </div>
</ng-template>