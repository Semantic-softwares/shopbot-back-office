<mat-card appearance="outlined" class="mb-20!">
  <mat-card-header>
    <mat-card-title>Room Change History</mat-card-title>
    <mat-card-subtitle class="text-gray-500">
      {{ roomChanges().length }} change{{ roomChanges().length !== 1 ? 's' : '' }} recorded
    </mat-card-subtitle>
  </mat-card-header>

  <mat-card-content class="px-0!">
    @if (roomChanges().length === 0) {
      <div class="flex flex-col items-center py-10 text-gray-400">
        <mat-icon class="text-5xl mb-2">swap_horiz</mat-icon>
        <p>No room changes have been made for this reservation.</p>
      </div>
    } @else {
      <div class="overflow-x-auto">
        <table mat-table [dataSource]="roomChanges()" class="min-w-full text-sm">
          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left font-semibold text-gray-700">Status</th>
            <td mat-cell *matCellDef="let change" class="px-4 py-3">
              <mat-icon class="align-middle text-xl"
                [class]="{
                  'text-green-600': change.changeType === 'upgrade',
                  'text-orange-500': change.changeType === 'downgrade',
                  'text-blue-600': change.changeType === 'lateral',
                  'text-red-600': change.changeType === 'maintenance',
                  'text-purple-600': change.changeType === 'guest_request'
                }">
                {{ getChangeTypeIcon(change.changeType) }}
              </mat-icon>
              <mat-chip class="ml-2 px-2 py-1 text-xs font-medium"
                [class]="{
                  'bg-green-50 text-green-700': change.changeType === 'upgrade',
                  'bg-orange-50 text-orange-700': change.changeType === 'downgrade',
                  'bg-blue-50 text-blue-700': change.changeType === 'lateral',
                  'bg-red-50 text-red-700': change.changeType === 'maintenance',
                  'bg-purple-50 text-purple-700': change.changeType === 'guest_request'
                }">
                {{ formatChangeType(change.changeType) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Amount Column -->
          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left font-semibold text-gray-700">Amount</th>
            <td mat-cell *matCellDef="let change" class="px-4 py-3 font-semibold">
              <span [class]="{
                'text-green-600': change.pricingDetails.difference < 0,
                'text-red-600': change.pricingDetails.difference > 0
              }">
                {{ change.pricingDetails.difference >= 0 ? '+' : '' }}{{ change.pricingDetails.difference | currency: storeStore.selectedStore()?.currency:'symbol':'1.0-0' }}
              </span>
              <div class="text-xs text-gray-400">{{ change.pricingDetails.adjustmentType ? formatAdjustmentType(change.pricingDetails.adjustmentType) : '' }}</div>
            </td>
          </ng-container>

          <!-- Type Column -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left font-semibold text-gray-700">Type</th>
            <td mat-cell *matCellDef="let change" class="px-4 py-3">
              <div class="font-mono text-xs text-gray-700">{{ change.fromRoom.roomNumber || 'Room' }} → {{ change.toRoom.roomNumber || 'Room' }}</div>
              <div class="text-xs">{{ getRoomName(change.fromRoom) }} → {{ getRoomName(change.toRoom) }}</div>
            </td>
          </ng-container>

          <!-- Description Column -->
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef class="px-4 py-3 text-left font-semibold text-gray-700">Description</th>
            <td mat-cell *matCellDef="let change" class="px-4 py-3">
              <span>{{ change.reason }}</span>
              @if (change.pricingDetails.adjustmentNotes) {
                <div>
                  <span>{{ change.pricingDetails.adjustmentNotes }}</span>
                </div>
              }
            </td>
          </ng-container>

          <!-- Performer Column -->
          <ng-container matColumnDef="performer">
            <th mat-header-cell *matHeaderCellDef>Performer</th>
            <td mat-cell *matCellDef="let change">
              {{ getPerformerName(change.performedBy) }}
            </td>
          </ng-container>

          <!-- Date Column -->
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let change">
              {{ change.performedAt | date:'medium' }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['status', 'amount', 'type', 'description', 'performer', 'date']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['status', 'amount', 'type', 'description', 'performer', 'date']"></tr>
        </table>
      </div>
    }
  </mat-card-content>
</mat-card>