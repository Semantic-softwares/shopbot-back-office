<!-- Header Section -->
<div class="bg-gradient-to-r from-purple-50 to-indigo-50 border-b border-purple-100">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center py-6">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-1">Guests</h1>
        <p class="text-sm text-gray-600">Manage guest profiles and information</p>
      </div>
      <button 
        class="!bg-gradient-to-r !from-purple-600 !to-purple-700 hover:!from-purple-700 hover:!to-purple-800 !text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 inline-flex items-center gap-2"
        (click)="createGuest()">
        <mat-icon class="text-lg">person_add</mat-icon>
        New Guest
      </button>
    </div>
  </div>
</div>

<!-- Stats Cards -->
<div class="bg-white shadow-sm border-b border-gray-100">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
      <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl border border-purple-200 p-4 shadow-sm hover:shadow-md transition-all duration-200">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
            <mat-icon class="text-white text-xl">people</mat-icon>
          </div>
          <div>
            <div class="text-2xl font-bold text-gray-900">{{ guestStats().total || guests().length }}</div>
            <div class="text-sm font-medium text-gray-600">Total</div>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl border border-amber-200 p-4 shadow-sm hover:shadow-md transition-all duration-200">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-r from-amber-500 to-amber-600 rounded-full flex items-center justify-center shadow-lg">
            <mat-icon class="text-white text-xl">star</mat-icon>
          </div>
          <div>
            <div class="text-2xl font-bold text-gray-900">{{ guestStats().vip || 0 }}</div>
            <div class="text-sm font-medium text-gray-600">VIP</div>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border border-blue-200 p-4 shadow-sm hover:shadow-md transition-all duration-200">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-lg">
            <mat-icon class="text-white text-xl">repeat</mat-icon>
          </div>
          <div>
            <div class="text-2xl font-bold text-gray-900">{{ guestStats().returning || 0 }}</div>
            <div class="text-sm font-medium text-gray-600">Returning</div>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl border border-green-200 p-4 shadow-sm hover:shadow-md transition-all duration-200">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center shadow-lg">
            <mat-icon class="text-white text-xl">person_add</mat-icon>
          </div>
          <div>
            <div class="text-2xl font-bold text-gray-900">{{ guestStats().new || 0 }}</div>
            <div class="text-sm font-medium text-gray-600">New</div>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-teal-50 to-teal-100 rounded-xl border border-teal-200 p-4 shadow-sm hover:shadow-md transition-all duration-200">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-r from-teal-500 to-teal-600 rounded-full flex items-center justify-center shadow-lg">
            <mat-icon class="text-white text-xl">schedule</mat-icon>
          </div>
          <div>
            <div class="text-2xl font-bold text-gray-900">{{ guestStats().recent || 0 }}</div>
            <div class="text-sm font-medium text-gray-600">Recent</div>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl border border-red-200 p-4 shadow-sm hover:shadow-md transition-all duration-200">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-red-600 rounded-full flex items-center justify-center shadow-lg">
            <mat-icon class="text-white text-xl">block</mat-icon>
          </div>
          <div>
            <div class="text-2xl font-bold text-gray-900">{{ guestStats().blacklisted || 0 }}</div>
            <div class="text-sm font-medium text-gray-600">Blacklisted</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filters Section -->
<div class="bg-white border-b border-gray-200">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <form [formGroup]="searchForm">
      <!-- First Row - Search and Filters -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <div class="lg:col-span-2">
          <mat-form-field appearance="outline" class="w-full [&_.mdc-text-field--outlined]:!bg-gray-50 [&_.mdc-text-field--outlined]:!border-gray-200 hover:[&_.mdc-text-field--outlined]:!border-purple-300 [&_.mdc-text-field--focused_.mdc-text-field--outlined]:!border-purple-500">
            <mat-label>Search guests...</mat-label>
            <input matInput 
                   formControlName="search"
                   placeholder="Name, email, or phone"
                   class="!bg-gray-50">
            <mat-icon matPrefix class="text-gray-400">search</mat-icon>
          </mat-form-field>
        </div>

        <div>
          <mat-form-field appearance="outline" class="w-full [&_.mdc-text-field--outlined]:!bg-gray-50 [&_.mdc-text-field--outlined]:!border-gray-200 hover:[&_.mdc-text-field--outlined]:!border-purple-300 [&_.mdc-text-field--focused_.mdc-text-field--outlined]:!border-purple-500">
            <mat-label>Nationality</mat-label>
            <mat-select formControlName="nationality">
              <mat-option value="">All Countries</mat-option>
              <mat-option value="US">United States</mat-option>
              <mat-option value="UK">United Kingdom</mat-option>
              <mat-option value="CA">Canada</mat-option>
              <mat-option value="DE">Germany</mat-option>
              <mat-option value="FR">France</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div>
          <mat-form-field appearance="outline" class="w-full [&_.mdc-text-field--outlined]:!bg-gray-50 [&_.mdc-text-field--outlined]:!border-gray-200 hover:[&_.mdc-text-field--outlined]:!border-purple-300 [&_.mdc-text-field--focused_.mdc-text-field--outlined]:!border-purple-500">
            <mat-label>Guest Type</mat-label>
            <mat-select formControlName="isVip">
              <mat-option value="">All Guests</mat-option>
              <mat-option value="true">VIP Guests</mat-option>
              <mat-option value="false">Regular Guests</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- Second Row - Additional Filters -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <div>
          <mat-form-field appearance="outline" class="w-full [&_.mdc-text-field--outlined]:!bg-gray-50 [&_.mdc-text-field--outlined]:!border-gray-200 hover:[&_.mdc-text-field--outlined]:!border-purple-300 [&_.mdc-text-field--focused_.mdc-text-field--outlined]:!border-purple-500">
            <mat-label>Status</mat-label>
            <mat-select formControlName="blacklisted">
              <mat-option value="">All Status</mat-option>
              <mat-option value="false">Active</mat-option>
              <mat-option value="true">Blacklisted</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- Action Buttons Row -->
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button 
            type="button"
            (click)="clearFilters()"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 flex items-center gap-2">
            <mat-icon class="text-lg">clear</mat-icon>
            Clear Filters
          </button>
          <button 
            type="button"
            (click)="loadGuests()"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 flex items-center gap-2">
            <mat-icon class="text-lg">refresh</mat-icon>
            Refresh
          </button>
        </div>
        <div class="flex items-center text-sm text-gray-600">
          <span>Showing {{ filteredGuests().length }} guests</span>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Loading State -->
@if (loading()) {
  <div class="flex justify-center items-center py-16">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
}

<!-- Guests List -->
@if (!loading()) {
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    @if (filteredGuests().length === 0) {
      <!-- Empty State -->
      <div class="text-center py-16">
        <div class="bg-gray-50 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-4">
          <mat-icon class="text-gray-400 text-4xl">people_outline</mat-icon>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">No guests found</h3>
        <p class="text-gray-600 mb-6">Get started by creating your first guest profile.</p>
        <button 
          class="!bg-gradient-to-r !from-purple-600 !to-purple-700 hover:!from-purple-700 hover:!to-purple-800 !text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 inline-flex items-center gap-2"
          (click)="createGuest()">
          <mat-icon class="text-lg">person_add</mat-icon>
          Create Guest
        </button>
      </div>
    } @else {
      <!-- Guests Table -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  Guest Information
                </th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  Contact Details
                </th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  Stay Statistics
                </th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  Total Spent
                </th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  Last Stay
                </th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  Status
                </th>
                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
              @for (guest of filteredGuests(); track guest._id) {
                <tr class="hover:bg-gray-50 transition-colors duration-200 cursor-pointer" (click)="viewGuestDetails(guest)">
                  <td class="px-6 py-4 whitespace-nowrap border-b border-gray-100">
                    <div class="flex items-center">
                      <div class="flex-shrink-0 h-12 w-12">
                        <div class="h-12 w-12 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg shadow-md ring-2 ring-purple-200">
                          <span>{{ (guest.firstName?.charAt(0) || guest.companyName?.charAt(0) || '?').toUpperCase() }}{{ (guest.lastName?.charAt(0) || guest.companyName?.charAt(1) || '?').toUpperCase() }}</span>
                        </div>
                      </div>
                      <div class="ml-4">
                        <div class="text-sm font-semibold text-gray-900">
                          @if (guest.guestType === 'individual') {
                            {{ guest.firstName }} {{ guest.lastName }}
                          } @else {
                            {{ guest.companyName }}
                          }
                        </div>
                        @if (guest.nationality) {
                          <div class="text-xs text-gray-500 font-medium">
                            {{ guest.nationality }}
                          </div>
                        }
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap border-b border-gray-100">
                    <div>
                      <div class="text-sm font-medium text-gray-900">
                        {{ guest.email }}
                      </div>
                      <div class="text-sm text-gray-600">
                        {{ guest.phone }}
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap border-b border-gray-100">
                    <div class="flex items-center space-x-2">
                      <mat-icon class="text-blue-600 text-lg">hotel</mat-icon>
                      <div>
                        <div class="text-sm font-medium text-gray-900">
                          {{ guest.totalStays || 0 }} stays
                        </div>
                        <div class="text-xs text-gray-500">
                          lifetime visits
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap border-b border-gray-100">
                    <div class="flex items-center space-x-2">
                      <mat-icon class="text-green-600 text-lg">attach_money</mat-icon>
                      <div>
                        <div class="text-sm font-medium text-gray-900">
                          {{ (guest.totalSpent || 0) | currency:(selectedStore()?.currency || 'USD'):'symbol':'1.2-2' }}
                        </div>
                        <div class="text-xs text-gray-500">
                          total revenue
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap border-b border-gray-100">
                    <div class="flex items-center space-x-2">
                      <mat-icon class="text-orange-600 text-lg">schedule</mat-icon>
                      <div>
                        <div class="text-sm font-medium text-gray-900">
                          {{ formatDate(guest.lastStayDate) }}
                        </div>
                        <div class="text-xs text-gray-500">
                          last visit
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap border-b border-gray-100">
                    <div class="flex flex-col space-y-1">
                      <!-- Primary Status Badge -->
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border"
                            [ngClass]="getGuestStatusClass(getGuestStatus(guest))">
                        @if (getGuestStatus(guest) === 'vip') {
                          <mat-icon class="text-xs mr-1">star</mat-icon>
                        }
                        @if (getGuestStatus(guest) === 'blacklisted') {
                          <mat-icon class="text-xs mr-1">block</mat-icon>
                        }
                        @if (getGuestStatus(guest) === 'returning') {
                          <mat-icon class="text-xs mr-1">repeat</mat-icon>
                        }
                        @if (getGuestStatus(guest) === 'new') {
                          <mat-icon class="text-xs mr-1">star_border</mat-icon>
                        }
                        {{ getGuestStatus(guest) | titlecase }}
                      </span>

                      <!-- Additional Status Badges -->
                      @if (guest.isVip && getGuestStatus(guest) !== 'vip') {
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gradient-to-r from-purple-100 to-purple-200 text-purple-800 border border-purple-300">
                          <mat-icon class="text-xs mr-1">star</mat-icon>
                          VIP
                        </span>
                      }
                      @if (guest.blacklisted && getGuestStatus(guest) !== 'blacklisted') {
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gradient-to-r from-red-100 to-red-200 text-red-800 border border-red-300">
                          <mat-icon class="text-xs mr-1">block</mat-icon>
                          Blacklisted
                        </span>
                      }
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium border-b border-gray-100">
                    <div class="flex justify-end" (click)="$event.stopPropagation()">
                      <button 
                        class="text-gray-600 hover:text-gray-800 bg-gray-50 hover:bg-gray-100 p-2 rounded-full transition-all duration-200 border border-gray-200 hover:border-gray-300"
                        [matMenuTriggerFor]="actionsMenu"
                        matTooltip="Actions">
                        <mat-icon class="text-sm">more_vert</mat-icon>
                      </button>
                      <mat-menu #actionsMenu="matMenu">
                        <button mat-menu-item (click)="viewGuestDetails(guest)" [disabled]="isUpdating()">
                          <mat-icon>visibility</mat-icon>
                          <span>View Details</span>
                        </button>
                        <button mat-menu-item (click)="editGuest(guest)" [disabled]="isUpdating()">
                          <mat-icon>edit</mat-icon>
                          <span>Edit Guest</span>
                        </button>
                        <mat-divider></mat-divider>
                        <button mat-menu-item (click)="toggleVipStatus(guest)" [disabled]="isUpdating()">
                          @if (isUpdating()) {
                            <mat-icon class="animate-spin">hourglass_empty</mat-icon>
                          } @else {
                            <mat-icon>{{ guest.isVip ? 'star_border' : 'star' }}</mat-icon>
                          }
                          <span>{{ guest.isVip ? 'Remove VIP' : 'Make VIP' }}</span>
                        </button>
                        <button mat-menu-item (click)="toggleBlacklistStatus(guest)" [disabled]="isUpdating()">
                          @if (isUpdating()) {
                            <mat-icon class="animate-spin">hourglass_empty</mat-icon>
                          } @else {
                            <mat-icon>{{ guest.blacklisted ? 'check_circle' : 'block' }}</mat-icon>
                          }
                          <span>{{ guest.blacklisted ? 'Remove from Blacklist' : 'Add to Blacklist' }}</span>
                        </button>
                        <mat-divider></mat-divider>
                        <button mat-menu-item (click)="deleteGuest(guest)" class="text-red-600" [disabled]="isUpdating()">
                          @if (isUpdating()) {
                            <mat-icon class="animate-spin">hourglass_empty</mat-icon>
                          } @else {
                            <mat-icon>delete</mat-icon>
                          }
                          <span>Delete Guest</span>
                        </button>
                      </mat-menu>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        @if (totalPages() > 1) {
          <div class="px-6 py-4 border-t border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-700 font-medium">
                Showing {{ ((currentPage() - 1) * 20) + 1 }} to {{ Math.min(currentPage() * 20, totalGuests()) }} of {{ totalGuests() }} guests
              </div>
              <div class="flex items-center space-x-2">
                <button 
                  class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                  [disabled]="currentPage() === 1"
                  (click)="onPageChange(currentPage() - 1)">
                  <mat-icon class="text-lg">chevron_left</mat-icon>
                </button>
                @for (page of getPageNumbers(); track page) {
                  <button 
                    class="px-4 py-2 text-sm font-medium rounded-lg transition-all duration-200"
                    [class]="page === currentPage() 
                      ? 'bg-purple-600 text-white shadow-md' 
                      : 'text-gray-700 bg-white border border-gray-300 hover:bg-gray-50'"
                    (click)="onPageChange(page)">
                    {{ page }}
                  </button>
                }
                <button 
                  class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                  [disabled]="currentPage() === totalPages()"
                  (click)="onPageChange(currentPage() + 1)">
                  <mat-icon class="text-lg">chevron_right</mat-icon>
                </button>
              </div>
            </div>
          </div>
        }
      </div>
    }
  </div>
}
