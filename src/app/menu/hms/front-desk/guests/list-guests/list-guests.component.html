<app-page-header title="Guests" subtitle="Manage guest profiles and information">
  <ng-container actions>
    <button matButton="outlined" (click)="clearFilters()">
      <mat-icon>clear</mat-icon>
      Clear Filters
    </button>

    <button matButton="outlined" (click)="reloadData()">
      <mat-icon class="mr-1">refresh</mat-icon>
      Reload
    </button>

    <button matButton="filled" (click)="createGuest()">
      <mat-icon class="mr-1">person_add</mat-icon>
      New Guest
    </button>
  </ng-container>
</app-page-header>

<!-- Stats Cards -->
<div class="max-w-12xl py-6">
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
    <mat-card appearance="outlined">
      <mat-card-content class="p-4!">
        <div class="text-sm text-gray-600">Total</div>
        <div class="text-2xl font-bold">{{ totalGuests() }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined">
      <mat-card-content class="p-4!">
        <div class="text-sm text-gray-600">VIP</div>
        <div class="text-2xl font-bold">{{ vipCount() }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined">
      <mat-card-content class="p-4!">
        <div class="text-sm text-gray-600">Returning</div>
        <div class="text-2xl font-bold">{{ returningCount() }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined">
      <mat-card-content class="p-4!">
        <div class="text-sm text-gray-600">New</div>
        <div class="text-2xl font-bold">{{ newCount() }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined">
      <mat-card-content class="p-4!">
        <div class="text-sm text-gray-600">Recent</div>
        <div class="text-2xl font-bold">{{ recentCount() }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card appearance="outlined">
      <mat-card-content class="p-4!">
        <div class="text-sm text-gray-600">Blacklisted</div>
        <div class="text-2xl font-bold">{{ blacklistedCount() }}</div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<!-- Table Container -->
<mat-card appearance="outlined">
  <div class="p-3">
    <form [formGroup]="filterForm">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <!-- Search Input -->
        <div class="lg:col-span-2">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Search guests...</mat-label>
            <mat-icon matPrefix class="text-gray-400">search</mat-icon>
            <input matInput placeholder="Name, email, or phone" formControlName="search">
          </mat-form-field>
        </div>

        <!-- Status Filter -->
        <div>
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Status</mat-label>
            <mat-select formControlName="status">
              @for (status of statusOptions; track status.value) {
                <mat-option [value]="status.value">{{ status.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Guest Type Filter -->
        <div>
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Guest Type</mat-label>
            <mat-select formControlName="guestType">
              @for (type of guestTypeOptions; track type.value) {
                <mat-option [value]="type.value">{{ type.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
      </div>
    </form>
  </div>

  @if (guests.hasValue()) {
    @if (guests.value()!.guests!.length > 0) {
      <table mat-table [dataSource]="guests.value()!.guests" class="w-full">

        <!-- Guest Information Column -->
        <ng-container matColumnDef="guest">
          <th mat-header-cell *matHeaderCellDef>Guest</th>
          <td mat-cell *matCellDef="let guest">
            <div class="flex items-center">
              <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-white font-bold mr-3">
                {{ getGuestInitials(guest) }}
              </div>
              <div>
                <div class="font-medium">{{ getGuestName(guest) }}</div>
                @if (guest.nationality) {
                  <div class="text-xs text-gray-500">{{ guest.nationality }}</div>
                }
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef>Email</th>
          <td mat-cell *matCellDef="let guest">
            <div class="text-sm">{{ guest.email }}</div>
          </td>
        </ng-container>

        <!-- Phone Column -->
        <ng-container matColumnDef="phone">
          <th mat-header-cell *matHeaderCellDef>Phone</th>
          <td mat-cell *matCellDef="let guest">
            <div class="text-sm">{{ guest.phone }}</div>
          </td>
        </ng-container>

        <!-- Stats Column -->
        <ng-container matColumnDef="stats">
          <th mat-header-cell *matHeaderCellDef>Stays</th>
          <td mat-cell *matCellDef="let guest">
            <div class="font-medium">{{ guest.totalStays || 0 }} stays</div>
          </td>
        </ng-container>

        <!-- Spent Column -->
        <ng-container matColumnDef="spent">
          <th mat-header-cell *matHeaderCellDef>Total Spent</th>
          <td mat-cell *matCellDef="let guest">
            <div class="font-bold">{{ (guest.totalSpent || 0) | currency:(storeStore.selectedStore()?.currency || 'USD') }}</div>
          </td>
        </ng-container>

        <!-- Last Stay Column -->
        <ng-container matColumnDef="lastStay">
          <th mat-header-cell *matHeaderCellDef>Last Stay</th>
          <td mat-cell *matCellDef="let guest">
            {{ formatDate(guest.lastStayDate) }}
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let guest">
            <mat-chip [ngClass]="getStatusChipClass(getGuestStatus(guest))">
              {{ getGuestStatus(guest) | titlecase }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let guest">
            <button mat-icon-button [matMenuTriggerFor]="actionMenu" (click)="$event.stopPropagation()">
              <mat-icon>more_vert</mat-icon>
            </button>

            <mat-menu #actionMenu="matMenu">
              <button mat-menu-item (click)="viewGuestDetails(guest)" [disabled]="isUpdating()">
                <mat-icon>visibility</mat-icon>
                <span>View Details</span>
              </button>
              @if (canEdit(guest)) {
                <button mat-menu-item (click)="editGuest(guest)" [disabled]="isUpdating()">
                  <mat-icon>edit</mat-icon>
                  <span>Edit Guest</span>
                </button>
              }
              <mat-divider></mat-divider>
              <button mat-menu-item (click)="toggleVipStatus(guest)" [disabled]="isUpdating()">
                <mat-icon>{{ guest.isVip ? 'star_border' : 'star' }}</mat-icon>
                <span>{{ guest.isVip ? 'Remove VIP' : 'Make VIP' }}</span>
              </button>
              <button mat-menu-item (click)="toggleBlacklistStatus(guest)" [disabled]="isUpdating()">
                <mat-icon>{{ guest.blacklisted ? 'check_circle' : 'block' }}</mat-icon>
                <span>{{ guest.blacklisted ? 'Remove from Blacklist' : 'Add to Blacklist' }}</span>
              </button>
              @if (canDelete(guest)) {
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="deleteGuest(guest)" [disabled]="isUpdating()">
                  <mat-icon color="warn">delete</mat-icon>
                  <span>Delete Guest</span>
                </button>
              }
            </mat-menu>
          </td>
        </ng-container>

        <!-- Header and Row Definitions -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let guest; columns: displayedColumns;" class="cursor-pointer"
          (click)="viewGuestDetails(guest)"></tr>
      </table>

      <mat-card-actions class="flex justify-end">
        <mat-paginator 
          [length]="totalGuests()" 
          [pageSize]="pageSize()" 
          [pageSizeOptions]="[5, 10, 25, 50]"
          [pageIndex]="currentPage() - 1" 
          (page)="onPageChange($event)" 
          showFirstLastButtons>
        </mat-paginator>
      </mat-card-actions>
    }

    @if (guests.value()!.guests!.length === 0) {
      <div class="py-20 text-center">
        <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
          <mat-icon class="text-4xl text-gray-400">people</mat-icon>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">No guests found</h3>
        <p class="text-gray-500 mb-6">
          {{ filterForm.get('search')?.value
            ? 'Try adjusting your search to find matching guests.'
            : 'Get started by creating your first guest profile.' }}
        </p>
        <button matButton="filled" (click)="createGuest()">
          <mat-icon>person_add</mat-icon>
          Create New Guest
        </button>
      </div>
    }
  }

  @if (guests.error()) {
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 m-4">
      <div class="flex">
        <mat-icon class="text-red-500 mr-2">error</mat-icon>
        <div>
          <h3 class="text-red-800 font-medium">Error loading guests</h3>
          <p class="text-red-700 text-sm mt-1">{{ guests.error() }}</p>
          <div class="mt-3 flex space-x-3">
            <button mat-button color="warn" (click)="reloadData()" class="!text-red-600">
              <mat-icon class="mr-1">refresh</mat-icon>
              Retry
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  @if (guests.isLoading()) {
    <div class="flex items-center justify-center py-20">
      <mat-spinner diameter="48"></mat-spinner>
    </div>
  }
</mat-card>
