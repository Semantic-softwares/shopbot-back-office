<!-- Page Header -->
<app-page-header 
  title="Rates & Availability" 
  description="Manage room rates and availability by date for Channex distribution">
</app-page-header>

<div class=" space-y-6">
  <!-- Date Range Selection Card -->
  <mat-card appearance="outlined">
    <mat-card-header class="border-b border-gray-200 px-6 py-4">
      <h3 class="text-lg font-semibold text-gray-900">Date Range Selection</h3>
    </mat-card-header>

    <mat-card-content class="p-6 space-y-4">
      <!-- Quick Select Buttons -->
      <div class="flex flex-wrap gap-2 my-4">
        <button 
          mat-stroked-button 
          (click)="selectDateRange(7)"
          class="text-sm">
          7 Days
        </button>
        <button 
          mat-stroked-button 
          (click)="selectDateRange(14)"
          class="text-sm">
          14 Days
        </button>
        <button 
          mat-stroked-button 
          (click)="selectDateRange(30)"
          class="text-sm">
          30 Days
        </button>
      </div>

      <!-- Custom Date Range Form -->
      <form [formGroup]="dateRangeForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Start Date -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Start Date</mat-label>
          <input 
            matInput 
            [matDatepicker]="startPicker"
            formControlName="startDate">
          <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <!-- End Date -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>End Date</mat-label>
          <input 
            matInput 
            [matDatepicker]="endPicker"
            formControlName="endDate">
          <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>

        <!-- Currency Selection -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Currency</mat-label>
          <mat-select [value]="getSelectedCurrency()">
            <mat-option value="NGN">NGN (₦)</mat-option>
            <mat-option value="USD">USD ($)</mat-option>
            <mat-option value="EUR">EUR (€)</mat-option>
            <mat-option value="GBP">GBP (£)</mat-option>
          </mat-select>
        </mat-form-field>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Calendar View Card -->
  <mat-card appearance="outlined">
    <mat-card-header class="border-b border-gray-200 px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <button 
          mat-icon-button 
          (click)="navigateToPreviousPeriod()"
          matTooltip="Previous period">
          <mat-icon>chevron_left</mat-icon>
        </button>

        <span class="font-medium text-gray-700 whitespace-nowrap">
          {{ (getCalendarDates()[0] | date:'MMM d') }} - {{ (getCalendarDates()[getCalendarDates().length - 1] | date:'MMM d, yyyy') }}
        </span>

        <button 
          mat-icon-button 
          (click)="navigateToNextPeriod()"
          matTooltip="Next period">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>

      <div class="flex items-center gap-2">
        <button 
          mat-icon-button 
          (click)="toggleEditMode()"
          matTooltip="Toggle edit mode">
          <mat-icon>{{ getEditMode() ? 'lock_open' : 'lock' }}</mat-icon>
        </button>
      </div>
    </mat-card-header>

    <mat-card-content class="p-6">
      <!-- Loading State -->
      @if (getIsLoading()) {
        <div class="flex items-center justify-center py-12">
          <mat-spinner diameter="40"></mat-spinner>
          <span class="ml-4 text-gray-600">Loading room types...</span>
        </div>
      }

      <!-- Error State -->
      @if (getError()) {
        <div class="bg-red-50 border border-red-200 rounded-md p-4 text-red-700">
          <p class="font-medium">Failed to load room types</p>
          <p class="text-sm mt-1">{{ getError() | json }}</p>
        </div>
      }

      <!-- Calendar Grid -->
      @if (!getIsLoading() && !getError() && getCalendarDates().length > 0) {
        <div class="overflow-x-auto">
          <table class="min-w-full border-collapse border border-gray-200">
          <!-- Header Row with Dates -->
          <thead>
            <tr class="bg-gray-50 border-b border-gray-200">
              <th class="px-4 py-3 text-left font-semibold text-gray-700 border-r border-gray-200 sticky left-0 bg-gray-50 w-48">
                Room Type
              </th>

              <!-- Date Column Headers -->
              @for (date of getCalendarDates(); track $index) {
                <th 
                  class="px-3 py-2 text-center font-medium text-gray-600 text-xs whitespace-nowrap border-r border-gray-200">
                  <div class="font-semibold text-gray-900">{{ date | date:'EEE' }}</div>
                  <div class="text-gray-500">{{ date | date:'d' }}</div>
                </th>
              }
            </tr>
          </thead>

          <!-- Room Type Rows -->
          <tbody>
            @for (roomType of getRoomTypes(); track roomType._id || roomType.id || '') {
              <!-- Rates Row -->
              <tr class="border-b border-gray-200 hover:bg-blue-50" [class.bg-blue-50]="getEditMode()">
                <td class="px-4 py-3 font-medium text-gray-900 border-r border-gray-200 sticky left-0 bg-white">
                  <div class="text-sm font-semibold">{{ roomType.name }}</div>
                  <div class="text-xs text-gray-500 mt-1">Rate {{ getCurrencySymbol(getSelectedCurrency()) }}</div>
                </td>

                <!-- Rate Cells -->
                @for (date of getCalendarDates(); track $index) {
                  <td 
                    class="px-2 py-2 border-r border-gray-200 text-center">
                    @if (getEditMode()) {
                      <input 
                        type="number" 
                        min="0" 
                        step="0.01"
                        [value]="getRate(roomType._id || roomType.id || '', date) | number:'1.0-2'"
                        (change)="updateRate(roomType._id || roomType.id || '', date, +$event.target.value)"
                        placeholder="0"
                        class="w-16 px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                    }

                    @if (!getEditMode()) {
                      <span class="text-sm font-medium text-gray-900">
                        {{ getRate(roomType._id || roomType.id || '', date) | number:'1.0-2' }}
                      </span>
                    }
                  </td>
                }
              </tr>

              <!-- Availability Row -->
              <tr class="border-b border-gray-200 bg-gray-50" [class.bg-blue-100]="getEditMode()">
                <td class="px-4 py-2 border-r border-gray-200 sticky left-0 bg-gray-50">
                  <div class="text-xs text-gray-600">Availability</div>
                </td>

                <!-- Availability Cells -->
                @for (date of getCalendarDates(); track $index) {
                  <td 
                    class="px-2 py-2 border-r border-gray-200 text-center">
                    @if (getEditMode()) {
                      <input 
                        type="number" 
                        min="0" 
                        step="1"
                        [value]="getAvailability(roomType._id || roomType.id || '', date)"
                        (change)="updateAvailability(roomType._id || roomType.id || '', date, +$event.target.value)"
                        placeholder="0"
                        class="w-16 px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                    }

                    @if (!getEditMode()) {
                      <span class="text-sm font-medium text-gray-600">
                        {{ getAvailability(roomType._id || roomType.id || '', date) }}
                      </span>
                    }
                  </td>
                }
              </tr>
            }
          </tbody>
          </table>
        </div>
      }

      <!-- Empty State -->
      @if (!getIsLoading() && !getError() && getCalendarDates().length === 0) {
        <div class="text-center py-12">
          <mat-icon class="text-gray-400 mx-auto" style="font-size: 48px; width: 48px; height: 48px;">calendar_today</mat-icon>
          <p class="text-gray-600 mt-4">Select a date range to view the calendar</p>
        </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- Action Buttons -->
  <div class="flex gap-3 justify-end">
    <button 
      mat-stroked-button 
      (click)="resetChanges()"
      [disabled]="!getEditMode() || getIsSaving()"
      class="text-gray-700">
      <mat-icon matButtonIcon>clear</mat-icon>
      Reset
    </button>

    <button 
      matButton="filled"
      color="primary"
      (click)="saveChanges()"
      [disabled]="!getEditMode() || getIsSaving()"
      class="relative">
      {{getIsSaving() ? 'Saving...' : 'Save Changes' }}
    </button>
  </div>

  <!-- Status Message -->
  @if (getSaveStatus() === 'success') {
    <div class="bg-green-50 border border-green-200 rounded-md p-4 text-green-700 flex items-center gap-3 animate-in fade-in duration-300">
      <mat-icon class="text-green-600">check_circle</mat-icon>
      <div>
        <p class="font-medium">Rates synced successfully</p>
        <p class="text-sm">Your changes have been pushed to Channex and will be distributed to OTA partners.</p>
      </div>
    </div>
  }

  @if (getSaveStatus() === 'error') {
    <div class="bg-red-50 border border-red-200 rounded-md p-4 text-red-700 flex items-center gap-3 animate-in fade-in duration-300">
      <mat-icon class="text-red-600">error</mat-icon>
      <div>
        <p class="font-medium">Failed to sync rates</p>
        <p class="text-sm">Please check your connection and try again.</p>
      </div>
    </div>
  }
