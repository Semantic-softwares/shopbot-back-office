<app-page-header 
  [title]="'Live Bookings'"
    [subtitle]="'Manage and monitor your live bookings from various OTA providers in one centralized location.'"
>

</app-page-header>

<div class="container">
  <!-- Filters Card -->
  <mat-card class="filters-card" appearance="outlined">
    <mat-card-header>
      <mat-card-title>Filters</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="filterForm" class="filters-grid">
        <!-- Search Filter -->
        <mat-form-field appearance="outline">
          <mat-label>Search by Customer or Booking ID</mat-label>
          <input matInput formControlName="search" placeholder="Search..." />
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <!-- OTA Filter -->
        <mat-form-field appearance="outline">
          <mat-label>OTA Providers</mat-label>
          <mat-select formControlName="otaCodes" multiple>
            @for (ota of otaOptions; track ota.value) {
              <mat-option [value]="ota.value">
                {{ ota.label }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <!-- Status Filter -->
        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            @for (status of statusOptions; track status.value) {
              <mat-option [value]="status.value">
                {{ status.label }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <!-- Arrival Date Range -->
        <mat-form-field appearance="outline">
          <mat-label>Arrival Date Range</mat-label>
          <mat-date-range-input [formGroup]="arrivalDateRange" [rangePicker]="arrivalRangePicker">
            <input matStartDate formControlName="start" placeholder="From date">
            <input matEndDate formControlName="end" placeholder="To date">
          </mat-date-range-input>
          <mat-datepicker-toggle matIconSuffix [for]="arrivalRangePicker"></mat-datepicker-toggle>
          <mat-date-range-picker #arrivalRangePicker></mat-date-range-picker>
        </mat-form-field>

        <!-- Departure Date Range -->
        <mat-form-field appearance="outline">
          <mat-label>Departure Date Range</mat-label>
          <mat-date-range-input [formGroup]="departureDateRange" [rangePicker]="departureRangePicker">
            <input matStartDate formControlName="start" placeholder="From date">
            <input matEndDate formControlName="end" placeholder="To date">
          </mat-date-range-input>
          <mat-datepicker-toggle matIconSuffix [for]="departureRangePicker"></mat-datepicker-toggle>
          <mat-date-range-picker #departureRangePicker></mat-date-range-picker>
        </mat-form-field>

        <!-- Booking Date Range -->
        <mat-form-field appearance="outline">
          <mat-label>Booking Date Range</mat-label>
          <mat-date-range-input [formGroup]="bookingDateRange" [rangePicker]="bookingRangePicker">
            <input matStartDate formControlName="start" placeholder="From date">
            <input matEndDate formControlName="end" placeholder="To date">
          </mat-date-range-input>
          <mat-datepicker-toggle matIconSuffix [for]="bookingRangePicker"></mat-datepicker-toggle>
          <mat-date-range-picker #bookingRangePicker></mat-date-range-picker>
        </mat-form-field>

        <!-- Action Buttons -->
        <div class="filter-actions">
          <button matButton="filled" color="primary" (click)="refreshBookings()">
            <mat-icon>refresh</mat-icon>
            Apply Filters
          </button>
          <button matButton="outlined" (click)="clearFilters()">
            <mat-icon>clear</mat-icon>
            Clear
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Results Card -->
  <mat-card class="results-card" appearance="outlined">
    <mat-card-content>
      @if (liveBookings.isLoading()) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
          <p>Loading live bookings...</p>
        </div>
      } @else if (liveBookings.error()) {
        <div class="error-container">
          <mat-icon>error</mat-icon>
          <p>{{ liveBookings.error()?.message }}</p>
          <button mat-raised-button color="primary" (click)="refreshBookings()">
            Retry
          </button>
        </div>
      } @else {
        <!-- Table -->
        <div class="table-container">
          <table mat-table [dataSource]="bookingsList">
            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let booking">
                <mat-chip
                  [color]="getStatusChip(booking.status).color"
                  selected
                  matTooltip="Booking Status"
                >
                  {{ booking.status | uppercase }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Unique ID Column -->
            <ng-container matColumnDef="uniqueId">
              <th mat-header-cell *matHeaderCellDef>Unique ID</th>
              <td mat-cell *matCellDef="let booking">
                <span class="font-weight-500">{{ booking.uniqueId }}</span>
              </td>
            </ng-container>

            <!-- Source Column -->
            <ng-container matColumnDef="source">
              <th mat-header-cell *matHeaderCellDef>Source</th>
              <td mat-cell *matCellDef="let booking">
                <span class="font-weight-500">{{ booking.otaName }}</span>
              </td>
            </ng-container>

            <!-- Customer Column -->
            <ng-container matColumnDef="customerName">
              <th mat-header-cell *matHeaderCellDef>Customer</th>
              <td mat-cell *matCellDef="let booking">
                <div class="customer-info">
                  <strong>{{ booking.customerName?.name }} {{ booking.customerName?.surname }}</strong>
                </div>
              </td>
            </ng-container>

            <!-- Dates Column -->
            <ng-container matColumnDef="dates">
              <th mat-header-cell *matHeaderCellDef>Dates</th>
              <td mat-cell *matCellDef="let booking">
                <div class="date-range" [routerLink]="['../../live-booking', booking.id, 'details']">
                  {{ getDateRange(booking.arrivalDate, booking.departureDate) }}
                </div>
              </td>
            </ng-container>

            <!-- Rooms Count Column -->
            <ng-container matColumnDef="roomsCount">
              <th mat-header-cell *matHeaderCellDef>Rooms</th>
              <td mat-cell *matCellDef="let booking">
                <mat-chip selected>{{ booking.roomsCount }}</mat-chip>
              </td>
            </ng-container>

           

            <!-- Total Column -->
            <ng-container matColumnDef="total">
              <th mat-header-cell *matHeaderCellDef>Total</th>
              <td mat-cell *matCellDef="let booking">
                <span class="font-weight-500">
                 {{ booking.amount | currency: booking.currency }} 
                </span>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let booking">
                
                <button
                  mat-icon-button
                  matTooltip="More Actions"
                  [matMenuTriggerFor]="menu"
                >
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #menu="matMenu">
                  <button mat-menu-item (click)="viewBookingDetails(booking)">
                    <mat-icon>open_in_new</mat-icon>
                    <span>View Full Details</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>

            <!-- Header and Rows -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let booking; columns: displayedColumns;"></tr>
          </table>
        </div>

        <!-- Paginator -->
        <mat-paginator
          #paginator
          [length]="pagination.total"
          [pageSize]="pageSize()"
          [pageIndex]="currentPage() - 1"
          [pageSizeOptions]="[10, 20, 50, 100]"
          (page)="onPageChange($event)"
          showFirstLastButtons
        >
        </mat-paginator>
      }
    </mat-card-content>
  </mat-card>
</div>
