<!-- Header Section -->
<app-page-header 
  [title]="orderResource.hasValue() ? 'Receipt #' + orderResource.value().reference : 'Receipt Details'"
  [subtitle]="orderResource.hasValue() ? 'Created on ' + (orderResource.value().createdAt | date: 'medium') : 'Loading receipt...'">
  <ng-container actions>
    <button mat-stroked-button (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      Back
    </button>

    @if (orderResource.hasValue() && !orderResource.isLoading()) {
      <button
        matButton="outlined"
        [matMenuTriggerFor]="exportMenu"
        [disabled]="exporting()">
        <mat-icon>{{exporting() ? 'refresh' : 'print'}}</mat-icon> {{exporting() ? 'Exporting...' : 'Export'}}
      </button>
      
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportReceipt()">
          <mat-icon>receipt</mat-icon>
          <span>Generate Receipt</span>
        </button>
        <button mat-menu-item (click)="exportInvoice()">
          <mat-icon>description</mat-icon>
          <span>Generate Invoice</span>
        </button>
      </mat-menu>
    }
  </ng-container>
</app-page-header>

<!-- Loading State -->
@if (orderResource.isLoading()) {
  <div class="flex justify-center items-center py-20">
    <mat-spinner diameter="50"></mat-spinner>
  </div>
}

<!-- Error State -->
@if (orderResource.error()) {
  <div class="max-w-7xl mx-auto px-4 py-8">
    <mat-card appearance="outlined">
      <mat-card-content class="text-center py-8">
        <mat-icon class="!text-6xl text-red-500 mb-4">error_outline</mat-icon>
        <h3 class="text-lg font-semibold mb-2">Failed to Load Receipt</h3>
        <p class="text-gray-600 mb-4">{{ orderResource.error()?.message || 'An error occurred' }}</p>
        <button mat-flat-button color="warn" (click)="goBack()">
          Back to Receipts
        </button>
      </mat-card-content>
    </mat-card>
  </div>
}

<!-- Receipt Content -->
@if (orderResource.hasValue() && !orderResource.isLoading()) {
  @let order = orderResource.value();
  
  <div class="max-w-12xl mx-auto px-4 py-6">
    
    <!-- Scheduled Delivery Alert -->
    @if (order.deliveryTime?.name === 'Schedule Delivery') {
      <mat-card appearance="outlined" class="mb-4 !border-l-4 !border-l-blue-500">
        <mat-card-content class="flex items-center gap-3 py-3">
          <mat-icon class="text-blue-600">schedule</mat-icon>
          <div>
            <h3 class="font-medium">Scheduled Delivery</h3>
            <p class="text-sm text-gray-600">
              This order is scheduled for <strong>{{ order.deliveryTime.date }}</strong> at <strong>{{ order.deliveryTime.time }}</strong>
            </p>
          </div>
        </mat-card-content>
      </mat-card>
    }

    <!-- Gift Order Alert -->
    @if (order.gift) {
      <mat-card appearance="outlined" class="mb-4 !border-l-4 !border-l-pink-500">
        <mat-card-content class="flex items-center gap-3 py-3">
          <mat-icon class="text-pink-600">card_giftcard</mat-icon>
          <div>
            <h3 class="font-medium">üéÅ Gift Order</h3>
            <p class="text-sm text-gray-600">
              This is a gift order {{ order.receiver?.surprise ? '(Surprise)' : '' }}
            </p>
          </div>
        </mat-card-content>
      </mat-card>
    }
    
    <!-- Status Banner -->
    <mat-card appearance="outlined" class="mb-4">
      <mat-card-content class="py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            
            <div>
              <h2 class="text-2xl font-bold">{{ order.reference }}</h2>
              <p class="text-sm text-gray-600">
                Created on {{ order.createdAt | date: 'medium' }}
              </p>
            </div>
          </div>
          <div class="text-right space-y-2">
            <div class="flex gap-2 justify-end">
              <mat-chip 
                [class.!bg-green-100]="order.category === 'complete'"
                [class.!text-green-800]="order.category === 'complete'"
                [class.!bg-yellow-100]="order.category === 'pending'"
                [class.!text-yellow-800]="order.category === 'pending'"
                [class.!bg-red-100]="order.category === 'cancel'"
                [class.!text-red-800]="order.category === 'cancel'">
                {{ order.category | titlecase }}
              </mat-chip>
              @if (order.salesChannel) {
                <mat-chip class="!bg-blue-100 !text-blue-800">
                  {{ order.salesChannel }}
                </mat-chip>
              }
            </div>
            
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- Main Content Column -->
      <div class="lg:col-span-2 space-y-6">
        
        <!-- Order Information -->
        <mat-card appearance="outlined">
          <mat-card-header>
            <mat-card-title>
              Order Information
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Order Reference</label>
                <div class="text-lg font-semibold">{{ order.reference }}</div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Order Date</label>
                <div class="text-sm">{{ order.createdAt | date: 'medium' }}</div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                <div class="text-sm">{{ order.payment | titlecase }}</div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                <mat-chip 
                  [class.!bg-green-100]="order.paymentStatus === 'paid'"
                  [class.!text-green-800]="order.paymentStatus === 'paid'"
                  [class.!bg-yellow-100]="order.paymentStatus === 'pending'"
                  [class.!text-yellow-800]="order.paymentStatus === 'pending'"
                  [class.!bg-red-100]="order.paymentStatus === 'failed'"
                  [class.!text-red-800]="order.paymentStatus === 'failed'">
                  {{ order.paymentStatus | titlecase }}
                </mat-chip>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Order Type</label>
                <div class="text-sm">{{ order.orderType | titlecase }}</div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Type</label>
                <div class="text-sm">{{ order.deliveryType | titlecase }}</div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Products -->
        <mat-card appearance="outlined" class="PY">
          <mat-card-header>
            <mat-card-title>
              Order Items
            </mat-card-title>
          </mat-card-header>
          <mat-card-content class="!p-0">
            <div class="overflow-x-auto py-2">
              <table mat-table [dataSource]="order.cart?.products || []" class="w-full">
                
                <!-- Product Column -->
                <ng-container matColumnDef="product">
                  <th mat-header-cell *matHeaderCellDef>Product</th>
                  <td mat-cell *matCellDef="let item">
                    <div class="flex items-center gap-3 py-2">
                      @if (item.image) {
                        <img [src]="item.image" [alt]="item.name" class="w-12 h-12 rounded object-cover">
                      } @else {
                        <div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center">
                          <mat-icon class="text-gray-400">image</mat-icon>
                        </div>
                      }
                      <div>
                        <div class="font-medium">{{ item.name }}</div>
                        @if (item.description) {
                          <div class="text-xs text-gray-500">{{ item.description }}</div>
                        }
                      </div>
                    </div>
                  </td>
                </ng-container>

                <!-- Options Column -->
                <ng-container matColumnDef="options">
                  <th mat-header-cell *matHeaderCellDef>Options</th>
                  <td mat-cell *matCellDef="let item">
                    @if (item.options && item.options.length > 0) {
                      <div class="space-y-1">
                        @for (option of item.options; track $index) {
                          <mat-chip class="!text-xs">
                            {{ option.name }}
                            @if (option.price) {
                              ({{ option.price | currency: currency() }})
                            }
                            √ó{{ option.quantity }}
                          </mat-chip>
                        }
                      </div>
                    } @else {
                      <span class="text-gray-400">-</span>
                    }
                  </td>
                </ng-container>

                <!-- Quantity Column -->
                <ng-container matColumnDef="quantity">
                  <th mat-header-cell *matHeaderCellDef class="text-center">Qty</th>
                  <td mat-cell *matCellDef="let item" class="text-center">
                    <span class="inline-flex items-center justify-center w-8 h-8 bg-indigo-100 text-indigo-700 rounded-full font-semibold text-sm">
                      {{ item.quantity }}
                    </span>
                  </td>
                </ng-container>

                <!-- Price Column -->
                <ng-container matColumnDef="price">
                  <th mat-header-cell *matHeaderCellDef class="text-right">Price</th>
                  <td mat-cell *matCellDef="let item" class="text-right font-medium">
                    {{ item.price | currency: currency() }}
                  </td>
                </ng-container>

                <!-- Subtotal Column -->
                <ng-container matColumnDef="subtotal">
                  <th mat-header-cell *matHeaderCellDef class="text-right">Subtotal</th>
                  <td mat-cell *matCellDef="let item" class="text-right font-bold">
                    {{ getProductSubtotal(item) | currency: currency() }}
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['product', 'options', 'quantity', 'price', 'subtotal']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['product', 'options', 'quantity', 'price', 'subtotal'];"></tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>

      </div>

      <!-- Sidebar Column -->
      <div class="space-y-6">
        
        <!-- Customer Information -->
        @if (order.user) {
          <mat-card appearance="outlined">
            <mat-card-header>
              <mat-card-title>
                Customer
              </mat-card-title>
            </mat-card-header>
            <mat-card-content class="!p-0">
              <mat-list>
                <mat-list-item>
                  <span matListItemTitle>Name</span>
                  <span matListItemMeta>{{ order.user?.name || 'N/A' }}</span>
                </mat-list-item>
                <mat-list-item>
                  <span matListItemTitle>Phone</span>
                  <span matListItemMeta>{{ order.user?.phoneNumber || 'N/A' }}</span>
                </mat-list-item>
                <mat-list-item>
                  <span matListItemTitle>Email</span>
                  <span matListItemMeta class="break-all">{{ order.user?.email || 'N/A' }}</span>
                </mat-list-item>
              </mat-list>
            </mat-card-content>
          </mat-card>
        }

        <!-- Guest Information -->
        @if (order.guest) {
          <mat-card appearance="outlined">
            <mat-card-header>
              <mat-card-title class="flex items-center gap-2">
                <mat-icon>person</mat-icon>
                Guest
              </mat-card-title>
            </mat-card-header>
            <mat-card-content class="!p-0">
              <mat-list>
                <mat-list-item>
                  <span matListItemTitle>Name</span>
                  <span matListItemMeta>{{ order.guest?.firstName }} {{ order.guest?.lastName }}</span>
                </mat-list-item>
                <mat-list-item>
                  <span matListItemTitle>Phone</span>
                  <span matListItemMeta>{{ order.guest?.phone || 'N/A' }}</span>
                </mat-list-item>
                <mat-list-item>
                  <span matListItemTitle>Email</span>
                  <span matListItemMeta class="break-all">{{ order.guest?.email || 'N/A' }}</span>
                </mat-list-item>
                @if (order.guest?.nationality) {
                  <mat-list-item>
                    <span matListItemTitle>Nationality</span>
                    <span matListItemMeta>{{ order.guest?.nationality }}</span>
                  </mat-list-item>
                }
                @if (order.reservation) {
                  <mat-list-item>
                    <span matListItemTitle>Reservation</span>
                    <span matListItemMeta>
                      <a [routerLink]="['/menu/hms/front-desk/reservations', order.reservation]" 
                         class="font-medium text-indigo-600 hover:text-indigo-800 underline">
                        View Reservation
                      </a>
                    </span>
                  </mat-list-item>
                }
              </mat-list>
            </mat-card-content>
          </mat-card>
        }

        <!-- Staff Information -->
        @if (order.staff) {
          <mat-card appearance="outlined">
            <mat-card-header>
              <mat-card-title class="flex items-center gap-2">
                Staff
              </mat-card-title>
            </mat-card-header>
            <mat-card-content class="!p-0">
              <mat-list>
                <mat-list-item>
                  <span matListItemTitle>Name</span>
                  <span matListItemMeta>{{ order.staff?.name || 'N/A' }}</span>
                </mat-list-item>
                <mat-list-item>
                  <span matListItemTitle>Phone</span>
                  <span matListItemMeta>{{ order.staff?.phoneNumber || 'N/A' }}</span>
                </mat-list-item>
                <mat-list-item>
                  <span matListItemTitle>Email</span>
                  <span matListItemMeta class="break-all">{{ order.staff?.email || 'N/A' }}</span>
                </mat-list-item>
              </mat-list>
            </mat-card-content>
          </mat-card>
        }

        <!-- Gift Receiver Information -->
        @if (order.gift && order.receiver) {
          <mat-card appearance="outlined" class="!border-l-4 !border-l-pink-500">
            <mat-card-header>
              <mat-card-title class="flex items-center gap-2">
                Gift Receiver
                @if (order.receiver.surprise) {
                  <mat-chip class="!text-xs !bg-pink-100 !text-pink-700">Surprise</mat-chip>
                }
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="space-y-4 mt-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                  <div class="text-sm">{{ order.receiver.name || 'N/A' }}</div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                  <div class="text-sm">{{ order.receiver.phoneNumber || 'N/A' }}</div>
                </div>
                @if (order.receiver.address) {
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Address</label>
                    <div class="text-sm">
                      {{ order.receiver.address.name }} {{ order.receiver.address.administrativeArea }} {{ order.receiver.address.locality }}
                    </div>
                  </div>
                }
                @if (order.receiver.note) {
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gift Note</label>
                    <div class="text-sm bg-pink-50 p-3 rounded border border-pink-100">{{ order.receiver.note }}</div>
                  </div>
                }
              </div>
            </mat-card-content>
          </mat-card>
        }

        <!-- Shipping Information -->
        @if (order.shipping) {
          <mat-card appearance="outlined">
            <mat-card-header>
              <mat-card-title>
                Shipping
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="space-y-3 mt-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                  <div class="text-sm">{{ order.shipping?.name || 'N/A' }}</div>
                </div>
                @if (order.shipping?.phone) {
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact Phone</label>
                    <div class="text-sm">{{ order.shipping.phone }}</div>
                  </div>
                }
              </div>
            </mat-card-content>
          </mat-card>
        }

        <!-- Order Summary -->
        <mat-card appearance="outlined">
          <mat-card-header>
            <mat-card-title>
              Order Summary
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="space-y-3 mt-4">
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Subtotal:</span>
                <span class="font-medium">{{ order.subTotal | currency: currency() }}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Service Fee:</span>
                <span class="font-medium">{{ order.serviceFee | currency: currency() }}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Shipping Fee:</span>
                <span class="font-medium">{{ order.shippingFee | currency: currency() }}</span>
              </div>
              @if (order.discount) {
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">Discount:</span>
                  <span class="font-medium text-green-600">-{{ order.discount | currency: currency() }}</span>
                </div>
              }
              
              
              @if (order.driverTip) {
                <div class="border-t border-gray-300 pt-3 mt-3">
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-700 flex items-center gap-1">
                      <mat-icon class="!text-base text-amber-500">local_taxi</mat-icon>
                      Driver Tip:
                    </span>
                    <span class="font-semibold text-amber-600">{{ order.driverTip | currency: currency() }}</span>
                  </div>
                </div>
              }
            </div>
          </mat-card-content>
          <mat-card-actions class="border-t border-outline-variant mt-4 pt-4">
            <div class="flex justify-between w-full text-lg">
              <span class="font-bold">Total:</span>
              <span class="font-bold  text-right">{{ order.total | currency: currency() }}</span>
            </div>
          </mat-card-actions>
        </mat-card>

        <!-- Commission Breakdown (if available) -->
        @if (order.vendorCommission && order.vendorCommissionAmount) {
          <mat-card appearance="outlined">
            <mat-card-header>
              <mat-card-title>
                Revenue Breakdown
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="space-y-3 mt-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-blue-900">Vendor Commission</span>
                    <mat-chip class="!text-xs !bg-blue-100 !text-blue-700">{{ order.vendorCommission }}%</mat-chip>
                  </div>
                  <div class="text-2xl font-bold text-blue-600">{{ order.vendorCommissionAmount | currency: currency() }}</div>
                </div>
                
                <div class="bg-pink-50 border border-pink-200 rounded-lg p-4">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-pink-900">Vendor Receives</span>
                  </div>
                  <div class="text-2xl font-bold text-pink-600">
                    {{ (order.subTotal - order.vendorCommissionAmount) | currency: currency() }}
                  </div>
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-green-900">Platform Receives</span>
                  </div>
                  <div class="text-2xl font-bold text-green-600">
                    {{ (order.total - (order.subTotal - order.vendorCommissionAmount)) | currency: currency() }}
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        }

      </div>
    </div>

  </div>
}
