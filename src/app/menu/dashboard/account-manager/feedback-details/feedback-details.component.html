<div class="container mx-auto p-4">
  <div class="mb-6">
    <div class="flex items-center space-x-2 text-gray-600">
      <button class="hover:text-primary flex items-center space-x-1" (click)="goBack()">
        <mat-icon class="text-sm">arrow_back</mat-icon>
        <span>Back to Feedback</span>
      </button>
      <mat-icon class="text-sm">chevron_right</mat-icon>
      <span class="text-gray-900">Feedback Details</span>
    </div>
  </div>

  @if (surveyFeedbackResponse.isLoading()) {
    <div class="flex justify-center items-center h-64">
      <mat-spinner diameter="48"></mat-spinner>
    </div>
  }

  @if (surveyFeedbackResponse.error()) {
    <mat-card class="p-4 bg-red-50">
      <p class="text-red-600">An error occurred while loading the feedback details.</p>
    </mat-card>
  }

  @if (surveyFeedbackResponse.value(); as feedback) {
    <mat-card class="mb-6">
      <mat-card-header>
        <mat-card-title class="text-2xl mb-2">{{feedback.survey.name}}</mat-card-title>
        <mat-card-subtitle>{{feedback.survey.description}}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="border-b md:border-b-0 md:border-r border-gray-200 p-4">
            <h3 class="font-semibold mb-2">Survey Details</h3>
            <p class="text-gray-600"><span class="font-medium">Touch Point:</span> {{feedback.survey.touchPoint.name}}</p>
            <p class="text-gray-600"><span class="font-medium">Type:</span> {{feedback.survey.feedbackType}}</p>
            <p class="text-gray-600"><span class="font-medium">Period:</span> {{formatDate(feedback.survey.startDate)}} - {{formatDate(feedback.survey.endDate)}}</p>
            <p class="text-gray-600"><span class="font-medium">Responded At:</span> {{formatDate(feedback?.respondedAt)}}</p>
          </div>
          <div class="p-4">
            <h3 class="font-semibold mb-2">Respondent Details</h3>
            <p class="text-gray-600"><span class="font-medium">Name:</span> {{feedback.user.name}}</p>
            <p class="text-gray-600"><span class="font-medium">Email:</span> {{feedback.user.email}}</p>
            <p class="text-gray-600"><span class="font-medium">Department:</span> {{feedback.user.department}}</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="space-y-4">
      @if (feedback.responses?.length) {
        @for (response of feedback.responses; track response.question._id) {
          <mat-card>
            <mat-card-content class="p-4">
              <h3 class="font-semibold text-lg mb-3">{{response.question.name}}</h3>
              
              @switch (response.question.questionType) {
                @case ('Rating') {
                  <div class="flex gap-1">
                    @for (star of getRatingStars(+response.answer); track $index) {
                      <mat-icon class="text-yellow-400">star</mat-icon>
                    }
                    @for (star of getEmptyStars(+response.answer, response.question.ratingScale); track $index) {
                      <mat-icon class="text-gray-300">star_border</mat-icon>
                    }
                  </div>
                }
                @case ('Single Choice') {
                  <mat-chip-set>
                    <mat-chip>{{response.answer}}</mat-chip>
                  </mat-chip-set>
                }
                @case ('Multiple Choice') {
                  <mat-chip-set>
                    @for (choice of response.answer.split(','); track choice) {
                      <mat-chip>{{choice.trim()}}</mat-chip>
                    }
                  </mat-chip-set>
                }
                @default {
                  <p class="text-gray-700">{{response.answer}}</p>
                }
              }
            </mat-card-content>
          </mat-card>
        }
      } @else {
        <mat-card>
          <mat-card-content class="p-8 text-center">
            <mat-icon class="text-gray-400 text-5xl mb-4">feedback</mat-icon>
            <h3 class="text-xl font-medium text-gray-600 mb-2">No Responses Yet</h3>
            <p class="text-gray-500">The respondent hasn't provided any feedback for this survey.</p>
          </mat-card-content>
        </mat-card>
      }
    </div>
  }
</div>
