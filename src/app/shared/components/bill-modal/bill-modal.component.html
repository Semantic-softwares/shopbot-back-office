<div mat-dialog-title>Receipt</div>

<mat-dialog-content>
  <div class="receipt-paper  p-8 font-mono text-sm w-full">
    <!-- Store Header -->
    <div class="text-center mb-4 pb-4 border-b border-dashed border-gray-400">
      @if (storeStore.selectedStore()?.logo) {
        <img [src]="storeStore.selectedStore()?.logo" alt="Store Logo" class="h-12 w-12 object-contain mx-auto mb-2">
      }
      <h3 class="text-base font-bold uppercase mb-1">{{ storeStore.selectedStore()?.name || 'Store Name' }}</h3>
      @if (storeStore.selectedStore()?.contactInfo) {
        <div class="text-xs text-gray-700 space-y-0.5">
          @if (storeStore.selectedStore()?.contactInfo?.address) {
            <p>{{ storeStore.selectedStore()?.contactInfo?.address }}</p>
          }
          @if (storeStore.selectedStore()?.contactInfo?.phone) {
            <p>Tel: {{ storeStore.selectedStore()?.contactInfo?.phone }}</p>
          }
          @if (storeStore.selectedStore()?.contactInfo?.email) {
            <p>{{ storeStore.selectedStore()?.contactInfo?.email }}</p>
          }
        </div>
      }
    </div>

    <!-- Order Information -->
    <div class="text-xs mb-4 pb-3 border-b border-dashed border-gray-400">
      <div class="flex justify-between mb-1">
        <span>Order #:</span>
        <span class="font-semibold">{{ order().reference || order()._id }}</span>
      </div>
      <div class="flex justify-between mb-1">
        <span>Date:</span>
        <span>{{ order().createdAt | date:'short' }}</span>
      </div>
      @if (order().table) {
        <div class="flex justify-between mb-1">
          <span>Table:</span>
          <span>{{ order().table?.name }}</span>
        </div>
        @if (order().table?.numberOfGuest) {
          <div class="flex justify-between mb-1">
            <span>Guests:</span>
            <span>{{ order().table?.numberOfGuest }}</span>
          </div>
        }
      }
      @if (order().staff) {
        <div class="flex justify-between mb-1">
          <span>Server:</span>
          <span>{{ order().staff.name || 'N/A' }}</span>
        </div>
      }
    </div>

    <!-- Order Items -->
    <div class="mb-4 pb-3 border-b border-dashed border-gray-400">
      <div class="text-xs font-bold uppercase mb-2">Items</div>
      
      @for (product of order().cart?.products; track product._id) {
        <div class="mb-3">
          <!-- Product Line -->
          <div class="flex justify-between items-start mb-1">
            <div class="flex-1 pr-2">
              <div class="font-semibold">{{ product.name }}</div>
              <div class="text-xs text-gray-600">{{ product.quantity }} x {{ product.price | currency:currency():'symbol':'1.2-2' }}</div>
            </div>
            <div class="font-semibold whitespace-nowrap">{{ getItemTotal(product) | currency:currency():'symbol':'1.2-2' }}</div>
          </div>
          
          <!-- Item Options -->
          @if (getOptionsDisplay(product).length > 0) {
            <div class="ml-3 text-xs text-gray-600 space-y-0.5">
              @for (option of getOptionsDisplay(product); track option.name) {
                <div class="flex justify-between">
                  <span>
                    + {{ option.name }}
                    @if (option.quantity > 1) { <span>(x{{ option.quantity }})</span> }
                  </span>
                  @if (option.price > 0) {
                    <span class="whitespace-nowrap">{{ option.price | currency:currency():'symbol':'1.2-2' }}</span>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    </div>

    <!-- Order Summary -->
    <div class="text-xs mb-4">
      <div class="flex justify-between mb-1.5">
        <span>Subtotal:</span>
        <span>{{ (order().subTotal || 0) | currency:currency():'symbol':'1.2-2' }}</span>
      </div>
      
      @if (order().discount && order().discount! > 0) {
        <div class="flex justify-between mb-1.5">
          <span>Discount:</span>
          <span>-{{ order().discount | currency:currency():'symbol':'1.2-2' }}</span>
        </div>
      }
      
      @if (order().tax && order().tax! > 0) {
        <div class="flex justify-between mb-1.5">
          <span>Tax:</span>
          <span>{{ order().tax | currency:currency():'symbol':'1.2-2' }}</span>
        </div>
      }
      
      @if (order().shippingFee && order().shippingFee! > 0) {
        <div class="flex justify-between mb-1.5">
          <span>Delivery Fee:</span>
          <span>{{ order().shippingFee | currency:currency():'symbol':'1.2-2' }}</span>
        </div>
      }
      
      @if (order().serviceFee && order().serviceFee! > 0) {
        <div class="flex justify-between mb-1.5">
          <span>Service Fee:</span>
          <span>{{ order().serviceFee | currency:currency():'symbol':'1.2-2' }}</span>
        </div>
      }
    </div>

    <div class="border-t-2 border-double border-gray-800 pt-2 mb-4">
      <div class="flex justify-between text-base font-bold">
        <span>TOTAL:</span>
        <span>{{ (order().total || 0) | currency:currency():'symbol':'1.2-2' }}</span>
      </div>
    </div>

    <!-- Payment Status -->
    <div class="text-xs mb-4 pb-3 border-b border-dashed border-gray-400">
      <div class="flex justify-between mb-1">
        <span>Payment:</span>
        <span class="font-semibold">{{ order().payment || 'N/A' }}</span>
      </div>
      <div class="flex justify-between">
        <span>Status:</span>
        <span class="font-semibold"
          [class.text-green-600]="order().paymentStatus === 'Paid'"
          [class.text-orange-600]="order().paymentStatus === 'Unpaid'">
          {{ order().paymentStatus }}
        </span>
      </div>
    </div>

    <!-- Order Notes -->
    @if (order().note) {
      <div class="text-xs mb-4 pb-3 border-b border-dashed border-gray-400">
        <div class="font-semibold mb-1">Note:</div>
        <div class="text-gray-600">{{ order().note }}</div>
      </div>
    }

    <!-- Footer -->
    <div class="text-center mt-6 pt-4 border-t border-dashed border-gray-400">
      <p class="text-xs font-semibold mb-2">
        {{ storeStore.selectedStore()?.posSettings?.receiptSettings?.footerMessage || 'Thank you for your patronage!' }}
      </p>
      @if (storeStore.selectedStore()?.posSettings?.receiptSettings?.disclaimer) {
        <p class="text-xs text-gray-500 mb-2">
          {{ storeStore.selectedStore()?.posSettings?.receiptSettings?.disclaimer }}
        </p>
      }
      <p class="text-xs text-gray-400 mt-3">
        {{ formatDate(order().createdAt) }}
      </p>
      <p class="text-xs text-gray-400 mt-1">***</p>
    </div>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end" class="print:hidden border-t">
  <button matButton (click)="close()" [disabled]="isPrinting()">
    Close
  </button>
  <button matButton="filled" color="primary" (click)="print()" [disabled]="isPrinting()">
    <ng-container>
      @if (isPrinting()) {
        <mat-icon class="animate-spin">refresh</mat-icon>
        Printing...
      } @else {
        <mat-icon>print</mat-icon>
        Print
      }
    </ng-container>
  </button>
</mat-dialog-actions>
