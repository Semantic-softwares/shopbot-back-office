<mat-card class="m-5 max-w-7xl mx-auto bg-white !mb-6">
  <mat-card-header class="!p-4 mb-6 border-b border-gray-200">
    <mat-card-title class="text-xl font-medium">{{pageTitle()}}</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Left Column -->
        <div class="space-y-4">
          <h3 class="text-lg font-medium text-gray-900 mb-5">Basic Information</h3>
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Category</mat-label>
            <mat-select formControlName="menu">
              @for (category of categories.value(); track category) {
                <mat-option [value]="category._id">
                  {{category.name}}
                </mat-option>
              }
              <mat-option (click)="openCategoryModal($event)" class="!text-primary">
                <mat-icon class="align-middle mr-2">add</mat-icon>
                Add New Category
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Product Name</mat-label>
            <input matInput formControlName="name">
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Description</mat-label>
            <textarea matInput formControlName="description" rows="4" class="min-h-[100px]"></textarea>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Unit</mat-label>
            <mat-select formControlName="units">
              @for (unit of productUnits; track unit.value) {
                <mat-option [value]="unit.value">
                  {{unit.viewValue}}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Station</mat-label>
            <mat-select formControlName="station">
              @for (station of stations.value(); track $index) {
                <mat-option [value]="station._id">
                  {{station.name}}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>

          <!-- Image Upload Section -->
          <div class="w-full p-4 bg-gray-50 rounded-lg">
            <h4 class="text-base font-medium text-gray-900 mb-4">Product Images</h4>
            
            <div class="flex items-center justify-center w-full">
              <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-white hover:bg-gray-50">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                  <svg class="w-8 h-8 mb-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                  <p class="mb-2 text-sm text-gray-500">
                    <span class="font-semibold">Click to upload</span> or drag and drop
                  </p>
                  <p class="text-xs text-gray-500">PNG, JPG, GIF up to 5MB</p>
                </div>
                <input type="file" 
                       class="hidden" 
                       accept="image/*" 
                       multiple 
                       (change)="onFileSelected($event)">
              </label>
            </div>

            <!-- Image Previews -->
            @if (selectedImages.length > 0) {
              <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-4">
                @for (image of selectedImages; track image.url; let i = $index) {
                  <div class="relative group">
                    <img [src]="image.url" 
                         class="h-24 w-24 object-cover rounded-lg border border-gray-200"
                         alt="Preview">
                    <button type="button"
                            (click)="removeImage(i)"
                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 
                                   opacity-0 group-hover:opacity-100 transition-opacity">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" 
                           viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" 
                              stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        </div>

        <!-- Right Column -->
        <div class="space-y-6">
          <h3 class="text-lg font-medium text-gray-900 mb-5">Pricing & Stock Information</h3>
          
          <div class="bg-gray-50 p-4 rounded-lg space-y-4">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Selling Price</mat-label>
              <input matInput type="number" formControlName="price">
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Cost Price</mat-label>
              <input matInput type="number" formControlName="costPrice">
            </mat-form-field>

            <div class="flex justify-between items-center bg-green-50 p-4 rounded">
              <span class="font-medium text-gray-900">Profit:</span>
              <span class="text-lg font-medium text-green-700">{{profit() | currency: storeStore.selectedStore()?.currency}}</span>
              <input type="hidden" formControlName="profit">
            </div>
          </div>

          <div class="bg-gray-50 p-4 rounded-lg space-y-4">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Quantity</mat-label>
              <input matInput type="number" formControlName="quantity">
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Initial Stock</mat-label>
              <input matInput type="number" formControlName="initialStock">
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Critical Stock</mat-label>
              <input matInput type="number" formControlName="criticalStock">
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Stock Level Alert</mat-label>
              <mat-select formControlName="stockLevelAlert">
                @for (option of stockLevelAlertOptions; track option.value) {
                  <mat-option [value]="option.value">
                    {{option.viewValue}}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <div class="bg-gray-50 p-4 rounded-lg space-y-4">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>SKU</mat-label>
              <input matInput formControlName="sku">
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Barcode</mat-label>
              <input matInput formControlName="barcode">
            </mat-form-field>
          </div>

          <!-- Variants Section -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <div class="flex items-center justify-between mb-4">
              <h4 class="text-base font-medium text-gray-900">Variants</h4>
              <button mat-stroked-button color="primary" type="button" (click)="openVariantsDialog()">
                <mat-icon class="mr-2">add</mat-icon>
                Add Variants
              </button>
            </div>

            @if (selectedVariants.length > 0) {
              <div class="space-y-2">
                @for (variant of selectedVariants; track variant._id) {
                  <div class="flex items-center justify-between p-2 bg-white rounded border border-gray-200">
                    <div>
                      <span>{{variant.name}}</span>
                      <span class="text-sm text-gray-500 ml-2">
                        At least: {{variant.atLeast}} | At most: {{variant.atMost}}
                      </span>
                    </div>
                    <button mat-icon-button type="button" (click)="removeVariant(variant)" color="warn">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                }
              </div>
            } @else {
              <app-no-record 
                icon="tune"
                title="No Variants Added"
                message="Variants allow you to create different versions of your product (e.g., sizes, flavors). Click 'Add Variants' to customize your product options.">
              </app-no-record>
            }
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-4 pt-6 border-t border-gray-200">
        <button mat-stroked-button type="button" routerLink="/dashboard/items/products">Cancel</button>
        <button mat-raised-button color="primary" type="submit" [disabled]="!productForm.valid || isSubmitting()">
          @if (isSubmitting()) {
            <mat-spinner diameter="20" class="mr-2"></mat-spinner>
          }
          {{submitButtonText()}}
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
<div class="mb-8 pb-6"></div>
