import{a as r,b as k,c as M,d as V,e as D,f as N,g as b,h as v,i as Q}from"./chunk-WFQLSX5X.js";import{a as G}from"./chunk-BFT2MTJY.js";import{x as B}from"./chunk-6BQAOBQP.js";import{$ as z,G as R,K as q,Tc as S,U as y,X as C,c as h,da as U,ea as E,g as K}from"./chunk-H33Y42PP.js";import{a as f,b as I,g as H}from"./chunk-GAL4ENT6.js";var Y={salesTypes:[{id:"table",name:"Table Sales",description:"For sales made at assigned tables within the premises.",icon:"table_icon.svg",features:{requiresTableAssignment:!0,allowsMultipleOrders:!0,supportsOnlinePayment:!0,supportsOfflinePayment:!0,requiresDeliveryAddress:!1},defaultSettings:{paymentMethod:"Cash",orderPrefix:"TBL"}},{id:"quick",name:"Quick Sales",description:"Fast checkout for walk-in customers without table assignment.",icon:"quick_icon.svg",features:{requiresTableAssignment:!1,allowsMultipleOrders:!1,supportsOnlinePayment:!0,supportsOfflinePayment:!0,requiresDeliveryAddress:!1},defaultSettings:{paymentMethod:"Card",orderPrefix:"QUK"}},{id:"online",name:"Online Sales",description:"Sales made through the online ordering system for delivery or pickup.",icon:"online_icon.svg",features:{requiresTableAssignment:!1,allowsMultipleOrders:!0,supportsOnlinePayment:!0,supportsOfflinePayment:!1,requiresDeliveryAddress:!0},defaultSettings:{paymentMethod:"Online",orderPrefix:"ONL"}}],isEditing:!1,selectedSale:null},Pe=k({providedIn:"root"},N(Y),M(({salesTypes:e})=>({menuCount:S(()=>e().length)})),D(e=>({setSelectedSaleType(t,i=!1){let o=e.salesTypes().find(m=>m.id===t||m.name===t);o?r(e,{selectedSale:o,isEditing:i}):(console.warn(`Sales type with ID or name "${t}" not found.`),r(e,{selectedSale:null,isEditing:!1}))},setDefaultSaleType(){let t=e.salesTypes().find(i=>i.id==="quick");t?r(e,{selectedSale:t,isEditing:!1}):console.warn("Default sale type 'Quick Sales' not found.")},startEditing(){console.log(e.selectedSale(),"Entering editing mode"),e.selectedSale()?r(e,{isEditing:!0}):console.warn("No sales type selected to edit.")},stopEditing(){console.log("Exiting editing mode"),r(e,{isEditing:!1})},clearSelection(){r(e,{selectedSale:null,isEditing:!1})}})));var F=class e{constructor(t){this._httpClient=t}orders;hostServer=G.apiUrl;orders$=new K(null);selectedOrders=this.orders$.asObservable();getOrders(t){let o=JSON.stringify(t);return this._httpClient.get(`${this.hostServer}/orders?query=${o}`)}getUserOrders(t){return this._httpClient.get(`${this.hostServer}/orders/user/${t}`)}getUserStoreOrders(t,i){return this._httpClient.get(`${this.hostServer}/orders/user/${t}/store/${i}`)}getOrder(t){return this._httpClient.get(`${this.hostServer}/orders/${t}`)}updateOrderStatus(t){return this._httpClient.put(`${this.hostServer}/orders/status/update`,t)}updateOrder(t,i){return this._httpClient.put(`${this.hostServer}/orders/${t}`,i)}updateOrderComprehensive(t,i){return this._httpClient.put(`${this.hostServer}/orders/${t}/comprehensive`,i)}deleteOrder(t){return this._httpClient.delete(`${this.hostServer}/orders/${t}`)}getStoreOrder(t,i,o){return this._httpClient.get(`${this.hostServer}/orders/store/${t}/merchants/orders?status=${i.status}&type=${o}&limit=${i.limit}&offset=${i.offset}`)}getStoreOrderCount(t){return this._httpClient.get(`${this.hostServer}/orders/store/${t}/merchants/orders/count`)}getStoreOrders(t,i={}){let o=new URLSearchParams;return i.limit&&o.append("limit",i.limit.toString()),i.skip&&o.append("skip",i.skip.toString()),i.status&&o.append("status",i.status),i.payment&&o.append("payment",i.payment),i.staff&&o.append("staff",i.staff),i.startDate&&o.append("startDate",i.startDate),i.endDate&&o.append("endDate",i.endDate),i.salesChannel&&o.append("salesChannel",i.salesChannel),this._httpClient.get(`${this.hostServer}/orders/store/${t}/orders?${o.toString()}`)}syncOrders(t){return this._httpClient.post(`${this.hostServer}/orders/sync`,{orders:t})}createOrder(t){return console.log(t,"order"),this._httpClient.post(`${this.hostServer}/orders`,t)}broadcast(t){this.orders$.next(t)}static \u0275fac=function(i){return new(i||e)(U(B))};static \u0275prov=z({token:e,factory:e.\u0275fac,providedIn:"root"})};var X={orders:[],isAccepting:!1,isLoading:!1,selectedOrder:null,searchQuery:"",searchFilters:null,onlineOrders:{new:[],processing:[],ready:[],complete:[],cancel:[]},selectedOnlineOrder:null,orderHistory:[],hasMore:!1,isLoadingMore:!1,error:null},Be=k({providedIn:"root"},N(X),M(({orders:e,searchQuery:t,searchFilters:i,onlineOrders:o})=>({orderCount:S(()=>e().length),newOnlineOrders:S(()=>o().new),processingOnlineOrders:S(()=>o().processing),readyOnlineOrders:S(()=>o().ready),completeOnlineOrders:S(()=>o().complete),filteredOrders:S(()=>{let m=t()?.toLowerCase(),c=i();return e().filter(O=>{let T=m?O.reference?.toLowerCase().includes(m):!0,w=c?.status?O.category?.toLowerCase()===c.status?.toLowerCase():!0,P=c?.types?O.salesType?.name.toLowerCase()===c.types.toLowerCase():!0,$=c?.paymentType?O.payment?.toLowerCase()===c.paymentType.toLowerCase():!0,_=c?.startedAt?new Date(O.createdAt).toDateString()===new Date(c.startedAt).toDateString():!0;return T&&w&&P&&$&&_})})})),D(e=>{function t(d){r(e,{searchQuery:d})}function i(d){r(e,{searchFilters:d})}function o(){r(e,{searchFilters:null})}function m(){r(e,{searchQuery:""})}function c(d){return e.orders().find(g=>g._id===d)}function x(d){r(e,{selectedOrder:d})}function O(d){let n=e.orders().filter(s=>s._id!==d);r(e,{orders:n})}function T(){r(e,{selectedOrder:null})}function w(d){r(e,{orders:[...e.orders(),d]}),x(d)}function P(d,g){r(e,{orders:e.orders().map(n=>n._id===d?f(f({},n),g):n)})}function $(d){let g=e.selectedOrder();g&&r(e,{selectedOrder:f(f({},g),d)})}function _(d){let g=e.selectedOnlineOrder();g&&r(e,{selectedOnlineOrder:f(f({},g),d)})}return{updateSelectedOrder:$,updateOrder:P,addOrderToState:w,deleteSelectedOrder:T,deleteOrder:O,selectOrder:x,findOrderById:c,clearSearchQuery:m,clearSearchFilter:o,updateSearchFilter:i,updateSearchQuery:t,updateOnlineSelectedOrder:_}}),D((e,t=E(F),i=E(Q))=>{function o(n){return n.toLowerCase()}function m(n,s){return H(this,null,function*(){let l=e.orders(),p=l.find(u=>u._id===n);if(!p)return console.error(`Order with ID ${n} not found.`),Promise.reject(new Error(`Order with ID ${n} not found.`));let a={category:"Complete"};!p.payment&&s&&(a.payment=s,a.paymentStatus="Paid");try{let u=yield t.updateOrderComprehensive(n,a).toPromise();return console.log(`Order ${n} marked as complete on the server.`),u?(r(e,{orders:l.map(L=>L._id===n?u:L)}),Promise.resolve(u)):Promise.reject(new Error("No order returned from server"))}catch(u){return console.error(`Failed to update order ${n} on the server:`,u),Promise.reject(u)}})}let c=v(h(y(n=>{r(e,{isLoadingMore:!0,isLoading:n?.reload??!1});let s=n.limit??25,l=n.offset??0,p=i.selectedStore();return p?._id?t.getStoreOrder(p._id,{status:n.orderType,limit:s,offset:l},"online").pipe(b({next:a=>{if(r(e,{isLoading:!1,hasMore:a.length>0,isLoadingMore:!1,error:null}),e.hasMore()){let u=o(n.orderType),L=e.onlineOrders()[u]||[];r(e,{onlineOrders:I(f({},e.onlineOrders()),{[u]:[...L,...a]})})}},error:a=>{console.error(a),r(e,{error:String(a)})},finalize:()=>r(e,{isLoading:!1,isLoadingMore:!1})})):(r(e,{isLoading:!1,isLoadingMore:!1}),[])})));function x(n){let s=o(n);return e.onlineOrders()[s]||[]}function O(n){let s=o(n);r(e,{onlineOrders:I(f({},e.onlineOrders()),{[s]:[]})})}let T=v(h(C(()=>r(e,{isLoading:!0})),y(n=>t.getOrder(n).pipe(b({next:s=>r(e,{isLoading:!1,selectedOnlineOrder:s}),error:s=>{console.error(s),r(e,{error:String(s)})},finalize:()=>r(e,{isLoading:!1})}))))),w=v(h(C(()=>r(e,{isAccepting:!0})),y(({order:n,statusNumber:s,currentStatus:l,targetStatus:p})=>{let a=n.user?._id||"";return t.updateOrderStatus({orderId:n._id,userId:a,statusNumber:s}).pipe(b({next:u=>{e.updateOnlineSelectedOrder({category:p});let L=o(l),j=o(p),A=f({},e.onlineOrders());A[L]=A[L].filter(W=>W._id!==n._id),A[j]=[...A[j],u],r(e,{isLoading:!1,isAccepting:!1,onlineOrders:A,selectedOrder:u})},error:u=>{console.error(u),r(e,{error:String(u)})},finalize:()=>r(e,{isLoading:!1,isAccepting:!1})}))}))),P=v(h(R(300),q(),C(()=>r(e,{isLoading:!0})),y(n=>{let s=n.limit??10,l=n.skip??0,p=i.selectedStore();return p?._id?t.getStoreOrders(p._id,{limit:s,skip:l}).pipe(b({next:a=>r(e,{orderHistory:a,isLoading:!1}),error:a=>{console.error(a),r(e,{error:String(a)})},finalize:()=>r(e,{isLoading:!1})})):(r(e,{isLoading:!1}),[])}))),$=v(h(C(()=>r(e,{isLoading:!0})),y(n=>t.getStoreOrders(n,{limit:100,skip:0}).pipe(b({next:s=>r(e,{orders:s,isLoading:!1}),error:s=>{console.error(s),r(e,{error:String(s)})},finalize:()=>r(e,{isLoading:!1})}))))),_=v(h(C(()=>r(e,{isLoading:!0})),y(n=>t.deleteOrder(n).pipe(b({next:()=>{r(e,{orders:e.orders().filter(s=>s._id!==n),isLoading:!1})},error:s=>{console.error(s),r(e,{error:String(s)})},finalize:()=>r(e,{isLoading:!1})}))))),d=v(h(C(()=>r(e,{isLoading:!0})),y(({orderId:n,updates:s})=>t.updateOrderComprehensive(n,s).pipe(b({next:l=>{r(e,{orders:e.orders().map(p=>p._id===n?l:p),isLoading:!1})},error:l=>{console.error("Failed to update order:",l),r(e,{error:String(l),isLoading:!1})},finalize:()=>r(e,{isLoading:!1})}))))),g=v(h(C(()=>r(e,{isLoading:!0})),y(n=>t.syncOrders([n]).pipe(b({next:s=>{let l=s[0];if(l){let p=e.orders().findIndex(a=>a._id===l._id);if(p>=0){let a=[...e.orders()];a[p]=l,r(e,{orders:a,selectedOrder:l,isLoading:!1})}else r(e,{orders:[...e.orders(),l],selectedOrder:l,isLoading:!1})}},error:s=>{console.error(s),r(e,{error:String(s),isLoading:!1})},finalize:()=>r(e,{isLoading:!1})})))));return{getOrders$:$,getOnlineOrders:c,_selectOrder:x,getOnlineOrder:T,getOrderHistory:P,clearOnlineOrders:O,updateOrderStatus$:w,deleteOrder$:_,updateOrder$:d,syncOrder$:g,getOnlineOrderKey:o,completeOrder:m}}),V({onInit(e){let i=E(Q).selectedStore();i?._id&&e.getOrders$(i._id)}}));export{Pe as a,F as b,Be as c};
