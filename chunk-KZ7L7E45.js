import{a as et}from"./chunk-GWC7K72H.js";import{b as Xe,f as Ze}from"./chunk-CU623SSI.js";import{a as We}from"./chunk-7FSETBMW.js";import"./chunk-HJ3KAQ7K.js";import{a as Ge,b as Ke,c as Ye,h as Je}from"./chunk-Y2RO63AQ.js";import{a as Qe}from"./chunk-JZKRHT5H.js";import{a as je}from"./chunk-O4OM35BU.js";import{a as Oe,b as Ue,c as Ve,e as Be,g as qe,j as He,l as ze}from"./chunk-FJYLQSWC.js";import{a as $e,b as Le}from"./chunk-4XV2UKEU.js";import{b as Z}from"./chunk-CP5EC6RD.js";import"./chunk-CCJ2KI64.js";import"./chunk-6RCOBA75.js";import"./chunk-A24HMJCQ.js";import{e as ue}from"./chunk-CDJZX4I4.js";import{i as oe}from"./chunk-QC7H4KPM.js";import{a as Pe,b as Ae,c as Ne,e as Fe}from"./chunk-LN5FOFKR.js";import{a as we,b as De}from"./chunk-WZDQ5XTC.js";import{d as X}from"./chunk-R6JGHN2R.js";import"./chunk-64WHNS37.js";import"./chunk-TIVXUJ22.js";import"./chunk-WAHSRZAW.js";import"./chunk-XLZTIYSF.js";import{b as Te,c as Ie,d as Re}from"./chunk-UMV4DCPT.js";import{a as ve,e as be,h as Me}from"./chunk-G3VZM262.js";import"./chunk-BCE7WRWQ.js";import{a as Ee,b as ke}from"./chunk-6I3AJKA7.js";import{B as _e,b as he,d as M,g as ge,h as ye,m as xe,s as Se,t as Ce,z as fe}from"./chunk-W7NMJLMQ.js";import"./chunk-F5SZ3AU3.js";import{a as ne,b as ie}from"./chunk-4UBDYPTG.js";import"./chunk-TILT22SG.js";import{a as ae}from"./chunk-BFT2MTJY.js";import{a as le,b as ce,c as pe,f as me,h as de}from"./chunk-3E3PJ7Q7.js";import"./chunk-FO4KTVQ3.js";import"./chunk-TRZH7NMW.js";import"./chunk-GXTELBJV.js";import{b as re,c as se}from"./chunk-JPRPNQOM.js";import{_ as ee,ba as te}from"./chunk-3LDCGXHW.js";import"./chunk-ZLVQTB5B.js";import{E as W,m as K,s as Y,x as J,y as Q}from"./chunk-6PFJHDFS.js";import{Ec as j,Ib as h,Jb as g,Lc as R,Mb as N,Mc as G,Nb as F,Nc as k,Ob as d,Pb as i,Qb as a,Rb as C,Vc as b,Y as T,Yb as v,Za as V,aa as U,ac as f,bb as l,cc as p,fa as _,ka as x,kb as B,la as S,mc as $,qb as q,rc as r,sc as E,tb as H,tc as y,uc as z,wa as u,wb as I}from"./chunk-J2AK4FW5.js";import{a as P,b as A}from"./chunk-GAL4ENT6.js";var w=class o{http=_(Q);baseUrl=ae.apiUrl;syncingStore=u(!1);syncingRoomTypes=u(new Set);pushingAvailability=u(!1);connectingChannel=u(null);isSyncingStore=this.syncingStore.asReadonly();syncingRoomTypes$=this.syncingRoomTypes.asReadonly();isPushingAvailability=this.pushingAvailability.asReadonly();connectingChannel$=this.connectingChannel.asReadonly();syncStoreToChannex(t,e){return this.syncingStore.set(!0),this.http.post(`${this.baseUrl}/admin/channex/stores/${t}/sync`,e).pipe(T(()=>this.syncingStore.set(!1)))}syncRoomTypeToChannex(t,e,n){return this.syncingRoomTypes.update(s=>new Set(s).add(e)),this.http.post(`${this.baseUrl}/admin/channex/stores/${t}/room-types/${e}/sync`,n).pipe(T(()=>{this.syncingRoomTypes.update(s=>{let c=new Set(s);return c.delete(e),c})}))}pushAvailability(t,e){return this.pushingAvailability.set(!0),this.http.post(`${this.baseUrl}/admin/channex/stores/${t}/availability`,e).pipe(T(()=>this.pushingAvailability.set(!1)))}getStoreStatus(t){return this.http.get(`${this.baseUrl}/admin/channex/stores/${t}/status`)}getChannexReservations(t,e){let n=new J;return e?.status&&(n=n.set("status",e.status)),e?.startDate&&(n=n.set("startDate",e.startDate)),e?.endDate&&(n=n.set("endDate",e.endDate)),this.http.get(`${this.baseUrl}/admin/channex/stores/${t}/reservations`,{params:n})}getChannelConnectionKey(t){return this.http.post(`${this.baseUrl}/admin/channex/stores/${t}/channel-connection-key`,{})}updateChannelStatus(t,e){return this.http.post(`${this.baseUrl}/admin/channex/stores/${t}/channel-status`,{channels:e})}getChannelAuthUrl(t,e){return this.connectingChannel.set(e),this.http.get(`${this.baseUrl}/admin/channex/stores/${t}/channels/${e}/authorize-url`).pipe(T(()=>this.connectingChannel.set(null)))}handleChannelCallback(t,e,n){return this.http.post(`${this.baseUrl}/admin/channex/stores/${t}/channels/${e}/callback`,n)}getChannels(t){return this.http.get(`${this.baseUrl}/admin/channex/stores/${t}/channels`)}disconnectChannel(t,e){return this.http.delete(`${this.baseUrl}/admin/channex/stores/${t}/channels/${e}`)}isRoomTypeSyncing(t){return this.syncingRoomTypes().has(t)}clearLoadingStates(){this.syncingStore.set(!1),this.syncingRoomTypes.set(new Set),this.pushingAvailability.set(!1),this.connectingChannel.set(null)}static \u0275fac=function(e){return new(e||o)};static \u0275prov=U({token:o,factory:o.\u0275fac,providedIn:"root"})};var D=class o{constructor(t){this.sanitizer=t}transform(t){return t?this.sanitizer.bypassSecurityTrustResourceUrl(t):null}static \u0275fac=function(e){return new(e||o)(B(W,16))};static \u0275pipe=H({name:"sanitizeUrl",type:o,pure:!0})};var it=(o,t)=>t._id||t.id,at=(o,t)=>t.channelId;function ot(o,t){o&1&&(i(0,"div",4),C(1,"mat-spinner",5),a())}function rt(o,t){if(o&1&&(i(0,"mat-card",6)(1,"mat-card-content",30)(2,"mat-icon",31),r(3,"warning"),a(),i(4,"div",32)(5,"h3",33),r(6,"Property Type Required"),a(),i(7,"p",34),r(8),a(),i(9,"p",35),r(10," Please select a valid property type (hotel, resort, guesthouse, etc.) in Step 1 below to enable Channex integration. "),a()()()()),o&2){let e=p(2);l(8),y(' Channel management requires a valid property type. Your property type is currently set to "',e.propertyType(),'". ')}}function st(o,t){o&1&&(i(0,"mat-card",7)(1,"mat-card-content",30)(2,"div",32)(3,"h3",36),r(4,"Channel Manager Active"),a(),i(5,"p",37),r(6," Your property is synced and ready to receive bookings from distribution channels. "),a()()()())}function lt(o,t){o&1&&(i(0,"mat-card",7)(1,"mat-card-content",30)(2,"div",32)(3,"h3",38),r(4,"Setup Required"),a(),i(5,"p"),r(6," Complete the setup steps below to start receiving bookings from OTAs. "),a()()()())}function ct(o,t){o&1&&r(0,"Step 1: Sync Property")}function pt(o,t){if(o&1){let e=v();i(0,"div",12)(1,"div",39)(2,"span",40),r(3,"Property ID:"),a(),i(4,"span",41),r(5),a()(),i(6,"div",39)(7,"span",40),r(8,"Last Synced:"),a(),i(9,"span",42),r(10),R(11,"date"),a()(),i(12,"button",26),f("click",function(){x(e);let s=p(2);return S(s.syncStore())}),i(13,"mat-icon"),r(14,"refresh"),a(),r(15," Re-sync Property "),a()()}if(o&2){let e,n,s=p(2);l(5),y(" ",(e=s.channexStatus())==null||e.channex==null?null:e.channex.propertyId," "),l(5),y(" ",k(11,3,(n=s.channexStatus())==null||n.channex==null?null:n.channex.lastSyncAt,"MMM d, y h:mm a")," "),l(2),d("disabled",s.isSyncingStore())}}function mt(o,t){if(o&1){let e=v();i(0,"form",13)(1,"mat-form-field",18)(2,"mat-label"),r(3,"Property Type"),a(),i(4,"mat-select",43)(5,"mat-option",44),r(6,"Hotel"),a(),i(7,"mat-option",45),r(8,"Hostel"),a(),i(9,"mat-option",46),r(10,"Apartment"),a(),i(11,"mat-option",47),r(12,"Guest House"),a(),i(13,"mat-option",48),r(14,"Resort"),a(),i(15,"mat-option",49),r(16,"Motel"),a(),i(17,"mat-option",50),r(18,"Villa"),a(),i(19,"mat-option",51),r(20,"Boutique Hotel"),a(),i(21,"mat-option",52),r(22,"Bed & Breakfast"),a(),i(23,"mat-option",53),r(24,"Lodge"),a()()(),i(25,"div",54)(26,"mat-form-field",18)(27,"mat-label"),r(28,"Check-in Time"),a(),C(29,"input",55),a(),i(30,"mat-form-field",18)(31,"mat-label"),r(32,"Check-out Time"),a(),C(33,"input",56),a()(),i(34,"button",57),f("click",function(){x(e);let s=p(2);return S(s.syncStore())}),r(35),a()()}if(o&2){let e=p(2);d("formGroup",e.syncPropertyForm),l(34),d("disabled",e.isSyncingStore()||e.syncPropertyForm.invalid||!e.isHotelProperty())("matTooltip",e.isHotelProperty()?"":"Please select a valid property type to sync with Channex"),l(),y(" ",e.isSyncingStore()?"Please wait...":"Sync Property to Channex"," ")}}function dt(o,t){o&1&&r(0,"Step 2: Sync Room Types")}function ut(o,t){o&1&&(i(0,"div",14)(1,"mat-icon",58),r(2,"meeting_room"),a(),i(3,"p"),r(4,"No room types found. Please create room types first."),a()())}function ht(o,t){o&1&&(i(0,"mat-chip",67),r(1," Synced "),a())}function gt(o,t){o&1&&C(0,"mat-spinner",68)}function yt(o,t){if(o&1){let e=v();i(0,"button",70),f("click",function(){x(e);let s=p().$implicit,c=p(3);return S(c.syncRoomType(s._id||s.id||"",s.name))}),i(1,"mat-icon"),r(2,"sync"),a(),r(3," Sync "),a()}}function xt(o,t){if(o&1&&(i(0,"mat-list-item")(1,"mat-icon",63),r(2,"meeting_room"),a(),i(3,"div",64),r(4),a(),i(5,"div",65),r(6),a(),i(7,"div",66),h(8,ht,2,0,"mat-chip",67)(9,gt,1,0,"mat-spinner",68)(10,yt,4,0,"button",69),a()()),o&2){let e=t.$implicit,n=p(3);l(4),E(e.name),l(2),E(e.description||"No description"),l(2),g(n.isRoomTypeSynced(e._id||e.id||"")?8:n.isRoomTypeSyncing(e._id||e.id||"")?9:10)}}function St(o,t){if(o&1){let e=v();i(0,"div",59)(1,"button",60),f("click",function(){x(e);let s=p(2);return S(s.syncAllRoomTypes())}),i(2,"mat-icon"),r(3,"sync"),a(),r(4," Sync All Room Types "),a()(),C(5,"mat-divider",61),i(6,"mat-nav-list",62),N(7,xt,11,3,"mat-list-item",null,it),a()}if(o&2){let e=p(2);l(7),F(e.roomTypes())}}function Ct(o,t){o&1&&r(0,"Step 3: Push Availability")}function ft(o,t){o&1&&r(0,"Step 4: Connect Channels")}function _t(o,t){if(o&1&&(i(0,"div",74)(1,"div",75)(2,"mat-icon",76),r(3,"check_circle"),a(),i(4,"div")(5,"p",77),r(6),a(),i(7,"p",78),r(8),R(9,"date"),a()()(),i(10,"mat-chip",79),r(11),a()()),o&2){let e=t.$implicit;l(6),E(e.channelName),l(2),y(" Connected ",k(9,3,e.connectedAt,"short")," "),l(3),y(" ",e.status," ")}}function vt(o,t){if(o&1&&(C(0,"mat-divider",61),i(1,"h4",72),r(2,"Connected Channels"),a(),i(3,"div",73),N(4,_t,12,6,"div",74,at),a()),o&2){let e,n=p(3);l(4),F((e=n.channexStatus())==null||e.channex==null?null:e.channex.connectedChannels)}}function bt(o,t){if(o&1){let e=v();i(0,"p",17),r(1," Your property is ready! Click below to connect to OTA channels and start receiving bookings. "),a(),i(2,"div",22)(3,"div",23)(4,"mat-icon",24),r(5,"info"),a(),i(6,"div",25)(7,"p",71),r(8,"Connect OTA Channels"),a(),i(9,"p"),r(10,"You'll be able to connect to Booking.com, Airbnb, Expedia, and other major booking platforms. The connection process is secure and managed by Channex."),a()()()(),i(11,"button",26),f("click",function(){x(e);let s=p(2);return S(s.connectChannels())}),r(12),a(),h(13,vt,6,0)}if(o&2){let e,n=p(2);l(11),d("disabled",n.isLoadingIframe()),l(),y(" ",n.isLoadingIframe()?"Connecting...":"Connect to OTA Channels"," "),l(),g(!((e=n.channexStatus())==null||e.channex==null)&&e.channex.connectedChannels&&((e=n.channexStatus())==null||e.channex==null?null:e.channex.connectedChannels.length)>0?13:-1)}}function Mt(o,t){if(o&1){let e=v();i(0,"div",28)(1,"div",80)(2,"h4",81),r(3,"Connect Your Channels"),a(),i(4,"button",82),f("click",function(){x(e);let s=p(2);return S(s.closeIframe())}),i(5,"mat-icon"),r(6,"close"),a()()(),i(7,"div",83)(8,"iframe",84),R(9,"sanitizeUrl"),f("load",function(){x(e);let s=p(2);return S(s.onIframeLoad())}),a()(),i(10,"div",85)(11,"mat-icon",86),r(12,"info"),a(),r(13," Use the interface above to connect and configure your OTA channels "),a()()}if(o&2){let e=p(2);l(8),d("src",G(9,1,e.channelIframeUrl()),V)}}function Tt(o,t){if(o&1&&(r(0),R(1,"date")),o&2){let e,n=p(3);y(" ",k(1,1,(e=n.channexStatus())==null||e.channex==null?null:e.channex.lastSyncAt,"short")," ")}}function It(o,t){o&1&&r(0," Never ")}function Rt(o,t){if(o&1&&(i(0,"mat-card",29)(1,"mat-card-header")(2,"mat-card-title",87),r(3,"Current Status"),a()(),i(4,"mat-card-content",88)(5,"div",89)(6,"div",90)(7,"p",91),r(8,"Sync Status"),a(),i(9,"p",92),r(10),a()(),i(11,"div",90)(12,"p",91),r(13,"Room Types Synced"),a(),i(14,"p",92),r(15),a()(),i(16,"div",90)(17,"p",91),r(18,"Last Sync"),a(),i(19,"p",92),h(20,Tt,2,4)(21,It,1,0),a()()()()()),o&2){let e,n,s,c=p(2);l(10),y(" ",((e=c.channexStatus())==null||e.channex==null?null:e.channex.syncStatus)||"Not Synced"," "),l(5),z(" ",((n=c.channexStatus())==null||n.roomMappings==null?null:n.roomMappings.length)||0," / ",((n=c.channexStatus())==null?null:n.totalRoomTypes)||0," "),l(5),g(!((s=c.channexStatus())==null||s.channex==null)&&s.channex.lastSyncAt?20:21)}}function Et(o,t){if(o&1){let e=v();h(0,rt,11,1,"mat-card",6),h(1,st,7,0,"mat-card",7)(2,lt,7,0,"mat-card",7),i(3,"mat-horizontal-stepper",8),f("selectionChange",function(s){x(e);let c=p();return S(c.onStepSelectionChange(s))}),i(4,"mat-step",9),I(5,ct,1,0,"ng-template",10),i(6,"mat-card",11)(7,"mat-card-content"),h(8,pt,16,6,"div",12)(9,mt,36,4,"form",13),a()()(),i(10,"mat-step",9),I(11,dt,1,0,"ng-template",10),i(12,"mat-card",11)(13,"mat-card-content")(14,"div",12),h(15,ut,5,0,"div",14)(16,St,9,0),a()()()(),i(17,"mat-step",15),I(18,Ct,1,0,"ng-template",10),i(19,"mat-card",11)(20,"mat-card-content")(21,"form",16)(22,"p",17),r(23," Choose the date range for which to publish availability and rates to distribution channels. "),a(),i(24,"mat-form-field",18)(25,"mat-label"),r(26,"Start Date"),a(),C(27,"input",19)(28,"mat-datepicker-toggle",20)(29,"mat-datepicker",null,0),a(),i(31,"mat-form-field",18)(32,"mat-label"),r(33,"End Date"),a(),C(34,"input",21)(35,"mat-datepicker-toggle",20)(36,"mat-datepicker",null,1),a(),i(38,"div",22)(39,"div",23)(40,"mat-icon",24),r(41,"info"),a(),i(42,"p",25),r(43," This will push your current room availability, rates, and restrictions for the selected date range. "),a()()(),i(44,"button",26),f("click",function(){x(e);let s=p();return S(s.pushAvailability())}),r(45),a()()()()(),i(46,"mat-step",9),I(47,ft,1,0,"ng-template",10),i(48,"mat-card",11)(49,"mat-card-content")(50,"div",27),h(51,bt,14,3)(52,Mt,14,3,"div",28),a()()()()(),h(53,Rt,22,4,"mat-card",29)}if(o&2){let e,n,s,c,L=$(30),O=$(37),m=p();g(m.isHotelProperty()?-1:0),l(),g(m.isSetupComplete()?1:2),l(2),d("linear",!0)("selectedIndex",m.currentStep()),l(),d("completed",((e=m.channexStatus())==null||e.channex==null?null:e.channex.syncStatus)==="synced"),l(4),g(((n=m.channexStatus())==null||n.channex==null?null:n.channex.syncStatus)==="synced"?8:9),l(2),d("completed",(((s=m.channexStatus())==null||s.roomMappings==null?null:s.roomMappings.length)||0)>=(((s=m.channexStatus())==null?null:s.totalRoomTypes)||0)&&(((s=m.channexStatus())==null?null:s.totalRoomTypes)||0)>0),l(5),g(m.roomTypes().length===0?15:16),l(2),d("optional",!0),l(4),d("formGroup",m.availabilityForm),l(6),d("matDatepicker",L),l(),d("for",L),l(6),d("matDatepicker",O),l(),d("for",O),l(9),d("disabled",m.isPushingAvailability()||m.availabilityForm.invalid),l(),y(" ",m.isPushingAvailability()?"Pushing Availability...":"Push Availability"," "),l(),d("completed",((c=m.channexStatus())==null||c.channex==null?null:c.channex.syncStatus)==="synced"&&(((c=m.channexStatus())==null||c.roomMappings==null?null:c.roomMappings.length)||0)>=(((c=m.channexStatus())==null?null:c.totalRoomTypes)||0)&&(((c=m.channexStatus())==null?null:c.totalRoomTypes)||0)>0),l(5),g(m.channelIframeUrl()?52:51),l(2),g(m.channexStatus()?53:-1)}}var nt=class o{storeStore=_(oe);channexService=_(w);roomsService=_(et);snackBar=_(ne);fb=_(fe);selectedStore=this.storeStore.selectedStore;storeId=b(()=>this.selectedStore()?._id||"");storeName=b(()=>this.selectedStore()?.name||"");storeType=b(()=>this.selectedStore()?.storeType||"restaurant");propertyType=b(()=>this.selectedStore()?.propertyType||"hotel");isHotelProperty=b(()=>{let t=this.propertyType();return t==="hotel"||t==="resort"||t==="boutique_hotel"||t==="motel"||t==="hostel"||t==="guesthouse"||t==="villa"||t==="bed_and_breakfast"||t==="lodge"||t==="apartment"});setupSteps=u([{id:1,title:"Sync Property",description:"Register your hotel with Channex",status:"pending",icon:"hotel"},{id:2,title:"Sync Room Types",description:"Map your room types to distribution channels",status:"pending",icon:"meeting_room"},{id:3,title:"Push Availability",description:"Send your availability and rates",status:"pending",icon:"event_available"},{id:4,title:"Connect Channels",description:"Link to Booking.com, Airbnb, etc.",status:"pending",icon:"link"}]);currentStep=u(0);channexStatus=u(null);roomTypes=u([]);isLoadingStatus=u(!1);channelIframeUrl=u(null);isLoadingIframe=u(!1);isSetupComplete=b(()=>{let t=this.channexStatus();return t?.channex?.syncStatus==="synced"&&t?.roomMappings&&t.roomMappings.length>0});syncPropertyForm;availabilityForm;isSyncingStore=this.channexService.isSyncingStore;isPushingAvailability=this.channexService.isPushingAvailability;constructor(){this.syncPropertyForm=this.fb.group({propertyType:[this.propertyType()||"hotel",M.required],checkInTime:["15:00",M.required],checkOutTime:["11:00",M.required]});let t=new Date,e=new Date;e.setFullYear(t.getFullYear()+1),this.availabilityForm=this.fb.group({startDate:[t,M.required],endDate:[e,M.required]})}ngOnInit(){this.restoreCachedState(),this.loadChannexStatus(),this.loadRoomTypes()}onStepSelectionChange(t){let e=t?.selectedIndex??0;if(this.setCurrentStep(e),e===3){let n=this.channexStatus()?.channex?.connectedChannels;n&&n.length>0&&!this.channelIframeUrl()&&this.connectChannels()}}loadChannexStatus(){let t=this.storeId();t&&(this.isLoadingStatus.set(!0),this.channexService.getStoreStatus(t).subscribe({next:e=>{this.channexStatus.set(e.data);try{localStorage.setItem(`channexStatus:${t}`,JSON.stringify(e.data))}catch{}this.updateStepsBasedOnStatus(e.data);try{let n=this.currentStep(),s=e.data.channex?.connectedChannels;n===3&&s&&s.length>0&&!this.channelIframeUrl()&&this.connectChannels()}catch{}this.isLoadingStatus.set(!1)},error:e=>{console.error("Failed to load Channex status:",e),this.isLoadingStatus.set(!1),this.showError("Failed to load channel management status")}}))}loadRoomTypes(){let t=this.storeId();t&&this.roomsService.getRoomTypes(t).subscribe({next:e=>{this.roomTypes.set(e)},error:e=>{console.error("Failed to load room types:",e)}})}updateStepsBasedOnStatus(t){let e=this.setupSteps();t.channex?.syncStatus==="synced"?(e[0].status="completed",this.setCurrentStepIfHigher(1)):t.channex?.syncStatus==="error"&&(e[0].status="error",e[0].errorMessage="Sync failed. Please try again."),t.roomMappings&&t.roomMappings.length>0&&(e[1].status="completed",this.setCurrentStepIfHigher(2)),t.roomMappings&&t.roomMappings.length>0&&(e[2].status="completed",this.setCurrentStepIfHigher(3)),this.setupSteps.set([...e])}setCurrentStep(t){this.currentStep.set(t);try{let e=this.storeId();e&&localStorage.setItem(`channelStepper:${e}`,String(t))}catch{}}setCurrentStepIfHigher(t){let e=this.currentStep();t>e&&this.setCurrentStep(t)}restoreCachedState(){let t=this.storeId();if(t)try{let e=localStorage.getItem(`channexStatus:${t}`);if(e){let s=JSON.parse(e);this.channexStatus.set(s),this.updateStepsBasedOnStatus(s)}let n=localStorage.getItem(`channelStepper:${t}`);if(n!==null){let s=Number(n);isNaN(s)||this.setCurrentStep(s)}}catch{}}syncStore(){let t=this.storeId();if(!t||this.syncPropertyForm.invalid)return;if(!this.isHotelProperty()){this.showError("Please set a valid property type (hotel, resort, etc.) to sync with Channex.");return}this.updateStepStatus(0,"in-progress");let e=this.syncPropertyForm.value;this.channexService.syncStoreToChannex(t,e).subscribe({next:n=>{this.updateStepStatus(0,"completed");let s={propertyType:e.propertyType,hotelSettings:A(P({},this.selectedStore()?.hotelSettings||{}),{operationalSettings:A(P({},this.selectedStore()?.hotelSettings?.operationalSettings||{}),{checkInTime:e.checkInTime,checkOutTime:e.checkOutTime})}),channex:{propertyId:n?.store?.channexPropertyId||this.channexStatus()?.channex?.propertyId,syncStatus:"synced",lastSyncAt:new Date().toISOString()}};try{this.storeStore.updateStore$(s)}catch(c){console.error("Failed to invoke store update:",c)}this.setCurrentStep(1),this.showSuccess(n.message),this.loadChannexStatus()},error:n=>{this.updateStepStatus(0,"error",n.error?.message||"Failed to sync property"),this.showError(n.error?.message||"Failed to sync property to Channex")}})}syncRoomType(t,e){let n=this.storeId();n&&this.channexService.syncRoomTypeToChannex(n,t,{}).subscribe({next:s=>{this.showSuccess(`${e} synced successfully`),this.loadChannexStatus()},error:s=>{this.showError(s.error?.message||`Failed to sync ${e}`)}})}syncAllRoomTypes(){let t=this.storeId(),e=this.roomTypes();if(!t||e.length===0)return;this.updateStepStatus(1,"in-progress");let n=0,s=0;e.forEach(c=>{this.channexService.syncRoomTypeToChannex(t,c._id||c.id||"",{}).subscribe({next:()=>{n++,n+s===e.length&&this.handleAllRoomTypesSynced(n,s)},error:()=>{s++,n+s===e.length&&this.handleAllRoomTypesSynced(n,s)}})})}handleAllRoomTypesSynced(t,e){e===0?(this.updateStepStatus(1,"completed"),this.setCurrentStep(2),this.showSuccess(`All ${t} room types synced successfully`)):(this.updateStepStatus(1,"error",`${e} room types failed to sync`),this.showError(`${t} synced, ${e} failed`)),this.loadChannexStatus()}pushAvailability(){let t=this.storeId();if(!t||this.availabilityForm.invalid)return;this.updateStepStatus(2,"in-progress");let e=this.availabilityForm.value.startDate,n=this.availabilityForm.value.endDate,s={startDate:e.toISOString().split("T")[0],endDate:n.toISOString().split("T")[0]};this.channexService.pushAvailability(t,s).subscribe({next:c=>{this.updateStepStatus(2,"completed"),this.setCurrentStep(3),this.showSuccess(c.message)},error:c=>{this.updateStepStatus(2,"error",c.error?.message||"Failed to push availability"),this.showError(c.error?.message||"Failed to push availability")}})}connectChannels(){let t=this.storeId();t&&(this.isLoadingIframe.set(!0),this.updateStepStatus(3,"in-progress"),this.channexService.getChannelConnectionKey(t).subscribe({next:e=>{console.log(e.data.iframeUrl),this.channelIframeUrl.set(e.data.iframeUrl),this.isLoadingIframe.set(!1),this.showSuccess("Channel connection interface loaded")},error:e=>{this.isLoadingIframe.set(!1),this.updateStepStatus(3,"error",e.error?.message||"Failed to load channel connection"),this.showError(e.error?.message||"Failed to load channel connection")}}))}onIframeLoad(){window.addEventListener("message",t=>{if(!t.origin.includes("channex.io"))return;let e=t.data;e.type==="channel_connected"?this.handleChannelConnected(e):e.type==="channel_disconnected"?this.handleChannelDisconnected(e):e.type==="iframe_ready"&&console.log("Channex iframe ready")})}handleChannelConnected(t){this.showSuccess(`${t.channelName||"Channel"} connected successfully`),this.loadChannexStatus()}handleChannelDisconnected(t){this.showSuccess(`${t.channelName||"Channel"} disconnected`),this.loadChannexStatus()}closeIframe(){this.channelIframeUrl.set(null),this.loadChannexStatus()}isRoomTypeSyncing(t){return this.channexService.isRoomTypeSyncing(t)}isRoomTypeSynced(t){let e=this.channexStatus();return e?.roomMappings?e.roomMappings.some(n=>n.roomType._id===t):!1}updateStepStatus(t,e,n){let s=this.setupSteps();s[t].status=e,n&&(s[t].errorMessage=n),this.setupSteps.set([...s])}showSuccess(t){this.snackBar.open(t,"Close",{duration:5e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["success-snackbar"]})}showError(t){this.snackBar.open(t,"Close",{duration:7e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["error-snackbar"]})}getStepIcon(t){switch(t.status){case"completed":return"check_circle";case"in-progress":return"sync";case"error":return"error";default:return t.icon}}getStepIconColor(t){switch(t.status){case"completed":return"text-green-600";case"in-progress":return"text-blue-600 animate-spin";case"error":return"text-red-600";default:return"text-gray-400"}}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=q({type:o,selectors:[["app-channel-management-mapping"]],features:[j([Z()])],decls:4,vars:1,consts:[["startPicker",""],["endPicker",""],[1,"max-w-12xl"],["title","Channel Management","subtitle","Connect Chicken Republic to distribution channels and start receiving bookings from OTAs",1,"mb-8"],[1,"flex","items-center","justify-center","py-20"],["diameter","50"],["appearance","outlined"],["appearance","outlined",1,"mb-3"],[1,"mb-8",3,"selectionChange","linear","selectedIndex"],[3,"completed"],["matStepLabel",""],["appearance","outlined",1,"my-4"],[1,"space-y-3"],[1,"my-4","space-y-4",3,"formGroup"],[1,"text-center","py-8","text-gray-500"],[3,"optional"],[1,"space-y-4",3,"formGroup"],[1,"text-sm","text-gray-600","mb-4"],["appearance","outline",1,"w-full"],["matInput","","formControlName","startDate",3,"matDatepicker"],["matIconSuffix","",3,"for"],["matInput","","formControlName","endDate",3,"matDatepicker"],[1,"bg-blue-50","p-4","rounded-lg","mb-4"],[1,"flex","items-start","gap-2"],[1,"text-blue-600","text-base","mt-0.5"],[1,"text-sm","text-blue-900"],["matButton","filled","color","primary",3,"click","disabled"],[1,"space-y-4"],[1,"relative"],["appearance","outlined",1,"mt-8"],[1,"flex","items-center","gap-4","py-4"],[1,"text-red-600","text-4xl"],[1,"flex-1"],[1,"text-lg","font-semibold","text-red-900"],[1,"text-red-700","mb-2"],[1,"text-sm","text-red-600"],[1,"text-lg","font-semibold","text-green-900"],[1,"text-green-700"],[1,"text-lg","font-semibold"],[1,"flex","justify-between","items-center","text-sm"],[1,"text-gray-600"],[1,"font-mono","text-gray-900"],[1,"text-gray-900"],["formControlName","propertyType"],["value","hotel"],["value","hostel"],["value","apartment"],["value","guesthouse"],["value","resort"],["value","motel"],["value","villa"],["value","boutique_hotel"],["value","bed_and_breakfast"],["value","lodge"],[1,"grid","grid-cols-2","gap-4"],["matInput","","type","time","formControlName","checkInTime"],["matInput","","type","time","formControlName","checkOutTime"],["matButton","filled","color","primary",3,"click","disabled","matTooltip"],[1,"text-4xl","mb-2"],[1,"mb-4"],["matButton","filled","color","primary",3,"click"],[1,"my-4"],[1,"max-h-96","overflow-y-auto"],["matListItemIcon","",1,"text-gray-600"],["matListItemTitle","",1,"truncate","font-medium","text-gray-900"],["matListItemLine","",1,"text-sm","text-gray-500"],["matListItemMeta","",1,"ml-auto","flex","items-center","gap-2"],["color","primary","selected",""],["diameter","24"],["matButton","outlined","color","primary"],["matButton","outlined","color","primary",3,"click"],[1,"font-medium","mb-1"],[1,"font-semibold","text-gray-900","mb-3"],[1,"space-y-2"],[1,"flex","items-center","justify-between","p-3","bg-green-50","rounded-lg","border","border-green-200"],[1,"flex","items-center","gap-3"],[1,"text-green-600"],[1,"font-medium","text-gray-900"],[1,"text-sm","text-gray-500"],[1,"bg-green-100","text-green-800"],[1,"flex","justify-between","items-center","mb-3"],[1,"font-semibold","text-gray-900"],["matButton","","matTooltip","Close",3,"click"],[1,"border","border-gray-300","rounded-lg","overflow-hidden","bg-white","shadow-sm"],["sandbox","allow-same-origin allow-scripts allow-forms allow-popups",1,"w-full","h-[600px]","border-0",3,"load","src"],[1,"mt-3","text-sm","text-gray-500","text-center"],[1,"text-base","align-middle","mr-1"],[1,"text-xl","font-semibold"],[1,"pt-6"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-6"],[1,"p-4","rounded-lg"],[1,"text-sm","text-gray-600","mb-1"],[1,"text-lg","font-semibold","text-gray-900"]],template:function(e,n){e&1&&(i(0,"div",2),C(1,"app-page-header",3),h(2,ot,2,0,"div",4)(3,Et,54,19),a()),e&2&&(l(2),g(n.isLoadingStatus()?2:3))},dependencies:[Y,_e,xe,he,ge,ye,Ce,Se,te,ee,se,re,de,le,pe,me,ce,ke,Ee,Ze,Xe,Le,$e,ie,Fe,Ae,Pe,Ne,ue,Qe,je,Te,Me,ve,be,Re,Ie,De,we,X,Je,Ge,Ke,Ye,We,ze,He,qe,Be,Ue,Oe,Ve,K,D],styles:["[_nghost-%COMP%]{display:block}"],changeDetection:0})};export{nt as ChannelManagementMapping};
