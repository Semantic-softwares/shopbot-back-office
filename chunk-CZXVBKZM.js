import{a as S}from"./chunk-OC53S64Y.js";import{a as m}from"./chunk-LJSEVW7O.js";import{B as d}from"./chunk-DWCYWQVU.js";import{E as i,W as b,aa as v,fa as g,h as u,n as l,s as o,y as h}from"./chunk-5AECHVKR.js";var j=class c{http=g(d);roomsService=g(S);baseUrl=`${m.apiUrl}/reservations`;reservationsSubject=new u([]);reservations$=this.reservationsSubject.asObservable();loadingSubject=new u(!1);loading$=this.loadingSubject.asObservable();errorSubject=new u(null);error$=this.errorSubject.asObservable();getReservations(r){this.loadingSubject.next(!0),this.errorSubject.next(null);let e=new URLSearchParams;r&&Object.entries(r).forEach(([s,n])=>{n!=null&&e.append(s,n.toString())});let t=`${this.baseUrl}?${e.toString()}`;return console.log("Fetching reservations from:",t),console.log("Query params object:",r),this.http.get(t).pipe(o(s=>{if(console.log("Raw API response:",s),Array.isArray(s)){let n={reservations:s,total:s.length};return this.reservationsSubject.next(s),this.loadingSubject.next(!1),n}else return this.reservationsSubject.next(s.reservations||[]),this.loadingSubject.next(!1),s}),i(s=>(console.error("Error fetching reservations:",s),this.errorSubject.next("Failed to load reservations"),this.loadingSubject.next(!1),l({reservations:[],total:0}))))}getReservationById(r){return this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.get(`${this.baseUrl}/${r}`).pipe(o(e=>(this.loadingSubject.next(!1),e)),i(e=>(console.error("Error fetching reservation:",e),this.errorSubject.next("Failed to load reservation"),this.loadingSubject.next(!1),l(null))))}createReservation(r){return this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.post(this.baseUrl,r).pipe(o(e=>{this.loadingSubject.next(!1);let t=this.reservationsSubject.value;return this.reservationsSubject.next([e,...t]),e}),i(e=>{throw console.error("Error creating reservation:",e),this.errorSubject.next("Failed to create reservation"),this.loadingSubject.next(!1),e}))}updateReservation(r,e){return this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.put(`${this.baseUrl}/${r}`,e).pipe(o(t=>{this.loadingSubject.next(!1);let n=this.reservationsSubject.value.map(a=>a._id===r?t:a);return this.reservationsSubject.next(n),t}),i(t=>{throw console.error("Error updating reservation:",t),this.errorSubject.next("Failed to update reservation"),this.loadingSubject.next(!1),t}))}deleteReservation(r){return this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.delete(`${this.baseUrl}/${r}`).pipe(o(()=>{this.loadingSubject.next(!1);let t=this.reservationsSubject.value.filter(s=>s._id!==r);return this.reservationsSubject.next(t),!0}),i(e=>(console.error("Error deleting reservation:",e),this.errorSubject.next("Failed to delete reservation"),this.loadingSubject.next(!1),l(!1))))}checkInReservation(r){return this.updateReservation(r,{status:"checked_in",actualCheckInDate:new Date})}checkOutReservation(r){return this.updateReservation(r,{status:"checked_out",actualCheckOutDate:new Date})}cancelReservation(r,e){return this.updateReservation(r,{status:"cancelled",cancellation:{isCancelled:!0,cancelledAt:new Date,reason:e}})}updateReservationStatus(r,e){let t={status:e};return e==="checked_in"?t.actualCheckInDate=new Date:e==="checked_out"&&(t.actualCheckOutDate=new Date),this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.put(`${this.baseUrl}/${r}`,t).pipe(o(s=>{this.loadingSubject.next(!1);let a=this.reservationsSubject.value.map(p=>p._id===r?s:p);return this.reservationsSubject.next(a),s}),i(s=>{console.error("Error updating reservation status:",s),this.loadingSubject.next(!1);let n="Failed to update reservation status";throw s.error?.error?n=s.error.error:s.message&&(n=s.message),this.errorSubject.next(n),new Error(n)}))}getReservationsForCalendar(r,e,t){return this.getReservations({storeId:t,dateFrom:r.toISOString().split("T")[0],dateTo:e.toISOString().split("T")[0]}).pipe(o(s=>s.reservations))}clearError(){this.errorSubject.next(null)}getFrontDeskOverview(r){return this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.get(`${this.baseUrl}/front-desk/overview/${r}`).pipe(o(e=>(this.loadingSubject.next(!1),e)),i(e=>{this.loadingSubject.next(!1);let t="Failed to fetch front desk overview";throw e.error?.error?t=e.error.error:e.message&&(t=e.message),this.errorSubject.next(t),new Error(t)}))}getTodaysCheckIns(r){return this.http.get(`${this.baseUrl}/front-desk/check-in-today/${r}`).pipe(o(e=>e.arrivals),i(e=>(this.errorSubject.next("Failed to fetch today's check-ins"),l([]))))}getTodaysCheckOuts(r){return this.http.get(`${this.baseUrl}/front-desk/check-out-today/${r}`).pipe(o(e=>e.departures),i(e=>(this.errorSubject.next("Failed to fetch today's check-outs"),l([]))))}getInHouseGuests(r){return this.http.get(`${this.baseUrl}/front-desk/in-house/${r}`).pipe(o(e=>e.inHouseGuests),i(e=>(this.errorSubject.next("Failed to fetch in-house guests"),l([]))))}checkInReservationWithRooms(r,e){return this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.put(`${this.baseUrl}/${r}/check-in-with-rooms`,e||{}).pipe(b(t=>{let s=t.rooms.map(n=>{let a=typeof n.room=="string"?n.room:n.room._id;return this.roomsService.getRoom(a)});return h(s).pipe(o(()=>(this.loadingSubject.next(!1),t)))}),i(t=>{this.loadingSubject.next(!1);let s="Failed to check in guest";throw t.error?.error?s=t.error.error:t.message&&(s=t.message),this.errorSubject.next(s),new Error(s)}))}checkOutReservationWithRooms(r,e){return this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.put(`${this.baseUrl}/${r}/check-out-with-rooms`,e||{}).pipe(b(t=>{let s=t.rooms.map(n=>{let a=typeof n.room=="string"?n.room:n.room._id;return this.roomsService.getRoom(a)});return h(s).pipe(o(()=>(this.loadingSubject.next(!1),t)))}),i(t=>{this.loadingSubject.next(!1);let s="Failed to check out guest";throw t.error?.error?s=t.error.error:t.message&&(s=t.message),this.errorSubject.next(s),new Error(s)}))}requestEarlyCheckIn(r,e,t){return this.http.post(`${this.baseUrl}/${r}/early-checkin-request`,{requestedTime:e,notes:t}).pipe(i(s=>{throw this.errorSubject.next("Failed to request early check-in"),s}))}requestLateCheckOut(r,e,t){return this.http.post(`${this.baseUrl}/${r}/late-checkout-request`,{requestedTime:e,notes:t}).pipe(i(s=>{throw this.errorSubject.next("Failed to request late check-out"),s}))}changeRoomAssignment(r,e,t,s){return this.http.put(`${this.baseUrl}/${r}/change-room`,{oldRoomId:e,newRoomId:t,reason:s}).pipe(i(n=>{throw this.errorSubject.next("Failed to change room assignment"),n}))}addInternalNotes(r,e){return this.http.patch(`${this.baseUrl}/${r}/notes`,{internalNotes:e}).pipe(i(t=>{throw this.errorSubject.next("Failed to add notes"),t}))}extendStay(r,e,t){return this.http.put(`${this.baseUrl}/${r}/extend-stay`,{newCheckOutDate:e.toISOString(),additionalNights:t}).pipe(i(s=>{throw this.errorSubject.next("Failed to extend stay"),s}))}processPayment(r,e){return this.http.post(`${this.baseUrl}/${r}/payment`,e).pipe(i(t=>{throw this.errorSubject.next("Failed to process payment"),t}))}printFolio(r){return this.http.get(`${this.baseUrl}/${r}/folio`,{responseType:"blob"}).pipe(i(e=>{throw this.errorSubject.next("Failed to generate folio"),e}))}requestHousekeeping(r,e){return this.http.post(`${this.baseUrl}/${r}/housekeeping-request`,e).pipe(i(t=>{throw this.errorSubject.next("Failed to request housekeeping"),t}))}sendReservationEmail(r,e){return this.http.post(`${this.baseUrl}/${r}/send-email`,e).pipe(i(t=>{console.error("Error sending reservation email:",t);let s="Failed to send reservation email";throw t.error?.error?s=t.error.error:t.error?.details?s=t.error.details:t.message&&(s=t.message),this.errorSubject.next(s),new Error(s)}))}exportReservationToPDF(r){return this.loadingSubject.next(!0),this.errorSubject.next(null),this.http.get(`${this.baseUrl}/${r}/export/pdf`,{responseType:"blob"}).pipe(o(e=>(this.loadingSubject.next(!1),e)),i(e=>{this.loadingSubject.next(!1);let t="Failed to export reservation to PDF. Please try again.";throw e.error?.message?t=e.error.message:e.error?.error?t=e.error.error:e.error?.details?t=e.error.details:e.message&&(t=e.message),this.errorSubject.next(t),console.error("Error exporting reservation to PDF:",e),new Error(t)}))}static \u0275fac=function(e){return new(e||c)};static \u0275prov=v({token:c,factory:c.\u0275fac,providedIn:"root"})};export{j as a};
