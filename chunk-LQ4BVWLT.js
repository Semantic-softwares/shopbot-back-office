import{a as d}from"./chunk-VPPMXXDW.js";import{a,b as h}from"./chunk-NQRUH5DO.js";import{w as p,x as g}from"./chunk-U2P6GFP5.js";import{$ as b,X as o,ea as l,va as S}from"./chunk-IQSYHSID.js";var m=class u{http=l(g);storeStore=l(d);sessionStorage=l(h);apiUrl=`${a.apiUrl}/api/v1/subscription`;subscriptionSignal=S(this.loadCachedSubscription());constructor(){}loadCachedSubscription(){let t=this.sessionStorage.getItem("currentSubscription");if(!t)return null;try{return typeof t=="string"?JSON.parse(t):t}catch(e){return console.error("Failed to parse cached subscription:",e),null}}cacheSubscription(t){t?this.sessionStorage.setItem("currentSubscription",t):this.sessionStorage.removeItem("currentSubscription")}getSubscriptionSignal(){return this.subscriptionSignal}getSubscriptionStatus(){let e=this.storeStore.selectedStore()?._id,r=new p;return e&&(r=r.set("storeId",e)),this.http.get(`${this.apiUrl}/status`,{params:r}).pipe(o(i=>{this.subscriptionSignal.set(i),this.cacheSubscription(i)}))}getCachedSubscription(){return this.subscriptionSignal()}createTrial(){let t=this.storeStore.selectedStore(),e=t?._id,r="";return t?.owner&&(typeof t.owner=="object"&&t.owner.email?r=t.owner.email:t?.contactInfo?.email&&(r=t.contactInfo.email)),this.http.post(`${this.apiUrl}/trial`,{storeId:e,billingEmail:r,billingCountry:t?.contactInfo.country}).pipe(o(i=>{this.subscriptionSignal.set(i),this.cacheSubscription(i)}))}initiateUpgradePayment(t,e,r){let s=this.storeStore.selectedStore()?._id,n=e||a.paymentReturnUrl,c={roomCount:t,storeId:s,callbackUrl:n};return r?c.webhookUrl=r:a.webhookUrl&&(c.webhookUrl=a.webhookUrl),this.http.post(`${this.apiUrl}/upgrade/initiate`,c)}verifyUpgradePayment(t,e,r){let i={paystackReference:t,roomCount:e};return r&&(i.storeId=r),this.http.post(`${this.apiUrl}/upgrade/verify`,i).pipe(o(s=>{this.subscriptionSignal.set(s),this.cacheSubscription(s)}))}getInvoices(t,e=12,r=0){let i=this.storeStore.selectedStore(),s=t||i?._id,n=new p;return s&&(n=n.set("storeId",s)),n=n.set("limit",e.toString()),n=n.set("skip",r.toString()),this.http.get(`${this.apiUrl}/invoices`,{params:n})}downloadInvoicePdf(t){return this.http.get(`${this.apiUrl}/invoices/${t}/pdf`,{responseType:"blob"})}cancelSubscription(t){let r=this.storeStore.selectedStore()?._id;return this.http.post(`${this.apiUrl}/cancel`,{reason:t,storeId:r}).pipe(o(i=>{this.subscriptionSignal.set(i),this.cacheSubscription(i)}))}isInTrial(t){return t.status==="TRIAL"}isActive(t){return t.status==="ACTIVE"}isPastDue(t){return t.status==="PAST_DUE"}isExpired(t){return t.status==="EXPIRED"}getTrialDaysRemaining(t){if(!this.isInTrial(t))return 0;let e=new Date(t.trialEndDate),r=new Date,i=Math.ceil((e.getTime()-r.getTime())/(1e3*60*60*24));return Math.max(0,i)}getTrialProgress(t){if(!this.isInTrial(t))return 0;let e=new Date(t.trialStartDate),r=new Date(t.trialEndDate),i=new Date,s=(r.getTime()-e.getTime())/(1e3*60*60*24),n=(i.getTime()-e.getTime())/(1e3*60*60*24);return Math.min(100,Math.round(n/s*100))}needsUpgrade(t){return this.isExpired(t)}hasPaymentMethod(t){return t.hasPaymentMethod}getStatusLabel(t){return{TRIAL:"Free Trial",ACTIVE:"Active",PAST_DUE:"Payment Required",EXPIRED:"Expired",CANCELLED:"Cancelled"}[t.status]}getStatusColor(t){return{TRIAL:"warn",ACTIVE:"accent",PAST_DUE:"error",EXPIRED:"error",CANCELLED:"error"}[t.status]}formatForDisplay(t){return{status:this.getStatusLabel(t),statusColor:this.getStatusColor(t),trialDaysRemaining:this.getTrialDaysRemaining(t),trialProgress:this.getTrialProgress(t),hasPaymentMethod:this.hasPaymentMethod(t),nextBillingDate:t.nextBillingDate?new Date(t.nextBillingDate).toLocaleDateString():null,isUpgradeRequired:this.needsUpgrade(t)}}refreshSubscription(){return this.getSubscriptionStatus()}getPricingPlans(){return this.http.get(`${this.apiUrl}/pricing`)}getRoomCountFromRange(t){return t.includes("0-10")?10:t.includes("11-30")?30:t.includes("31-35")?35:t.includes("35+")?50:10}isCurrentSubscriptionPlan(t,e){if(!t)return!1;if(t.status==="TRIAL")return e==="0-10 rooms";if(t.status==="ACTIVE"){let r=t.roomCount||10;if(e==="0-10 rooms"&&r<=10||e==="11-30 rooms"&&r>10&&r<=30||e==="31-35 rooms"&&r>30&&r<=35||e==="35+ rooms"&&r>35)return!0}return!1}isDowngrade(t,e){if(!t||!t.roomCount)return!1;let r=t.roomCount;return this.getRoomCountFromRange(e)<r}getPlanActionLabel(t,e){return this.isCurrentSubscriptionPlan(t,e)?"Current Plan":this.isDowngrade(t,e)?"Downgrade":"Upgrade Now"}isPlanButtonDisabled(t,e){return this.isCurrentSubscriptionPlan(t,e)}static \u0275fac=function(e){return new(e||u)};static \u0275prov=b({token:u,factory:u.\u0275fac,providedIn:"root"})};export{m as a};
